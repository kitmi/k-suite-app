"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  Promise
} = Util;

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }, {
            "type": "file",
            "options": {
              "level": "info",
              "filename": `${name && _.kebabCase(name) || 'app'}.log`
            }
          }],
          ...(options && options.logger)
        },
        ..._.omit(options, ['logger'])
      });

      this._onUncaughtException = err => {
        this.log('error', err, () => {
          process.exit(1);
        });
      };

      this._onWarning = warning => {
        this.log('warn', warning);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_();
        }
      };
    }

    async start_() {
      this._initialize();

      return super.start_();
    }

    async stop_() {
      await super.stop_();
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          this._uninitialize();

          resolve(this);
        }, 0);
      });
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();

      process.on('exit', this._onExit);
    }

    _uninitialize() {
      process.removeListener('exit', this._onExit);
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (this._externalLogger) {
          delete this._externalLogger;
        } else {
          this.logger.close();
        }

        delete this.logger;
        return;
      }

      let loggerOpt = this.options.logger;

      if (loggerOpt instanceof Logger) {
        this.logger = loggerOpt;
        this._externalLogger = true;
      } else {
        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        this.log('verbose', 'Process-wide error handlers are detaching ...');
        process.removeListener('warning', this._onWarning);
        process.removeListener('uncaughtException', this._onUncaughtException);
        return;
      }

      process.on('uncaughtException', this._onUncaughtException);
      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsIlByb21pc2UiLCJ3aW5zdG9uIiwid2luc3RvbkZsaWdodCIsIkxvZ2dlciIsIlJ1bmFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ2dlciIsImZvcm1hdCIsImNvbWJpbmUiLCJjb2xvcml6ZSIsInNpbXBsZSIsImtlYmFiQ2FzZSIsIm9taXQiLCJfb25VbmNhdWdodEV4Y2VwdGlvbiIsImVyciIsImxvZyIsInByb2Nlc3MiLCJleGl0IiwiX29uV2FybmluZyIsIndhcm5pbmciLCJfb25FeGl0IiwiY29kZSIsInN0YXJ0ZWQiLCJzdG9wXyIsInN0YXJ0XyIsIl9pbml0aWFsaXplIiwicmVzb2x2ZSIsInJlamVjdCIsInNldFRpbWVvdXQiLCJfdW5pbml0aWFsaXplIiwiX3B3ZCIsImN3ZCIsIndvcmtpbmdQYXRoIiwiY2hkaXIiLCJfaW5qZWN0TG9nZ2VyIiwiX2luamVjdEVycm9ySGFuZGxlcnMiLCJvbiIsInJlbW92ZUxpc3RlbmVyIiwiZGV0YWNoIiwiX2V4dGVybmFsTG9nZ2VyIiwiY2xvc2UiLCJsb2dnZXJPcHQiLCJ0cmFuc3BvcnRzIiwiY3JlYXRlTG9nZ2VyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQWlCSCxJQUF2Qjs7QUFFQSxNQUFNSSxPQUFPLEdBQUdILE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUNBLE1BQU1JLGFBQWEsR0FBR0osT0FBTyxDQUFDLGVBQUQsQ0FBN0I7O0FBQ0EsTUFBTUssTUFBTSxHQUFHTCxPQUFPLENBQUMsNEJBQUQsQ0FBdEI7O0FBUUEsTUFBTU0sT0FBTyxHQUFHQyxDQUFDO0FBQUE7O0FBQUEsaUJB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QUFTLFNBQVQsRUFBb0IsdUNBQXBCO0FBQ0g7O0FBMUlnQyxHQUFwQjtBQUFBLENBQWpCOztBQTZJQTZCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjVDLE9BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBQcm9taXNlIH0gPSBVdGlsO1xuXG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xuY29uc3Qgd2luc3RvbkZsaWdodCA9IHJlcXVpcmUoJ3dpbnN0b25mbGlnaHQnKTtcbmNvbnN0IExvZ2dlciA9IHJlcXVpcmUoJ3dpbnN0b24vbGliL3dpbnN0b24vbG9nZ2VyJyk7XG5cbi8qKlxuICogUnVuYWJsZSBhcHAgbWl4aW4uIFxuICogQHBhcmFtIHtvYmplY3R9IFQgLSBCYXNlIGNsYXNzLiAgICAgXG4gKiBAcmV0dXJucyB7UnVuYWJsZX0gQSBydW5hYmxlIGFwcCBjbGFzcy5cbiAqIEBjb25zdHJ1Y3RzIFJ1bmFibGUoVClcbiAqL1xuY29uc3QgUnVuYWJsZSA9IFQgPT4gY2xhc3MgZXh0ZW5kcyBUIHtcbiAgICBfb25VbmNhdWdodEV4Y2VwdGlvbiA9IGVyciA9PiB7XG4gICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVyciwgKCkgPT4ge1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9KTtcbiAgICB9OyAgICAgICAgXG5cbiAgICBfb25XYXJuaW5nID0gd2FybmluZyA9PiB7XG4gICAgICAgIHRoaXMubG9nKCd3YXJuJywgd2FybmluZyk7ICAgXG4gICAgfTtcblxuICAgIF9vbkV4aXQgPSBjb2RlID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc3RhcnRlZCkge1xuICAgICAgICAgICAgdGhpcy5zdG9wXygpO1xuICAgICAgICB9ICAgICAgICAgICBcbiAgICB9O1xuXG4gICAgLyoqICAgICAgICAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBhcHBsaWNhdGlvbi4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBBcHBsaWNhdGlvbiBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMubG9nZ2VyXSAtIExvZ2dlciBvcHRpb25zICAgIFxuICAgICAqIEBjb25zdHJ1Y3RzIFJ1bmFibGVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKG5hbWUsIHtcbiAgICAgICAgICAgIGxvZ2dlcjoge1xuICAgICAgICAgICAgICAgIFwibGV2ZWxcIjogXCJpbmZvXCIsXG4gICAgICAgICAgICAgICAgXCJ0cmFuc3BvcnRzXCI6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwiY29uc29sZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJmb3JtYXRcIjogd2luc3Rvbi5mb3JtYXQuY29tYmluZSh3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLCB3aW5zdG9uLmZvcm1hdC5zaW1wbGUoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwiZmlsZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImxldmVsXCI6IFwiaW5mb1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZmlsZW5hbWVcIjogYCR7bmFtZSAmJiBfLmtlYmFiQ2FzZShuYW1lKSB8fCAnYXBwJ30ubG9nYFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAuLi4ob3B0aW9ucyAmJiBvcHRpb25zLmxvZ2dlcilcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAuLi5fLm9taXQob3B0aW9ucywgWydsb2dnZXInXSlcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCB0aGUgYXBwICAgICBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKiBAbWVtYmVyb2YgUnVuYWJsZVxuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0XygpIHsgICAgICAgIFxuICAgICAgICB0aGlzLl9pbml0aWFsaXplKCk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gc3VwZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCB0aGUgYXBwXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICogQG1lbWJlcm9mIFJ1bmFibGVcbiAgICAgKi9cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgYXdhaXQgc3VwZXIuc3RvcF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgLy9kZWZlcnJlZCBleGVjdXRpb25cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX3VuaW5pdGlhbGl6ZSgpO1xuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzKTtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgdGhpcy5fcHdkID0gcHJvY2Vzcy5jd2QoKTtcbiAgICAgICAgaWYgKHRoaXMud29ya2luZ1BhdGggIT09IHRoaXMuX3B3ZCkgeyAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHByb2Nlc3MuY2hkaXIodGhpcy53b3JraW5nUGF0aCk7XG4gICAgICAgIH0gICAgICBcblxuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIoKTtcbiAgICAgICAgdGhpcy5faW5qZWN0RXJyb3JIYW5kbGVycygpOyBcblxuICAgICAgICBwcm9jZXNzLm9uKCdleGl0JywgdGhpcy5fb25FeGl0KTtcbiAgICB9XG5cbiAgICBfdW5pbml0aWFsaXplKCkge1xuICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCdleGl0JywgdGhpcy5fb25FeGl0KTtcblxuICAgICAgICBjb25zdCBkZXRhY2ggPSB0cnVlO1xuICAgICAgICB0aGlzLl9pbmplY3RFcnJvckhhbmRsZXJzKGRldGFjaCk7ICAgICAgIFxuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIoZGV0YWNoKTsgICAgICAgICBcblxuICAgICAgICBwcm9jZXNzLmNoZGlyKHRoaXMuX3B3ZCk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9wd2Q7XG4gICAgfVxuXG4gICAgX2luamVjdExvZ2dlcihkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnTG9nZ2VyIGlzIGRldGFjaGluZyAuLi4nKTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9leHRlcm5hbExvZ2dlcikge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9leHRlcm5hbExvZ2dlcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxvZ2dlcjtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsb2dnZXJPcHQgPSB0aGlzLm9wdGlvbnMubG9nZ2VyO1xuXG4gICAgICAgIGlmIChsb2dnZXJPcHQgaW5zdGFuY2VvZiBMb2dnZXIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyT3B0O1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGxvZ2dlck9wdC50cmFuc3BvcnRzKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyT3B0LnRyYW5zcG9ydHMgPSB3aW5zdG9uRmxpZ2h0KHdpbnN0b24sIGxvZ2dlck9wdC50cmFuc3BvcnRzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcihsb2dnZXJPcHQpOyAgIFxuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0xvZ2dlciBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG5cbiAgICBfaW5qZWN0RXJyb3JIYW5kbGVycyhkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnUHJvY2Vzcy13aWRlIGVycm9yIGhhbmRsZXJzIGFyZSBkZXRhY2hpbmcgLi4uJyk7XG4gICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCd3YXJuaW5nJywgdGhpcy5fb25XYXJuaW5nKTtcbiAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ3VuY2F1Z2h0RXhjZXB0aW9uJywgdGhpcy5fb25VbmNhdWdodEV4Y2VwdGlvbik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pOyBcbiAgICAgICAgcHJvY2Vzcy5vbignd2FybmluZycsIHRoaXMuX29uV2FybmluZyk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ1Byb2Nlc3Mtd2lkZSBlcnJvciBoYW5kbGVycyBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJ1bmFibGU7Il19