"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  Promise
} = Util;

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "useMetaKey": "metadata",
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }],
          ...(options && options.logger)
        },
        ..._.omit(options, ['logger'])
      });

      this._onUncaughtException = err => {
        setTimeout(() => {
          process.exit(1);
        }, 1000);
        this.log('error', err, () => {
          process.exit(1);
        });
      };

      this._onWarning = warning => {
        this.log('warn', warning);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_().catch(this.logError);
        }
      };
    }

    async start_() {
      this._initialize();

      return super.start_();
    }

    async stop_() {
      await super.stop_();
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          this._uninitialize();

          resolve(this);
        }, 0);
      });
    }

    replaceLogger(logger) {
      this._injectLogger(true);

      this.logger = logger;
      this._externalLogger = true;
      this.log('verbose', 'A new logger attached.');
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();

      process.on('exit', this._onExit);
    }

    _uninitialize() {
      process.removeListener('exit', this._onExit);
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (this._externalLogger) {
          delete this._externalLogger;
        } else {
          this.logger.close();
        }

        delete this.logger;
        return;
      }

      let loggerOpt = this.options.logger;

      if (loggerOpt instanceof Logger) {
        this.logger = loggerOpt;
        this._externalLogger = true;
      } else {
        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        this.log('verbose', 'Process-wide error handlers are detaching ...');
        process.removeListener('warning', this._onWarning);
        process.removeListener('uncaughtException', this._onUncaughtException);
        return;
      }

      process.on('uncaughtException', this._onUncaughtException);
      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsIlByb21pc2UiLCJ3aW5zdG9uIiwid2luc3RvbkZsaWdodCIsIkxvZ2dlciIsIlJ1bmFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ2dlciIsImZvcm1hdCIsImNvbWJpbmUiLCJjb2xvcml6ZSIsInNpbXBsZSIsIm9taXQiLCJfb25VbmNhdWdodEV4Y2VwdGlvbiIsImVyciIsInNldFRpbWVvdXQiLCJwcm9jZXNzIiwiZXhpdCIsImxvZyIsIl9vbldhcm5pbmciLCJ3YXJuaW5nIiwiX29uRXhpdCIsImNvZGUiLCJzdGFydGVkIiwic3RvcF8iLCJjYXRjaCIsImxvZ0Vycm9yIiwic3RhcnRfIiwiX2luaXRpYWxpemUiLCJyZXNvbHZlIiwicmVqZWN0IiwiX3VuaW5pdGlhbGl6ZSIsInJlcGxhY2VMb2dnZXIiLCJfaW5qZWN0TG9nZ2VyIiwiX2V4dGVybmFsTG9nZ2VyIiwiX3B3ZCIsImN3ZCIsIndvcmtpbmdQYXRoIiwiY2hkaXIiLCJfaW5qZWN0RXJyb3JIYW5kbGVycyIsIm9uIiwicmVtb3ZlTGlzdGVuZXIiLCJkZXRhY2giLCJjbG9zZSIsImxvZ2dlck9wdCIsInRyYW5zcG9ydHMiLCJjcmVhdGVMb2dnZXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBaUJILElBQXZCOztBQUVBLE1BQU1JLE9BQU8sR0FBR0gsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsTUFBTUksYUFBYSxHQUFHSixPQUFPLENBQUMsZUFBRCxDQUE3Qjs7QUFDQSxNQUFNSyxNQUFNLEdBQUdMLE9BQU8sQ0FBQyw0QkFBRCxDQUF0Qjs7QUFRQSxNQUFNTSxPQUFPLEdB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QUFDeUIsY0FBUixDQUF1QixtQkFBdkIsRUFBNEMsS0FBSzVCLG9CQUFqRDtBQUNBO0FBQ0g7O0FBRURHLE1BQUFBLE9BQU8sQ0FBQ3dCLEVBQVIsQ0FBVyxtQkFBWCxFQUFnQyxLQUFLM0Isb0JBQXJDO0FBQ0FHLE1BQUFBLE9BQU8sQ0FBQ3dCLEVBQVIsQ0FBVyxTQUFYLEVBQXNCLEtBQUtyQixVQUEzQjtBQUNBLFdBQUtELEdBQUwsQ0FBUyxTQUFULEVBQW9CLHVDQUFwQjtBQUNIOztBQXJKZ0MsR0FBcEI7QUFBQSxDQUFqQjs7QUF3SkE2QixNQUFNLENBQUNDLE9BQVAsR0FBaUI5QyxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgUHJvbWlzZSB9ID0gVXRpbDtcblxuY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKTtcbmNvbnN0IHdpbnN0b25GbGlnaHQgPSByZXF1aXJlKCd3aW5zdG9uZmxpZ2h0Jyk7XG5jb25zdCBMb2dnZXIgPSByZXF1aXJlKCd3aW5zdG9uL2xpYi93aW5zdG9uL2xvZ2dlcicpO1xuXG4vKipcbiAqIFJ1bmFibGUgYXBwIG1peGluLiBcbiAqIEBwYXJhbSB7b2JqZWN0fSBUIC0gQmFzZSBjbGFzcy4gICAgIFxuICogQHJldHVybnMge1J1bmFibGV9IEEgcnVuYWJsZSBhcHAgY2xhc3MuXG4gKiBAY29uc3RydWN0cyBSdW5hYmxlKFQpXG4gKi9cbmNvbnN0IFJ1bmFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7XG4gICAgX29uVW5jYXVnaHRFeGNlcHRpb24gPSBlcnIgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSwgMTAwMCk7XG5cbiAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgZXJyLCAoKSA9PiB7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH0pO1xuICAgIH07ICAgICAgICBcblxuICAgIF9vbldhcm5pbmcgPSB3YXJuaW5nID0+IHtcbiAgICAgICAgdGhpcy5sb2coJ3dhcm4nLCB3YXJuaW5nKTsgICBcbiAgICB9O1xuXG4gICAgX29uRXhpdCA9IGNvZGUgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3BfKCkuY2F0Y2godGhpcy5sb2dFcnJvcik7XG4gICAgICAgIH0gICAgICAgICAgIFxuICAgIH07XG5cbiAgICAvKiogICAgICAgICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFwcGxpY2F0aW9uLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIEFwcGxpY2F0aW9uIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5sb2dnZXJdIC0gTG9nZ2VyIG9wdGlvbnMgICAgXG4gICAgICogQGNvbnN0cnVjdHMgUnVuYWJsZVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIobmFtZSwge1xuICAgICAgICAgICAgbG9nZ2VyOiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VNZXRhS2V5XCI6IFwibWV0YWRhdGFcIixcbiAgICAgICAgICAgICAgICBcImxldmVsXCI6IFwiaW5mb1wiLFxuICAgICAgICAgICAgICAgIFwidHJhbnNwb3J0c1wiOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidHlwZVwiOiBcImNvbnNvbGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwib3B0aW9uc1wiOiB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZm9ybWF0XCI6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUod2luc3Rvbi5mb3JtYXQuY29sb3JpemUoKSwgd2luc3Rvbi5mb3JtYXQuc2ltcGxlKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIC4uLihvcHRpb25zICYmIG9wdGlvbnMubG9nZ2VyKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC4uLl8ub21pdChvcHRpb25zLCBbJ2xvZ2dlciddKVxuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBhcHAgICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqIEBtZW1iZXJvZiBSdW5hYmxlXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKCkgeyAgICAgICAgXG4gICAgICAgIHRoaXMuX2luaXRpYWxpemUoKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBhcHBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKiBAbWVtYmVyb2YgUnVuYWJsZVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBhd2FpdCBzdXBlci5zdG9wXygpO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAvL2RlZmVycmVkIGV4ZWN1dGlvblxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdW5pbml0aWFsaXplKCk7XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMpO1xuICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgdGhlIGRlZmF1bHQgbG9nZ2VyIHNldCBvbiBjcmVhdGlvbiBvZiB0aGUgYXBwLlxuICAgICAqIEBwYXJhbSB7TG9nZ2VyfSBsb2dnZXIgXG4gICAgICovXG4gICAgcmVwbGFjZUxvZ2dlcihsb2dnZXIpIHtcbiAgICAgICAgdGhpcy5faW5qZWN0TG9nZ2VyKHRydWUgLyogZGV0YWN0ICovKTtcblxuICAgICAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0EgbmV3IGxvZ2dlciBhdHRhY2hlZC4nKTtcbiAgICB9XG5cbiAgICBfaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgdGhpcy5fcHdkID0gcHJvY2Vzcy5jd2QoKTtcbiAgICAgICAgaWYgKHRoaXMud29ya2luZ1BhdGggIT09IHRoaXMuX3B3ZCkgeyAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHByb2Nlc3MuY2hkaXIodGhpcy53b3JraW5nUGF0aCk7XG4gICAgICAgIH0gICAgICBcblxuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIoKTtcbiAgICAgICAgdGhpcy5faW5qZWN0RXJyb3JIYW5kbGVycygpOyBcblxuICAgICAgICBwcm9jZXNzLm9uKCdleGl0JywgdGhpcy5fb25FeGl0KTtcbiAgICB9XG5cbiAgICBfdW5pbml0aWFsaXplKCkge1xuICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCdleGl0JywgdGhpcy5fb25FeGl0KTtcblxuICAgICAgICBjb25zdCBkZXRhY2ggPSB0cnVlO1xuICAgICAgICB0aGlzLl9pbmplY3RFcnJvckhhbmRsZXJzKGRldGFjaCk7ICAgICAgIFxuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIoZGV0YWNoKTsgICAgICAgICBcblxuICAgICAgICBwcm9jZXNzLmNoZGlyKHRoaXMuX3B3ZCk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9wd2Q7XG4gICAgfVxuXG4gICAgX2luamVjdExvZ2dlcihkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnTG9nZ2VyIGlzIGRldGFjaGluZyAuLi4nKTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9leHRlcm5hbExvZ2dlcikge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9leHRlcm5hbExvZ2dlcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxvZ2dlcjtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsb2dnZXJPcHQgPSB0aGlzLm9wdGlvbnMubG9nZ2VyO1xuXG4gICAgICAgIGlmIChsb2dnZXJPcHQgaW5zdGFuY2VvZiBMb2dnZXIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyT3B0O1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGxvZ2dlck9wdC50cmFuc3BvcnRzKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyT3B0LnRyYW5zcG9ydHMgPSB3aW5zdG9uRmxpZ2h0KHdpbnN0b24sIGxvZ2dlck9wdC50cmFuc3BvcnRzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcihsb2dnZXJPcHQpOyAgIFxuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0xvZ2dlciBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG5cbiAgICBfaW5qZWN0RXJyb3JIYW5kbGVycyhkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnUHJvY2Vzcy13aWRlIGVycm9yIGhhbmRsZXJzIGFyZSBkZXRhY2hpbmcgLi4uJyk7XG4gICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCd3YXJuaW5nJywgdGhpcy5fb25XYXJuaW5nKTtcbiAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ3VuY2F1Z2h0RXhjZXB0aW9uJywgdGhpcy5fb25VbmNhdWdodEV4Y2VwdGlvbik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pOyBcbiAgICAgICAgcHJvY2Vzcy5vbignd2FybmluZycsIHRoaXMuX29uV2FybmluZyk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ1Byb2Nlc3Mtd2lkZSBlcnJvciBoYW5kbGVycyBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJ1bmFibGU7Il19