"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  Promise
} = Util;

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }, {
            "type": "file",
            "options": {
              "level": "info",
              "filename": `${name && _.kebabCase(name) || 'app'}.log`
            }
          }],
          ...(options && options.logger)
        },
        ..._.omit(options, ['logger'])
      });

      this._onUncaughtException = err => {
        this.log('error', err);
      };

      this._onWarning = warning => {
        this.log('warn', warning);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_();
        }
      };
    }

    async start_() {
      this._initialize();

      return super.start_();
    }

    async stop_() {
      await super.stop_();
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          this._uninitialize();

          resolve(this);
        }, 0);
      });
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();

      process.on('exit', this._onExit);
    }

    _uninitialize() {
      process.removeListener('exit', this._onExit);
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (this._externalLogger) {
          delete this._externalLogger;
        } else {
          this.logger.close();
        }

        delete this.logger;
        return;
      }

      let loggerOpt = this.options.logger;

      if (loggerOpt instanceof Logger) {
        this.logger = loggerOpt;
        this._externalLogger = true;
      } else {
        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        this.log('verbose', 'Process-wide error handlers are detaching ...');
        process.removeListener('warning', this._onWarning);
        process.removeListener('uncaughtException', this._onUncaughtException);
        return;
      }

      process.on('uncaughtException', this._onUncaughtException);
      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsIlByb21pc2UiLCJ3aW5zdG9uIiwid2luc3RvbkZsaWdodCIsIkxvZ2dlciIsIlJ1bmFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ2dlciIsImZvcm1hdCIsImNvbWJpbmUiLCJjb2xvcml6ZSIsInNpbXBsZSIsImtlYmFiQ2FzZSIsIm9taXQiLCJfb25VbmNhdWdodEV4Y2VwdGlvbiIsImVyciIsImxvZyIsIl9vbldhcm5pbmciLCJ3YXJuaW5nIiwiX29uRXhpdCIsImNvZGUiLCJzdGFydGVkIiwic3RvcF8iLCJzdGFydF8iLCJfaW5pdGlhbGl6ZSIsInJlc29sdmUiLCJyZWplY3QiLCJzZXRUaW1lb3V0IiwiX3VuaW5pdGlhbGl6ZSIsIl9wd2QiLCJwcm9jZXNzIiwiY3dkIiwid29ya2luZ1BhdGgiLCJjaGRpciIsIl9pbmplY3RMb2dnZXIiLCJfaW5qZWN0RXJyb3JIYW5kbGVycyIsIm9uIiwicmVtb3ZlTGlzdGVuZXIiLCJkZXRhY2giLCJfZXh0ZXJuYWxMb2dnZXIiLCJjbG9zZSIsImxvZ2dlck9wdCIsInRyYW5zcG9ydHMiLCJjcmVhdGVMb2dnZXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBaUJILElBQXZCOztBQUVBLE1BQU1JLE9BQU8sR0FBR0gsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsTUFBTUksYUFBYSxHQUFHSixPQUFPLENBQUMsZUFBRCxDQUE3Qjs7QUFDQSxNQUFNSyxNQUFNLEdBQUdMLE9BQU8sQ0FBQyw0QkFBRCxDQUF0Qjs7QUFRQSxNQUFNTSxPQUFPLEdBQUdDLENBQUM7QUFBQTs7QUFBQSxpQkFBSSxjQUFj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UCxHQUFpQjNDLE9BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBQcm9taXNlIH0gPSBVdGlsO1xuXG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xuY29uc3Qgd2luc3RvbkZsaWdodCA9IHJlcXVpcmUoJ3dpbnN0b25mbGlnaHQnKTtcbmNvbnN0IExvZ2dlciA9IHJlcXVpcmUoJ3dpbnN0b24vbGliL3dpbnN0b24vbG9nZ2VyJyk7XG5cbi8qKlxuICogUnVuYWJsZSBhcHAgbWl4aW4uIFxuICogQHBhcmFtIHtvYmplY3R9IFQgLSBCYXNlIGNsYXNzLiAgICAgXG4gKiBAcmV0dXJucyB7UnVuYWJsZX0gQSBydW5hYmxlIGFwcCBjbGFzcy5cbiAqIEBjb25zdHJ1Y3RzIFJ1bmFibGUoVClcbiAqL1xuY29uc3QgUnVuYWJsZSA9IFQgPT4gY2xhc3MgZXh0ZW5kcyBUIHtcbiAgICBfb25VbmNhdWdodEV4Y2VwdGlvbiA9IGVyciA9PiB7XG4gICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVycik7XG4gICAgfTsgICAgICAgIFxuXG4gICAgX29uV2FybmluZyA9IHdhcm5pbmcgPT4ge1xuICAgICAgICB0aGlzLmxvZygnd2FybicsIHdhcm5pbmcpOyAgIFxuICAgIH07XG5cbiAgICBfb25FeGl0ID0gY29kZSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcF8oKTtcbiAgICAgICAgfSAgICAgICAgICAgXG4gICAgfTtcblxuICAgIC8qKiAgICAgICAgICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYXBwbGljYXRpb24uICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gQXBwbGljYXRpb24gb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmxvZ2dlcl0gLSBMb2dnZXIgb3B0aW9ucyAgICBcbiAgICAgKiBAY29uc3RydWN0cyBSdW5hYmxlXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCB7XG4gICAgICAgICAgICBsb2dnZXI6IHtcbiAgICAgICAgICAgICAgICBcImxldmVsXCI6IFwiaW5mb1wiLFxuICAgICAgICAgICAgICAgIFwidHJhbnNwb3J0c1wiOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidHlwZVwiOiBcImNvbnNvbGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwib3B0aW9uc1wiOiB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZm9ybWF0XCI6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUod2luc3Rvbi5mb3JtYXQuY29sb3JpemUoKSwgd2luc3Rvbi5mb3JtYXQuc2ltcGxlKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidHlwZVwiOiBcImZpbGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwib3B0aW9uc1wiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsZXZlbFwiOiBcImluZm9cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImZpbGVuYW1lXCI6IGAke25hbWUgJiYgXy5rZWJhYkNhc2UobmFtZSkgfHwgJ2FwcCd9LmxvZ2BcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgLi4uKG9wdGlvbnMgJiYgb3B0aW9ucy5sb2dnZXIpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLi4uXy5vbWl0KG9wdGlvbnMsIFsnbG9nZ2VyJ10pXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIGFwcCAgICAgXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICogQG1lbWJlcm9mIFJ1bmFibGVcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydF8oKSB7ICAgICAgICBcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0YXJ0XygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIGFwcFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqIEBtZW1iZXJvZiBSdW5hYmxlXG4gICAgICovXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGF3YWl0IHN1cGVyLnN0b3BfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIC8vZGVmZXJyZWQgZXhlY3V0aW9uXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl91bmluaXRpYWxpemUoKTtcblxuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcyk7XG4gICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2luaXRpYWxpemUoKSB7XG4gICAgICAgIHRoaXMuX3B3ZCA9IHByb2Nlc3MuY3dkKCk7XG4gICAgICAgIGlmICh0aGlzLndvcmtpbmdQYXRoICE9PSB0aGlzLl9wd2QpIHsgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBwcm9jZXNzLmNoZGlyKHRoaXMud29ya2luZ1BhdGgpO1xuICAgICAgICB9ICAgICAgXG5cbiAgICAgICAgdGhpcy5faW5qZWN0TG9nZ2VyKCk7XG4gICAgICAgIHRoaXMuX2luamVjdEVycm9ySGFuZGxlcnMoKTsgXG5cbiAgICAgICAgcHJvY2Vzcy5vbignZXhpdCcsIHRoaXMuX29uRXhpdCk7XG4gICAgfVxuXG4gICAgX3VuaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lcignZXhpdCcsIHRoaXMuX29uRXhpdCk7XG5cbiAgICAgICAgY29uc3QgZGV0YWNoID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5faW5qZWN0RXJyb3JIYW5kbGVycyhkZXRhY2gpOyAgICAgICBcbiAgICAgICAgdGhpcy5faW5qZWN0TG9nZ2VyKGRldGFjaCk7ICAgICAgICAgXG5cbiAgICAgICAgcHJvY2Vzcy5jaGRpcih0aGlzLl9wd2QpO1xuICAgICAgICBkZWxldGUgdGhpcy5fcHdkO1xuICAgIH1cblxuICAgIF9pbmplY3RMb2dnZXIoZGV0YWNoKSB7XG4gICAgICAgIGlmIChkZXRhY2gpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0xvZ2dlciBpcyBkZXRhY2hpbmcgLi4uJyk7XG4gICAgICAgICAgICBpZiAodGhpcy5fZXh0ZXJuYWxMb2dnZXIpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fZXh0ZXJuYWxMb2dnZXI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5sb2dnZXI7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbG9nZ2VyT3B0ID0gdGhpcy5vcHRpb25zLmxvZ2dlcjtcblxuICAgICAgICBpZiAobG9nZ2VyT3B0IGluc3RhbmNlb2YgTG9nZ2VyKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlck9wdDtcbiAgICAgICAgICAgIHRoaXMuX2V4dGVybmFsTG9nZ2VyID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChsb2dnZXJPcHQudHJhbnNwb3J0cykge1xuICAgICAgICAgICAgICAgIGxvZ2dlck9wdC50cmFuc3BvcnRzID0gd2luc3RvbkZsaWdodCh3aW5zdG9uLCBsb2dnZXJPcHQudHJhbnNwb3J0cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gd2luc3Rvbi5jcmVhdGVMb2dnZXIobG9nZ2VyT3B0KTsgICBcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdMb2dnZXIgaW5qZWN0ZWQuJyk7ICAgICAgICAgICAgXG4gICAgfVxuXG4gICAgX2luamVjdEVycm9ySGFuZGxlcnMoZGV0YWNoKSB7XG4gICAgICAgIGlmIChkZXRhY2gpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ1Byb2Nlc3Mtd2lkZSBlcnJvciBoYW5kbGVycyBhcmUgZGV0YWNoaW5nIC4uLicpO1xuICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lcignd2FybmluZycsIHRoaXMuX29uV2FybmluZyk7XG4gICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCB0aGlzLl9vblVuY2F1Z2h0RXhjZXB0aW9uKTsgXG4gICAgICAgIHByb2Nlc3Mub24oJ3dhcm5pbmcnLCB0aGlzLl9vbldhcm5pbmcpO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdQcm9jZXNzLXdpZGUgZXJyb3IgaGFuZGxlcnMgaW5qZWN0ZWQuJyk7ICAgICAgICAgICAgXG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBSdW5hYmxlOyJdfQ==