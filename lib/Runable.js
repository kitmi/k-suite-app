"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  Promise
} = Util;

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "useMetaKey": "metadata",
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }],
          ...(options && options.logger)
        },
        ..._.omit(options, ['logger'])
      });

      this._onUncaughtException = err => {
        let waitForLogging = setTimeout(() => {
          process.exit(1);
        }, 1000);
        this.log('error', err, () => {
          clearTimeout(waitForLogging);
          process.exit(1);
        });
      };

      this._onWarning = warning => {
        this.log('warn', warning);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_().catch(this.logError);
        }
      };
    }

    async start_() {
      this._initialize();

      return super.start_();
    }

    async stop_() {
      await super.stop_();
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          this._uninitialize();

          resolve(this);
        }, 0);
      });
    }

    replaceLogger(logger) {
      this._injectLogger(true);

      this.logger = logger;
      this._externalLogger = true;
      this.log('verbose', 'A new logger attached.');
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();

      process.on('exit', this._onExit);
    }

    _uninitialize() {
      process.removeListener('exit', this._onExit);
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (this._externalLogger) {
          delete this._externalLogger;
        } else {
          this.logger.close();
        }

        delete this.logger;
        return;
      }

      let loggerOpt = this.options.logger;

      if (loggerOpt instanceof Logger) {
        this.logger = loggerOpt;
        this._externalLogger = true;
      } else {
        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        this.log('verbose', 'Process-wide error handlers are detaching ...');
        process.removeListener('warning', this._onWarning);
        process.removeListener('uncaughtException', this._onUncaughtException);
        return;
      }

      process.on('uncaughtException', this._onUncaughtException);
      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsIlByb21pc2UiLCJ3aW5zdG9uIiwid2luc3RvbkZsaWdodCIsIkxvZ2dlciIsIlJ1bmFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ2dlciIsImZvcm1hdCIsImNvbWJpbmUiLCJjb2xvcml6ZSIsInNpbXBsZSIsIm9taXQiLCJfb25VbmNhdWdodEV4Y2VwdGlvbiIsImVyciIsIndhaXRGb3JMb2dnaW5nIiwic2V0VGltZW91dCIsInByb2Nlc3MiLCJleGl0IiwibG9nIiwiY2xlYXJUaW1lb3V0IiwiX29uV2FybmluZyIsIndhcm5pbmciLCJfb25FeGl0IiwiY29kZSIsInN0YXJ0ZWQiLCJzdG9wXyIsImNhdGNoIiwibG9nRXJyb3IiLCJzdGFydF8iLCJfaW5pdGlhbGl6ZSIsInJlc29sdmUiLCJyZWplY3QiLCJfdW5pbml0aWFsaXplIiwicmVwbGFjZUxvZ2dlciIsIl9pbmplY3RMb2dnZXIiLCJfZXh0ZXJuYWxMb2dnZXIiLCJfcHdkIiwiY3dkIiwid29ya2luZ1BhdGgiLCJjaGRpciIsIl9pbmplY3RFcnJvckhhbmRsZXJzIiwib24iLCJyZW1vdmVMaXN0ZW5lciIsImRldGFjaCIsImNsb3NlIiwibG9nZ2VyT3B0IiwidHJhbnNwb3J0cyIsImNyZWF0ZUxvZ2dlciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFpQkgsSUFBdkI7O0FBRUEsTUFBTUksT0FBTyxHQUFHSCxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNSSxhQUFhLEdBQUdKLE9BQU8sQ0FBQyxlQUFELENBQTdCOztBQUNBLE1BQU1LLE1BQU0sR0FBR0wsT0FBTyxDQUFD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QXBCO0FBQ0FGLFFBQUFBLE9BQU8sQ0FBQzBCLGNBQVIsQ0FBdUIsU0FBdkIsRUFBa0MsS0FBS3RCLFVBQXZDO0FBQ0FKLFFBQUFBLE9BQU8sQ0FBQzBCLGNBQVIsQ0FBdUIsbUJBQXZCLEVBQTRDLEtBQUs5QixvQkFBakQ7QUFDQTtBQUNIOztBQUVESSxNQUFBQSxPQUFPLENBQUN5QixFQUFSLENBQVcsbUJBQVgsRUFBZ0MsS0FBSzdCLG9CQUFyQztBQUNBSSxNQUFBQSxPQUFPLENBQUN5QixFQUFSLENBQVcsU0FBWCxFQUFzQixLQUFLckIsVUFBM0I7QUFDQSxXQUFLRixHQUFMLENBQVMsU0FBVCxFQUFvQix1Q0FBcEI7QUFDSDs7QUF0SmdDLEdBQXBCO0FBQUEsQ0FBakI7O0FBeUpBOEIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCaEQsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIFByb21pc2UgfSA9IFV0aWw7XG5cbmNvbnN0IHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJyk7XG5jb25zdCB3aW5zdG9uRmxpZ2h0ID0gcmVxdWlyZSgnd2luc3RvbmZsaWdodCcpO1xuY29uc3QgTG9nZ2VyID0gcmVxdWlyZSgnd2luc3Rvbi9saWIvd2luc3Rvbi9sb2dnZXInKTtcblxuLyoqXG4gKiBSdW5hYmxlIGFwcCBtaXhpbi4gXG4gKiBAcGFyYW0ge29iamVjdH0gVCAtIEJhc2UgY2xhc3MuICAgICBcbiAqIEByZXR1cm5zIHtSdW5hYmxlfSBBIHJ1bmFibGUgYXBwIGNsYXNzLlxuICogQGNvbnN0cnVjdHMgUnVuYWJsZShUKVxuICovXG5jb25zdCBSdW5hYmxlID0gVCA9PiBjbGFzcyBleHRlbmRzIFQge1xuICAgIF9vblVuY2F1Z2h0RXhjZXB0aW9uID0gZXJyID0+IHtcbiAgICAgICAgbGV0IHdhaXRGb3JMb2dnaW5nID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH0sIDEwMDApO1xuXG4gICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVyciwgKCkgPT4ge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHdhaXRGb3JMb2dnaW5nKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSk7XG4gICAgfTsgICAgICAgIFxuXG4gICAgX29uV2FybmluZyA9IHdhcm5pbmcgPT4ge1xuICAgICAgICB0aGlzLmxvZygnd2FybicsIHdhcm5pbmcpOyAgIFxuICAgIH07XG5cbiAgICBfb25FeGl0ID0gY29kZSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcF8oKS5jYXRjaCh0aGlzLmxvZ0Vycm9yKTtcbiAgICAgICAgfSAgICAgICAgICAgXG4gICAgfTtcblxuICAgIC8qKiAgICAgICAgICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYXBwbGljYXRpb24uICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gQXBwbGljYXRpb24gb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmxvZ2dlcl0gLSBMb2dnZXIgb3B0aW9ucyAgICBcbiAgICAgKiBAY29uc3RydWN0cyBSdW5hYmxlXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCB7XG4gICAgICAgICAgICBsb2dnZXI6IHtcbiAgICAgICAgICAgICAgICBcInVzZU1ldGFLZXlcIjogXCJtZXRhZGF0YVwiLFxuICAgICAgICAgICAgICAgIFwibGV2ZWxcIjogXCJpbmZvXCIsXG4gICAgICAgICAgICAgICAgXCJ0cmFuc3BvcnRzXCI6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwiY29uc29sZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJmb3JtYXRcIjogd2luc3Rvbi5mb3JtYXQuY29tYmluZSh3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLCB3aW5zdG9uLmZvcm1hdC5zaW1wbGUoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgLi4uKG9wdGlvbnMgJiYgb3B0aW9ucy5sb2dnZXIpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLi4uXy5vbWl0KG9wdGlvbnMsIFsnbG9nZ2VyJ10pXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIGFwcCAgICAgXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICogQG1lbWJlcm9mIFJ1bmFibGVcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydF8oKSB7ICAgICAgICBcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZSgpO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0YXJ0XygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIGFwcFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqIEBtZW1iZXJvZiBSdW5hYmxlXG4gICAgICovXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGF3YWl0IHN1cGVyLnN0b3BfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIC8vZGVmZXJyZWQgZXhlY3V0aW9uXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl91bmluaXRpYWxpemUoKTtcblxuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcyk7XG4gICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSB0aGUgZGVmYXVsdCBsb2dnZXIgc2V0IG9uIGNyZWF0aW9uIG9mIHRoZSBhcHAuXG4gICAgICogQHBhcmFtIHtMb2dnZXJ9IGxvZ2dlciBcbiAgICAgKi9cbiAgICByZXBsYWNlTG9nZ2VyKGxvZ2dlcikge1xuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIodHJ1ZSAvKiBkZXRhY3QgKi8pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlciA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnQSBuZXcgbG9nZ2VyIGF0dGFjaGVkLicpO1xuICAgIH1cblxuICAgIF9pbml0aWFsaXplKCkge1xuICAgICAgICB0aGlzLl9wd2QgPSBwcm9jZXNzLmN3ZCgpO1xuICAgICAgICBpZiAodGhpcy53b3JraW5nUGF0aCAhPT0gdGhpcy5fcHdkKSB7ICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgcHJvY2Vzcy5jaGRpcih0aGlzLndvcmtpbmdQYXRoKTtcbiAgICAgICAgfSAgICAgIFxuXG4gICAgICAgIHRoaXMuX2luamVjdExvZ2dlcigpO1xuICAgICAgICB0aGlzLl9pbmplY3RFcnJvckhhbmRsZXJzKCk7IFxuXG4gICAgICAgIHByb2Nlc3Mub24oJ2V4aXQnLCB0aGlzLl9vbkV4aXQpO1xuICAgIH1cblxuICAgIF91bmluaXRpYWxpemUoKSB7XG4gICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ2V4aXQnLCB0aGlzLl9vbkV4aXQpO1xuXG4gICAgICAgIGNvbnN0IGRldGFjaCA9IHRydWU7XG4gICAgICAgIHRoaXMuX2luamVjdEVycm9ySGFuZGxlcnMoZGV0YWNoKTsgICAgICAgXG4gICAgICAgIHRoaXMuX2luamVjdExvZ2dlcihkZXRhY2gpOyAgICAgICAgIFxuXG4gICAgICAgIHByb2Nlc3MuY2hkaXIodGhpcy5fcHdkKTtcbiAgICAgICAgZGVsZXRlIHRoaXMuX3B3ZDtcbiAgICB9XG5cbiAgICBfaW5qZWN0TG9nZ2VyKGRldGFjaCkge1xuICAgICAgICBpZiAoZGV0YWNoKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdMb2dnZXIgaXMgZGV0YWNoaW5nIC4uLicpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX2V4dGVybmFsTG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2V4dGVybmFsTG9nZ2VyO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGVsZXRlIHRoaXMubG9nZ2VyO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGxvZ2dlck9wdCA9IHRoaXMub3B0aW9ucy5sb2dnZXI7XG5cbiAgICAgICAgaWYgKGxvZ2dlck9wdCBpbnN0YW5jZW9mIExvZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSBsb2dnZXJPcHQ7XG4gICAgICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlciA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobG9nZ2VyT3B0LnRyYW5zcG9ydHMpIHtcbiAgICAgICAgICAgICAgICBsb2dnZXJPcHQudHJhbnNwb3J0cyA9IHdpbnN0b25GbGlnaHQod2luc3RvbiwgbG9nZ2VyT3B0LnRyYW5zcG9ydHMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKGxvZ2dlck9wdCk7ICAgXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnTG9nZ2VyIGluamVjdGVkLicpOyAgICAgICAgICAgIFxuICAgIH1cblxuICAgIF9pbmplY3RFcnJvckhhbmRsZXJzKGRldGFjaCkge1xuICAgICAgICBpZiAoZGV0YWNoKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdQcm9jZXNzLXdpZGUgZXJyb3IgaGFuZGxlcnMgYXJlIGRldGFjaGluZyAuLi4nKTtcbiAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ3dhcm5pbmcnLCB0aGlzLl9vbldhcm5pbmcpO1xuICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lcigndW5jYXVnaHRFeGNlcHRpb24nLCB0aGlzLl9vblVuY2F1Z2h0RXhjZXB0aW9uKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgdGhpcy5fb25VbmNhdWdodEV4Y2VwdGlvbik7IFxuICAgICAgICBwcm9jZXNzLm9uKCd3YXJuaW5nJywgdGhpcy5fb25XYXJuaW5nKTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnUHJvY2Vzcy13aWRlIGVycm9yIGhhbmRsZXJzIGluamVjdGVkLicpOyAgICAgICAgICAgIFxuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUnVuYWJsZTsiXX0=