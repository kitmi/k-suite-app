"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  Promise
} = Util;

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "useMetaKey": "metadata",
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }, {
            "type": "file",
            "options": {
              "level": "info",
              "filename": `${name && _.kebabCase(name) || 'app'}.log`
            }
          }],
          ...(options && options.logger)
        },
        ..._.omit(options, ['logger'])
      });

      this._onUncaughtException = err => {
        this.log('error', err, () => {
          process.exit(1);
        });
      };

      this._onWarning = warning => {
        this.log('warn', warning);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_();
        }
      };
    }

    async start_() {
      this._initialize();

      return super.start_();
    }

    async stop_() {
      await super.stop_();
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          this._uninitialize();

          resolve(this);
        }, 0);
      });
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();

      process.on('exit', this._onExit);
    }

    _uninitialize() {
      process.removeListener('exit', this._onExit);
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (this._externalLogger) {
          delete this._externalLogger;
        } else {
          this.logger.close();
        }

        delete this.logger;
        return;
      }

      let loggerOpt = this.options.logger;

      if (loggerOpt instanceof Logger) {
        this.logger = loggerOpt;
        this._externalLogger = true;
      } else {
        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        this.log('verbose', 'Process-wide error handlers are detaching ...');
        process.removeListener('warning', this._onWarning);
        process.removeListener('uncaughtException', this._onUncaughtException);
        return;
      }

      process.on('uncaughtException', this._onUncaughtException);
      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsIlByb21pc2UiLCJ3aW5zdG9uIiwid2luc3RvbkZsaWdodCIsIkxvZ2dlciIsIlJ1bmFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ2dlciIsImZvcm1hdCIsImNvbWJpbmUiLCJjb2xvcml6ZSIsInNpbXBsZSIsImtlYmFiQ2FzZSIsIm9taXQiLCJfb25VbmNhdWdodEV4Y2VwdGlvbiIsImVyciIsImxvZyIsInByb2Nlc3MiLCJleGl0IiwiX29uV2FybmluZyIsIndhcm5pbmciLCJfb25FeGl0IiwiY29kZSIsInN0YXJ0ZWQiLCJzdG9wXyIsInN0YXJ0XyIsIl9pbml0aWFsaXplIiwicmVzb2x2ZSIsInJlamVjdCIsInNldFRpbWVvdXQiLCJfdW5pbml0aWFsaXplIiwiX3B3ZCIsImN3ZCIsIndvcmtpbmdQYXRoIiwiY2hkaXIiLCJfaW5qZWN0TG9nZ2VyIiwiX2luamVjdEVycm9ySGFuZGxlcnMiLCJvbiIsInJlbW92ZUxpc3RlbmVyIiwiZGV0YWNoIiwiX2V4dGVybmFsTG9nZ2VyIiwiY2xvc2UiLCJsb2dnZXJPcHQiLCJ0cmFuc3BvcnRzIiwiY3JlYXRlTG9nZ2VyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQWlCSCxJQUF2Qjs7QUFFQSxNQUFNSSxPQUFPLEdBQUdILE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUNBLE1BQU1JLGFBQWEsR0FBR0osT0FBTyxDQUFDLGVBQUQsQ0FBN0I7O0FBQ0EsTUFBTUssTUFBTSxHQUFHTCxPQUFPLENBQUMsNEJBQUQsQ0FBdEI7O0FBUUEsTUFBTU0sT0FBTyxHQUFHQyxDQUFDO0FBQUE7O0FBQUEsaUJB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QUNBLFdBQUtILEdBQUwsQ0FBUyxTQUFULEVBQW9CLHVDQUFwQjtBQUNIOztBQTNJZ0MsR0FBcEI7QUFBQSxDQUFqQjs7QUE4SUE2QixNQUFNLENBQUNDLE9BQVAsR0FBaUI1QyxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgUHJvbWlzZSB9ID0gVXRpbDtcblxuY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKTtcbmNvbnN0IHdpbnN0b25GbGlnaHQgPSByZXF1aXJlKCd3aW5zdG9uZmxpZ2h0Jyk7XG5jb25zdCBMb2dnZXIgPSByZXF1aXJlKCd3aW5zdG9uL2xpYi93aW5zdG9uL2xvZ2dlcicpO1xuXG4vKipcbiAqIFJ1bmFibGUgYXBwIG1peGluLiBcbiAqIEBwYXJhbSB7b2JqZWN0fSBUIC0gQmFzZSBjbGFzcy4gICAgIFxuICogQHJldHVybnMge1J1bmFibGV9IEEgcnVuYWJsZSBhcHAgY2xhc3MuXG4gKiBAY29uc3RydWN0cyBSdW5hYmxlKFQpXG4gKi9cbmNvbnN0IFJ1bmFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7XG4gICAgX29uVW5jYXVnaHRFeGNlcHRpb24gPSBlcnIgPT4ge1xuICAgICAgICB0aGlzLmxvZygnZXJyb3InLCBlcnIsICgpID0+IHtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSk7XG4gICAgfTsgICAgICAgIFxuXG4gICAgX29uV2FybmluZyA9IHdhcm5pbmcgPT4ge1xuICAgICAgICB0aGlzLmxvZygnd2FybicsIHdhcm5pbmcpOyAgIFxuICAgIH07XG5cbiAgICBfb25FeGl0ID0gY29kZSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcF8oKTtcbiAgICAgICAgfSAgICAgICAgICAgXG4gICAgfTtcblxuICAgIC8qKiAgICAgICAgICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYXBwbGljYXRpb24uICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gQXBwbGljYXRpb24gb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmxvZ2dlcl0gLSBMb2dnZXIgb3B0aW9ucyAgICBcbiAgICAgKiBAY29uc3RydWN0cyBSdW5hYmxlXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCB7XG4gICAgICAgICAgICBsb2dnZXI6IHtcbiAgICAgICAgICAgICAgICBcInVzZU1ldGFLZXlcIjogXCJtZXRhZGF0YVwiLFxuICAgICAgICAgICAgICAgIFwibGV2ZWxcIjogXCJpbmZvXCIsXG4gICAgICAgICAgICAgICAgXCJ0cmFuc3BvcnRzXCI6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwiY29uc29sZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJmb3JtYXRcIjogd2luc3Rvbi5mb3JtYXQuY29tYmluZSh3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLCB3aW5zdG9uLmZvcm1hdC5zaW1wbGUoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlXCI6IFwiZmlsZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImxldmVsXCI6IFwiaW5mb1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZmlsZW5hbWVcIjogYCR7bmFtZSAmJiBfLmtlYmFiQ2FzZShuYW1lKSB8fCAnYXBwJ30ubG9nYFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAuLi4ob3B0aW9ucyAmJiBvcHRpb25zLmxvZ2dlcilcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAuLi5fLm9taXQob3B0aW9ucywgWydsb2dnZXInXSlcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCB0aGUgYXBwICAgICBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKiBAbWVtYmVyb2YgUnVuYWJsZVxuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0XygpIHsgICAgICAgIFxuICAgICAgICB0aGlzLl9pbml0aWFsaXplKCk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gc3VwZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCB0aGUgYXBwXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICogQG1lbWJlcm9mIFJ1bmFibGVcbiAgICAgKi9cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgYXdhaXQgc3VwZXIuc3RvcF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgLy9kZWZlcnJlZCBleGVjdXRpb25cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX3VuaW5pdGlhbGl6ZSgpO1xuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzKTtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgdGhpcy5fcHdkID0gcHJvY2Vzcy5jd2QoKTtcbiAgICAgICAgaWYgKHRoaXMud29ya2luZ1BhdGggIT09IHRoaXMuX3B3ZCkgeyAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHByb2Nlc3MuY2hkaXIodGhpcy53b3JraW5nUGF0aCk7XG4gICAgICAgIH0gICAgICBcblxuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIoKTtcbiAgICAgICAgdGhpcy5faW5qZWN0RXJyb3JIYW5kbGVycygpOyBcblxuICAgICAgICBwcm9jZXNzLm9uKCdleGl0JywgdGhpcy5fb25FeGl0KTtcbiAgICB9XG5cbiAgICBfdW5pbml0aWFsaXplKCkge1xuICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCdleGl0JywgdGhpcy5fb25FeGl0KTtcblxuICAgICAgICBjb25zdCBkZXRhY2ggPSB0cnVlO1xuICAgICAgICB0aGlzLl9pbmplY3RFcnJvckhhbmRsZXJzKGRldGFjaCk7ICAgICAgIFxuICAgICAgICB0aGlzLl9pbmplY3RMb2dnZXIoZGV0YWNoKTsgICAgICAgICBcblxuICAgICAgICBwcm9jZXNzLmNoZGlyKHRoaXMuX3B3ZCk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9wd2Q7XG4gICAgfVxuXG4gICAgX2luamVjdExvZ2dlcihkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnTG9nZ2VyIGlzIGRldGFjaGluZyAuLi4nKTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9leHRlcm5hbExvZ2dlcikge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9leHRlcm5hbExvZ2dlcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxvZ2dlcjtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsb2dnZXJPcHQgPSB0aGlzLm9wdGlvbnMubG9nZ2VyO1xuXG4gICAgICAgIGlmIChsb2dnZXJPcHQgaW5zdGFuY2VvZiBMb2dnZXIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyT3B0O1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGxvZ2dlck9wdC50cmFuc3BvcnRzKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyT3B0LnRyYW5zcG9ydHMgPSB3aW5zdG9uRmxpZ2h0KHdpbnN0b24sIGxvZ2dlck9wdC50cmFuc3BvcnRzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcihsb2dnZXJPcHQpOyAgIFxuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0xvZ2dlciBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG5cbiAgICBfaW5qZWN0RXJyb3JIYW5kbGVycyhkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkge1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnUHJvY2Vzcy13aWRlIGVycm9yIGhhbmRsZXJzIGFyZSBkZXRhY2hpbmcgLi4uJyk7XG4gICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCd3YXJuaW5nJywgdGhpcy5fb25XYXJuaW5nKTtcbiAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ3VuY2F1Z2h0RXhjZXB0aW9uJywgdGhpcy5fb25VbmNhdWdodEV4Y2VwdGlvbik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pOyBcbiAgICAgICAgcHJvY2Vzcy5vbignd2FybmluZycsIHRoaXMuX29uV2FybmluZyk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ1Byb2Nlc3Mtd2lkZSBlcnJvciBoYW5kbGVycyBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJ1bmFibGU7Il19