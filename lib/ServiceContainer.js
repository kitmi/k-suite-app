"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const ConfigLoader = require('rk-config');

const JsonConfigProvider = require('rk-config/lib/JsonConfigProvider');

const {
  _,
  fs,
  Promise
} = Util;

const path = require('path');

const EventEmitter = require('events');

const winston = require('winston');

const Feature = require('./enum/Feature');

const Literal = require('./enum/Literal');

class ServiceContainer extends EventEmitter {
  constructor(name, options) {
    super();

    this.logError = error => {
      return this.log('error', error.message, _.pick(error, ['name', 'status', 'code', 'extraInfo', 'stack']));
    };

    this.name = name;
    this.options = Object.assign({}, options);
    this.env = this.options.env || process.env.NODE_ENV || "development";
    this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();
    this.configPath = this.toAbsolutePath(this.options.configPath || Literal.DEFAULT_CONFIG_PATH);
    this.configName = this.options.configName || Literal.APP_CFG_NAME;
    this.backendPath = this.toAbsolutePath(this.options.backendPath || Literal.BACKEND_PATH);
  }

  async start_() {
    this._featureRegistry = {
      '*': this._getFeatureFallbackPath()
    };
    this.features = {};
    this.services = {};

    if (this.options.loadConfigFromOptions) {
      this.config = this.options.config;
    } else {
      this.configLoader = this.options.disableEnvAwareConfig ? new ConfigLoader(new JsonConfigProvider(path.join(this.configPath, this.configName + '.json')), this) : ConfigLoader.createEnvAwareJsonLoader(this.configPath, this.configName, this.env, this);
      await this.loadConfig_();
    }

    this.emit('configLoaded');

    if (_.isEmpty(this.config)) {
      throw Error('Empty configuration. Nothing to do! Config path: ' + this.configPath);
    }

    await this._loadFeatures_();
    this.emit('ready');
    this.started = true;
    return this;
  }

  async stop_() {
    this.emit('stopping');
    this.started = false;
    delete this.services;
    delete this.features;
    delete this._featureRegistry;
    delete this.config;
    delete this.configLoader;
  }

  async loadConfig_() {
    let configVariables = this._getConfigVariables();

    this.config = await this.configLoader.load_(configVariables);
    return this;
  }

  toAbsolutePath(...args) {
    if (args.length === 0) {
      return this.workingPath;
    }

    return path.resolve(this.workingPath, ...args);
  }

  registerService(name, serviceObject, override) {
    if (name in this.services && !override) {
      throw new Error('Service "' + name + '" already registered!');
    }

    this.services[name] = serviceObject;
    this.log('verbose', `Service "${name}" registered.`);
    return this;
  }

  hasService(name) {
    return name in this.services;
  }

  getService(name) {
    return this.services[name];
  }

  enabled(feature) {
    return this.features.hasOwnProperty(feature);
  }

  addFeatureRegistry(registry) {
    if (registry.hasOwnProperty('*')) {
      Util.putIntoBucket(this._featureRegistry, '*', registry['*']);
    }

    Object.assign(this._featureRegistry, _.omit(registry, ['*']));
  }

  log(level, message, ...rest) {
    this.logger && this.logger.log(level, message, ...rest);
    return this;
  }

  _getConfigVariables() {
    return {
      'app': this,
      'log': winston,
      'env': this.env
    };
  }

  _getFeatureFallbackPath() {
    return [path.resolve(__dirname, Literal.FEATURES_PATH), this.toAbsolutePath(Literal.FEATURES_PATH)];
  }

  async _loadFeatures_() {
    let configStageFeatures = [];

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature;

      try {
        feature = this._loadFeature(name);
      } catch (err) {
        console.error(err);
      }

      if (feature && feature.type === Feature.CONF) {
        configStageFeatures.push([name, feature.load_, featureOptions]);
        delete this.config[name];
      }
    });

    if (configStageFeatures.length > 0) {
      configStageFeatures.forEach(([name]) => {
        delete this.config[name];
      });
      await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);
      return this._loadFeatures_();
    }

    let featureGroups = {
      [Feature.INIT]: [],
      [Feature.SERVICE]: [],
      [Feature.PLUGIN]: [],
      [Feature.FINAL]: []
    };

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature = this._loadFeature(name);

      if (!(feature.type in featureGroups)) {
        throw new Error(`Invalid feature type. Feature: ${name}, type: ${feature.type}`);
      }

      featureGroups[feature.type].push([name, feature.load_, featureOptions]);
    });

    return Util.eachAsync_(featureGroups, (group, level) => this._loadFeatureGroup_(group, level));
  }

  async _loadFeatureGroup_(featureGroup, groupLevel) {
    this.emit('before:' + groupLevel);
    this.log('verbose', `Loading "${groupLevel}" feature group ...`);
    await Util.eachAsync_(featureGroup, async ([name, load_, options]) => {
      this.emit('before:load:' + name);
      this.log('verbose', `Loading feature "${name}" ...`);
      await load_(this, options);
      this.features[name].loaded = true;
      this.log('verbose', `Feature "${name}" loaded. [OK]`);
      this.emit('after:load:' + name);
    });
    this.log('verbose', `Finished loading "${groupLevel}" feature group. [OK]`);
    this.emit('after:' + groupLevel);
  }

  _loadFeature(feature) {
    let featureObject = this.features[feature];
    if (featureObject) return featureObject;
    let featurePath;

    if (this._featureRegistry.hasOwnProperty(feature)) {
      let loadOption = this._featureRegistry[feature];

      if (Array.isArray(loadOption)) {
        if (loadOption.length === 0) {
          throw new Error(`Invalid registry value for feature "${feature}".`);
        }

        featurePath = loadOption[0];
        featureObject = require(featurePath);

        if (loadOption.length > 1) {
          featureObject = Util.getValueByPath(featureObject, loadOption[1]);
        }
      } else {
        featurePath = loadOption;
        featureObject = require(featurePath);
      }
    } else {
      let searchingPath = this._featureRegistry['*'];

      let found = _.findLast(searchingPath, p => {
        featurePath = path.join(p, feature + '.js');
        return fs.existsSync(featurePath);
      });

      if (!found) {
        throw new Error(`Don't know where to load feature "${feature}".`);
      }

      featureObject = require(featurePath);
    }

    if (!Feature.validate(featureObject)) {
      throw new Error(`Invalid feature object loaded from "${featurePath}".`);
    }

    this.features[feature] = featureObject;
    return featureObject;
  }

}

module.exports = ServiceContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZXJ2aWNlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiQ29uZmlnTG9hZGVyIiwiSnNvbkNvbmZpZ1Byb3ZpZGVyIiwiXyIsImZzIiwiUHJvbWlzZSIsInBhdGgiLCJFdmVudEVtaXR0ZXIiLCJ3aW5zdG9uIiwiRmVhdHVyZSIsIkxpdGVyYWwiLCJTZXJ2aWNlQ29udGFpbmVyIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ0Vycm9yIiwiZXJyb3IiLCJsb2ciLCJtZXNzYWdlIiwicGljayIsIk9iamVjdCIsImFzc2lnbiIsImVudiIsInByb2Nlc3MiLCJOT0RFX0VOViIsIndvcmtpbmdQYXRoIiwicmVzb2x2ZSIsImN3ZCIsImNvbmZpZ1BhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkRFRkFVTFRfQ09ORklHX1BBVEgiLCJjb25maWdOYW1lIiwiQVBQX0NGR19OQU1FIiwiYmFja2VuZFBhdGgiLCJCQUNLRU5EX1BBVEgiLCJzdGFydF8iLCJfZmVhdHVyZVJlZ2lzdHJ5IiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJmZWF0dXJlcyIsInNlcnZpY2VzIiwibG9hZENvbmZpZ0Zyb21PcHRpb25zIiwiY29uZmlnIiwiY29uZmlnTG9hZGVyIiwiZGlzYWJsZUVudkF3YXJlQ29uZmlnIiwiam9pbiIsImNyZWF0ZUVudkF3YXJlSnNvbkxvYWRlciIsImxvYWRDb25maWdfIiwiZW1pdCIsImlzRW1wdHkiLCJFcnJvciIsIl9sb2FkRmVhdHVyZXNfIiwic3RhcnRlZCIsInN0b3BfIiwiY29uZmlnVmFyaWFibGVzIiwiX2dldENvbmZpZ1ZhcmlhYmxlcyIsImxvYWRfIiwiYXJncyIsImxlbmd0aCIsInJlZ2lzdGVyU2VydmljZSIsInNlcnZpY2VPYmplY3QiLCJvdmVycmlkZSIsImhhc1NlcnZpY2UiLCJnZXRTZXJ2aWNlIiwiZW5hYmxlZCIsImZlYXR1cmUiLCJoYXNPd25Qcm9wZXJ0eSIsImFkZEZlYXR1cmVSZWdpc3RyeSIsInJlZ2lzdHJ5IiwicHV0SW50b0J1Y2tldCIsIm9taXQiLCJsZXZlbCIsInJlc3QiLCJsb2dnZXIiLCJfX2Rpcm5hbWUiLCJGRUFUVVJFU19QQVRIIiwiY29uZmlnU3RhZ2VGZWF0dXJlcyIsImZvck93biIsImZlYXR1cmVPcHRpb25zIiwiYWxsb3dlZEZlYXR1cmVzIiwiaW5kZXhPZiIsIl9sb2FkRmVhdHVyZSIsImVyciIsImNvbnNvbGUiLCJ0eXBlIiwiQ09ORiIsInB1c2giLCJmb3JFYWNoIiwiX2xvYWRGZWF0dXJlR3JvdXBfIiwiZmVhdHVyZUdyb3VwcyIsIklOSVQiLCJTRVJWSUNFIiwiUExVR0lOIiwiRklOQUwiLCJlYWNoQXN5bmNfIiwiZ3JvdXAiLCJmZWF0dXJlR3JvdXAiLCJncm91cExldmVsIiwibG9hZGVkIiwiZmVhdHVyZU9iamVjdCIsImZlYXR1cmVQYXRoIiwibG9hZE9wdGlvbiIsIkFycmF5IiwiaXNBcnJheSIsImdldFZhbHVlQnlQYXRoIiwic2VhcmNoaW5nUGF0aCIsImZvdW5kIiwiZmluZExhc3QiLCJwIiwiZXhpc3RzU3luYyIsInZhbGlkYXRlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBNUI7O0FBQ0EsTUFBTUUsa0JBQWtCLEdBQUdGLE9BQU8sQ0FBQyxrQ0FBRCxDQUFsQzs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQTtBQUFULElBQXFCTixJQUEzQjs7QUFDQSxNQUFNTyxJQUFJLEdBQUdOLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1PLFlBQVksR0FBR1AsT0FBTyxDQUFDLFFBQUQsQ0FBNUI7O0FBQ0EsTUFBTVEsT0FBTyxHQUFHUixPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFFQSxNQUFNUyxP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QyxZQUFNLElBQUlqRCxLQUFKLENBQVcsdUNBQXNDa0QsV0FBWSxJQUE3RCxDQUFOO0FBQ0g7O0FBRUQsU0FBSzdELFFBQUwsQ0FBYzBCLE9BQWQsSUFBeUJrQyxhQUF6QjtBQUNBLFdBQU9BLGFBQVA7QUFDSDs7QUExWXVDOztBQTZZNUNZLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBHLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IENvbmZpZ0xvYWRlciA9IHJlcXVpcmUoJ3JrLWNvbmZpZycpO1xuY29uc3QgSnNvbkNvbmZpZ1Byb3ZpZGVyID0gcmVxdWlyZSgncmstY29uZmlnL2xpYi9Kc29uQ29uZmlnUHJvdmlkZXInKTtcbmNvbnN0IHsgXywgZnMsIFByb21pc2UgfSA9IFV0aWw7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xuXG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuXG4vKipcbiAqIFNlcnZpY2UgY29udGFpbmVyIGNsYXNzLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBFdmVudEVtaXR0ZXIgICAgIFxuICovXG5jbGFzcyBTZXJ2aWNlQ29udGFpbmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBsb2dFcnJvciA9IChlcnJvcikgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2coJ2Vycm9yJywgZXJyb3IubWVzc2FnZSwgXy5waWNrKGVycm9yLCBbICduYW1lJywgJ3N0YXR1cycsICdjb2RlJywgJ2V4dHJhSW5mbycsICdzdGFjaycgXSkpO1xuICAgIH1cblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgY29udGFpbmVyIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIENvbnRhaW5lciBvcHRpb25zICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5lbnZdIC0gRW52aXJvbm1lbnQsIGRlZmF1bHQgdG8gcHJvY2Vzcy5lbnYuTk9ERV9FTlZcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMud29ya2luZ1BhdGhdIC0gQXBwJ3Mgd29ya2luZyBwYXRoLCBkZWZhdWx0IHRvIHByb2Nlc3MuY3dkKClcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnUGF0aF0gLSBBcHAncyBjb25maWcgcGF0aCwgZGVmYXVsdCB0byBcImNvbmZcIiB1bmRlciB3b3JraW5nUGF0aFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdOYW1lXSAtIEFwcCdzIGNvbmZpZyBiYXNlbmFtZSwgZGVmYXVsdCB0byBcImFwcFwiXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmRpc2FibGVFbnZBd2FyZUNvbmZpZz1mYWxzZV0gLSBEb24ndCB1c2UgZW52aXJvbm1lbnQtYXdhcmUgY29uZmlnXG4gICAgICogQHByb3BlcnR5IHthcnJheX0gW29wdGlvbnMuYWxsb3dlZEZlYXR1cmVzXSAtIEEgbGlzdCBvZiBlbmFibGVkIGZlYXR1cmUgbmFtZXNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhlIGFwcFxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBvcHRpb25zXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgLy8uLi4gZGVmYXVsdCBvcHRpb25zICAgICAgICAgICAgXG4gICAgICAgIH0sIG9wdGlvbnMpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFbnZpcm9ubWVudCBmbGFnXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbnYgPSB0aGlzLm9wdGlvbnMuZW52IHx8IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8IFwiZGV2ZWxvcG1lbnRcIjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogV29ya2luZyBkaXJlY3Rvcnkgb2YgdGhpcyBjbGkgYXBwXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMud29ya2luZ1BhdGggPSB0aGlzLm9wdGlvbnMud29ya2luZ1BhdGggPyBwYXRoLnJlc29sdmUodGhpcy5vcHRpb25zLndvcmtpbmdQYXRoKSA6IHByb2Nlc3MuY3dkKCk7ICAgICBcbiAgICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDb25maWcgcGF0aFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jb25maWdQYXRoIHx8IExpdGVyYWwuREVGQVVMVF9DT05GSUdfUEFUSCk7ICAgICAgXG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIGJhc2VuYW1lXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnTmFtZSA9IHRoaXMub3B0aW9ucy5jb25maWdOYW1lIHx8IExpdGVyYWwuQVBQX0NGR19OQU1FO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBCYWNrZW5kIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmJhY2tlbmRQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuYmFja2VuZFBhdGggfHwgTGl0ZXJhbC5CQUNLRU5EX1BBVEgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBjb250YWluZXIuXG4gICAgICogQGZpcmVzIFNlcnZpY2VDb250YWluZXIjY29uZmlnTG9hZGVkXG4gICAgICogQGZpcmVzIFNlcnZpY2VDb250YWluZXIjcmVhZHlcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48U2VydmljZUNvbnRhaW5lcj59XG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKCkgeyAgICAgICAgICAgIFxuICAgICAgICB0aGlzLl9mZWF0dXJlUmVnaXN0cnkgPSB7XG4gICAgICAgICAgICAvL2ZpcnN0bHkgbG9vayB1cCBcImZlYXR1cmVzXCIgdW5kZXIgY3VycmVudCB3b3JraW5nIHBhdGgsIGFuZCB0aGVuIHRyeSB0aGUgYnVpbHRpbiBmZWF0dXJlcyBwYXRoXG4gICAgICAgICAgICAnKic6IHRoaXMuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKVxuICAgICAgICB9O1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9hZGVkIGZlYXR1cmVzLCBuYW1lID0+IGZlYXR1cmUgb2JqZWN0XG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7fTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExvYWRlZCBzZXJ2aWNlc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNlcnZpY2VzID0ge307ICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2FkQ29uZmlnRnJvbU9wdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5vcHRpb25zLmNvbmZpZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQ29uZmlndXJhdGlvbiBsb2FkZXIgaW5zdGFuY2VcbiAgICAgICAgICAgICAqIEBtZW1iZXIge0NvbmZpZ0xvYWRlcn0gICAgICAgICBcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5jb25maWdMb2FkZXIgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZUVudkF3YXJlQ29uZmlnID8gXG4gICAgICAgICAgICAgICAgbmV3IENvbmZpZ0xvYWRlcihuZXcgSnNvbkNvbmZpZ1Byb3ZpZGVyKHBhdGguam9pbih0aGlzLmNvbmZpZ1BhdGgsIHRoaXMuY29uZmlnTmFtZSArICcuanNvbicpKSwgdGhpcykgOiBcbiAgICAgICAgICAgICAgICBDb25maWdMb2FkZXIuY3JlYXRlRW52QXdhcmVKc29uTG9hZGVyKHRoaXMuY29uZmlnUGF0aCwgdGhpcy5jb25maWdOYW1lLCB0aGlzLmVudiwgdGhpcyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZENvbmZpZ18oKTsgICAgIFxuICAgICAgICB9ICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbmZpZyBsb2FkZWQgZXZlbnQuXG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI2NvbmZpZ0xvYWRlZFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdjb25maWdMb2FkZWQnKTtcblxuICAgICAgICBpZiAoXy5pc0VtcHR5KHRoaXMuY29uZmlnKSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0VtcHR5IGNvbmZpZ3VyYXRpb24uIE5vdGhpbmcgdG8gZG8hIENvbmZpZyBwYXRoOiAnICsgdGhpcy5jb25maWdQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGZWF0dXJlc18oKTsgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCByZWFkeVxuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNyZWFkeVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdyZWFkeScpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGbGFnIHNob3dpbmcgdGhlIGFwcCBpcyBzdGFydGVkIG9yIG5vdC5cbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBjb250YWluZXJcbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxTZXJ2aWNlQ29udGFpbmVyPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBzdG9wcGluZ1xuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdzdG9wcGluZycpO1xuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgICAgICBkZWxldGUgdGhpcy5zZXJ2aWNlcztcbiAgICAgICAgZGVsZXRlIHRoaXMuZmVhdHVyZXM7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9mZWF0dXJlUmVnaXN0cnk7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnO1xuICAgICAgICBkZWxldGUgdGhpcy5jb25maWdMb2FkZXI7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7U2VydmljZUNvbnRhaW5lcn1cbiAgICAgKi9cbiAgICBhc3luYyBsb2FkQ29uZmlnXygpIHtcbiAgICAgICAgbGV0IGNvbmZpZ1ZhcmlhYmxlcyA9IHRoaXMuX2dldENvbmZpZ1ZhcmlhYmxlcygpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHAgY29uZmlndXJhdGlvblxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGF3YWl0IHRoaXMuY29uZmlnTG9hZGVyLmxvYWRfKGNvbmZpZ1ZhcmlhYmxlcyk7ICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGEgcmVsYXRpdmUgcGF0aCBvZiB0aGlzIGFwcCBtb2R1bGUgdG8gYW4gYWJzb2x1dGUgcGF0aCAgICAgXG4gICAgICogQHBhcmFtIHthcnJheX0gYXJncyAtIEFycmF5IG9mIHBhdGggcGFydHNcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRvQWJzb2x1dGVQYXRoKC4uLmFyZ3MpIHtcbiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53b3JraW5nUGF0aDtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gcGF0aC5yZXNvbHZlKHRoaXMud29ya2luZ1BhdGgsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIGEgc2VydmljZSAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2VydmljZU9iamVjdFxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3ZlcnJpZGVcbiAgICAgKi9cbiAgICByZWdpc3RlclNlcnZpY2UobmFtZSwgc2VydmljZU9iamVjdCwgb3ZlcnJpZGUpIHtcbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5zZXJ2aWNlcyAmJiAhb3ZlcnJpZGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2VydmljZSBcIicrIG5hbWUgKydcIiBhbHJlYWR5IHJlZ2lzdGVyZWQhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNlcnZpY2VzW25hbWVdID0gc2VydmljZU9iamVjdDtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgU2VydmljZSBcIiR7bmFtZX1cIiByZWdpc3RlcmVkLmApO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIGEgc2VydmljZSBleGlzdHNcbiAgICAgKiBAcGFyYW0geyp9IG5hbWUgXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzU2VydmljZShuYW1lKSB7XG4gICAgICAgIHJldHVybiBuYW1lIGluIHRoaXMuc2VydmljZXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgc2VydmljZSBmcm9tIG1vZHVsZSBoaWVyYXJjaHkgICAgIFxuICAgICAqIEBwYXJhbSBuYW1lXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXRTZXJ2aWNlKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VydmljZXNbbmFtZV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIGZlYXR1cmUgaXMgZW5hYmxlZCBpbiB0aGUgYXBwLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlIFxuICAgICAqIEByZXR1cm5zIHtib29sfVxuICAgICAqL1xuICAgIGVuYWJsZWQoZmVhdHVyZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcy5oYXNPd25Qcm9wZXJ0eShmZWF0dXJlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgbW9yZSBvciBvdmVyaWRlIGN1cnJlbnQgZmVhdHVyZSByZWdpc3RyeVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWdpc3RyeSBcbiAgICAgKi9cbiAgICBhZGRGZWF0dXJlUmVnaXN0cnkocmVnaXN0cnkpIHtcbiAgICAgICAgLy8gKiBpcyB1c2VkIGFzIHRoZSBmYWxsYmFjayBsb2NhdGlvbiB0byBmaW5kIGEgZmVhdHVyZVxuICAgICAgICBpZiAocmVnaXN0cnkuaGFzT3duUHJvcGVydHkoJyonKSkge1xuICAgICAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSwgJyonLCByZWdpc3RyeVsnKiddKTtcbiAgICAgICAgfVxuXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5fZmVhdHVyZVJlZ2lzdHJ5LCBfLm9taXQocmVnaXN0cnksIFsnKiddKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmYXVsdCBsb2cgbWV0aG9kLCBtYXkgYmUgb3ZlcnJpZGUgYnkgbG9nZ2VycyBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IC0gTG9nIGxldmVsXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IC0gTG9nIG1lc3NhZ2VcbiAgICAgKiBAcGFyYW0gey4uLm9iamVjdH0gLSBFeHRyYSBtZXRhIGRhdGFcbiAgICAgKiBAcmV0dXJucyB7U2VydmljZUNvbnRhaW5lcn1cbiAgICAgKi9cbiAgICBsb2cobGV2ZWwsIG1lc3NhZ2UsIC4uLnJlc3QpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgJiYgdGhpcy5sb2dnZXIubG9nKGxldmVsLCBtZXNzYWdlLCAuLi5yZXN0KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgX2dldENvbmZpZ1ZhcmlhYmxlcygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdhcHAnOiB0aGlzLCAgICAgICAgICAgIFxuICAgICAgICAgICAgJ2xvZyc6IHdpbnN0b24sXG4gICAgICAgICAgICAnZW52JzogdGhpcy5lbnZcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgcmV0dXJuIFsgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSwgdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF07XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIExvYWQgZmVhdHVyZXNcbiAgICAgKiBAcHJpdmF0ZSAgICAgXG4gICAgICogQHJldHVybnMge2Jvb2x9XG4gICAgICovXG4gICAgYXN5bmMgX2xvYWRGZWF0dXJlc18oKSB7ICAgICAgIFxuICAgICAgICAvLyBydW4gY29uZmlnIHN0YWdlIHNlcGFyYXRlbHkgZmlyc3RcbiAgICAgICAgbGV0IGNvbmZpZ1N0YWdlRmVhdHVyZXMgPSBbXTsgICAgICAgIFxuXG4gICAgICAgIC8vIGxvYWQgZmVhdHVyZXNcbiAgICAgICAgXy5mb3JPd24odGhpcy5jb25maWcsIChmZWF0dXJlT3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMgJiZcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuYWxsb3dlZEZlYXR1cmVzLmluZGV4T2YobmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgLy9za2lwIGRpc2FibGVkIGZlYXR1cmVzXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZmVhdHVyZTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZmVhdHVyZSA9IHRoaXMuX2xvYWRGZWF0dXJlKG5hbWUpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsgICAgIFxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsgICAgICAgICAgIFxuICAgICAgICAgICAgfSAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZmVhdHVyZSAmJiBmZWF0dXJlLnR5cGUgPT09IEZlYXR1cmUuQ09ORikgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25maWdTdGFnZUZlYXR1cmVzLnB1c2goWyBuYW1lLCBmZWF0dXJlLmxvYWRfLCBmZWF0dXJlT3B0aW9ucyBdKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jb25maWdbbmFtZV07XG4gICAgICAgICAgICB9ICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKGNvbmZpZ1N0YWdlRmVhdHVyZXMubGVuZ3RoID4gMCkgeyAgICAgIFxuICAgICAgICAgICAgLy9jb25maWd1cmF0aW9uIGZlYXR1cmVzIHdpbGwgYmUgb3ZlcnJpZGVkIGJ5IG5ld2x5IGxvYWRlZCBjb25maWdcbiAgICAgICAgICAgIGNvbmZpZ1N0YWdlRmVhdHVyZXMuZm9yRWFjaCgoWyBuYW1lIF0pID0+IHsgZGVsZXRlIHRoaXMuY29uZmlnW25hbWVdOyB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZlYXR1cmVHcm91cF8oY29uZmlnU3RhZ2VGZWF0dXJlcywgRmVhdHVyZS5DT05GKTtcblxuICAgICAgICAgICAgLy9yZWxvYWQgYWxsIGZlYXR1cmVzIGlmIGFueSB0eXBlIG9mIGNvbmZpZ3VyYXRpb24gZmVhdHVyZSBleGlzdHMgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sb2FkRmVhdHVyZXNfKCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmVhdHVyZUdyb3VwcyA9IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIFtGZWF0dXJlLklOSVRdOiBbXSwgICAgICAgICAgICBcbiAgICAgICAgICAgIFtGZWF0dXJlLlNFUlZJQ0VdOiBbXSwgICAgICAgICAgICBcbiAgICAgICAgICAgIFtGZWF0dXJlLlBMVUdJTl06IFtdLFxuICAgICAgICAgICAgW0ZlYXR1cmUuRklOQUxdOiBbXVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIGxvYWQgZmVhdHVyZXNcbiAgICAgICAgXy5mb3JPd24odGhpcy5jb25maWcsIChmZWF0dXJlT3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMgJiZcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuYWxsb3dlZEZlYXR1cmVzLmluZGV4T2YobmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgLy9za2lwIGRpc2FibGVkIGZlYXR1cmVzXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZmVhdHVyZSA9IHRoaXMuX2xvYWRGZWF0dXJlKG5hbWUpO1xuXG4gICAgICAgICAgICBpZiAoIShmZWF0dXJlLnR5cGUgaW4gZmVhdHVyZUdyb3VwcykpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZmVhdHVyZSB0eXBlLiBGZWF0dXJlOiAke25hbWV9LCB0eXBlOiAke2ZlYXR1cmUudHlwZX1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZmVhdHVyZUdyb3Vwc1tmZWF0dXJlLnR5cGVdLnB1c2goWyBuYW1lLCBmZWF0dXJlLmxvYWRfLCBmZWF0dXJlT3B0aW9ucyBdKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFV0aWwuZWFjaEFzeW5jXyhmZWF0dXJlR3JvdXBzLCAoZ3JvdXAsIGxldmVsKSA9PiB0aGlzLl9sb2FkRmVhdHVyZUdyb3VwXyhncm91cCwgbGV2ZWwpKTtcbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZEZlYXR1cmVHcm91cF8oZmVhdHVyZUdyb3VwLCBncm91cExldmVsKSB7XG4gICAgICAgIHRoaXMuZW1pdCgnYmVmb3JlOicgKyBncm91cExldmVsKTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgTG9hZGluZyBcIiR7Z3JvdXBMZXZlbH1cIiBmZWF0dXJlIGdyb3VwIC4uLmApO1xuICAgICAgICBhd2FpdCBVdGlsLmVhY2hBc3luY18oZmVhdHVyZUdyb3VwLCBhc3luYyAoWyBuYW1lLCBsb2FkXywgb3B0aW9ucyBdKSA9PiB7ICAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5lbWl0KCdiZWZvcmU6bG9hZDonICsgbmFtZSk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIGZlYXR1cmUgXCIke25hbWV9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgIGF3YWl0IGxvYWRfKHRoaXMsIG9wdGlvbnMpOyAgIFxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXS5sb2FkZWQgPSB0cnVlOyAgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgRmVhdHVyZSBcIiR7bmFtZX1cIiBsb2FkZWQuIFtPS11gKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnYWZ0ZXI6bG9hZDonICsgbmFtZSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBGaW5pc2hlZCBsb2FkaW5nIFwiJHtncm91cExldmVsfVwiIGZlYXR1cmUgZ3JvdXAuIFtPS11gKTtcbiAgICAgICAgdGhpcy5lbWl0KCdhZnRlcjonICsgZ3JvdXBMZXZlbCk7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIExvYWQgYSBmZWF0dXJlIG9iamVjdCBieSBuYW1lLlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmUgXG4gICAgICogQHJldHVybnMge29iamVjdH0gICAgIFxuICAgICAqL1xuICAgIF9sb2FkRmVhdHVyZShmZWF0dXJlKSB7XG4gICAgICAgIGxldCBmZWF0dXJlT2JqZWN0ID0gdGhpcy5mZWF0dXJlc1tmZWF0dXJlXTtcbiAgICAgICAgaWYgKGZlYXR1cmVPYmplY3QpIHJldHVybiBmZWF0dXJlT2JqZWN0O1xuXG4gICAgICAgIGxldCBmZWF0dXJlUGF0aDtcblxuICAgICAgICBpZiAodGhpcy5fZmVhdHVyZVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KGZlYXR1cmUpKSB7ICAgICAgICAgIFxuICAgICAgICAgICAgLy9sb2FkIGJ5IHJlZ2lzdHJ5IGVudHJ5XG4gICAgICAgICAgICBsZXQgbG9hZE9wdGlvbiA9IHRoaXMuX2ZlYXR1cmVSZWdpc3RyeVtmZWF0dXJlXTsgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobG9hZE9wdGlvbikpIHtcbiAgICAgICAgICAgICAgICBpZiAobG9hZE9wdGlvbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJlZ2lzdHJ5IHZhbHVlIGZvciBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvblswXTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG5cbiAgICAgICAgICAgICAgICBpZiAobG9hZE9wdGlvbi5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vb25lIG1vZHVsZSBtYXkgY29udGFpbnMgbW9yZSB0aGFuIG9uZSBmZWF0dXJlXG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSBVdGlsLmdldFZhbHVlQnlQYXRoKGZlYXR1cmVPYmplY3QsIGxvYWRPcHRpb25bMV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZmVhdHVyZVBhdGggPSBsb2FkT3B0aW9uO1xuICAgICAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSByZXF1aXJlKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy9sb2FkIGJ5IGZhbGxiYWNrIHBhdGhzXG4gICAgICAgICAgICBsZXQgc2VhcmNoaW5nUGF0aCA9IHRoaXMuX2ZlYXR1cmVSZWdpc3RyeVsnKiddO1xuICAgIFxuICAgICAgICAgICAgLy9yZXZlcnNlIGZhbGxiYWNrIHN0YWNrXG4gICAgICAgICAgICBsZXQgZm91bmQgPSBfLmZpbmRMYXN0KHNlYXJjaGluZ1BhdGgsIHAgPT4ge1xuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gcGF0aC5qb2luKHAsIGZlYXR1cmUgKyAnLmpzJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZzLmV4aXN0c1N5bmMoZmVhdHVyZVBhdGgpO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAgICAgaWYgKCFmb3VuZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRG9uJ3Qga25vdyB3aGVyZSB0byBsb2FkIGZlYXR1cmUgXCIke2ZlYXR1cmV9XCIuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSByZXF1aXJlKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCFGZWF0dXJlLnZhbGlkYXRlKGZlYXR1cmVPYmplY3QpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZmVhdHVyZSBvYmplY3QgbG9hZGVkIGZyb20gXCIke2ZlYXR1cmVQYXRofVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5mZWF0dXJlc1tmZWF0dXJlXSA9IGZlYXR1cmVPYmplY3Q7XG4gICAgICAgIHJldHVybiBmZWF0dXJlT2JqZWN0O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTZXJ2aWNlQ29udGFpbmVyOyJdfQ==