"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const ConfigLoader = require('rk-config');

const JsonConfigProvider = require('rk-config/lib/JsonConfigProvider');

const {
  _,
  fs,
  Promise
} = Util;

const path = require('path');

const EventEmitter = require('events');

const winston = require('winston');

const Feature = require('./enum/Feature');

const Literal = require('./enum/Literal');

class ServiceContainer extends EventEmitter {
  constructor(name, options) {
    super();

    this.logError = error => {
      return this.log('error', error.message, _.pick(error, ['name', 'status', 'code', 'extraInfo', 'stack']));
    };

    this.name = name;
    this.options = Object.assign({}, options);
    this.env = this.options.env || process.env.NODE_ENV || "development";
    this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();
    this.configPath = this.toAbsolutePath(this.options.configPath || Literal.DEFAULT_CONFIG_PATH);
    this.configName = this.options.configName || Literal.APP_CFG_NAME;
    this.backendPath = this.toAbsolutePath(this.options.backendPath || Literal.BACKEND_PATH);
  }

  async start_() {
    this._featureRegistry = {
      '*': this._getFeatureFallbackPath()
    };
    this.features = {};
    this.services = {};

    if (this.options.loadConfigFromOptions) {
      this.config = this.options.config;
    } else {
      this.configLoader = this.options.disableEnvAwareConfig ? new ConfigLoader(new JsonConfigProvider(path.join(this.configPath, this.configName + '.json')), this) : ConfigLoader.createEnvAwareJsonLoader(this.configPath, this.configName, this.env, this);
      await this.loadConfig_();
    }

    this.emit('configLoaded');

    if (_.isEmpty(this.config)) {
      throw Error('Empty configuration. Nothing to do! Config path: ' + this.configPath);
    }

    await this._loadFeatures_();
    this.emit('ready');
    this.started = true;
    return this;
  }

  async stop_() {
    let elegantStoppers = [];
    this.emit('stopping', elegantStoppers);

    if (elegantStoppers.length > 0) {
      await Promise.all(elegantStoppers);
    }

    this.started = false;
    delete this.services;
    delete this.features;
    delete this._featureRegistry;
    delete this.config;
    delete this.configLoader;
  }

  async loadConfig_() {
    let configVariables = this._getConfigVariables();

    this.config = await this.configLoader.load_(configVariables);
    return this;
  }

  toAbsolutePath(...args) {
    if (args.length === 0) {
      return this.workingPath;
    }

    return path.resolve(this.workingPath, ...args);
  }

  registerService(name, serviceObject, override) {
    if (name in this.services && !override) {
      throw new Error('Service "' + name + '" already registered!');
    }

    this.services[name] = serviceObject;
    this.log('verbose', `Service "${name}" registered.`);
    return this;
  }

  hasService(name) {
    return name in this.services;
  }

  getService(name) {
    return this.services[name];
  }

  enabled(feature) {
    return this.features.hasOwnProperty(feature);
  }

  addFeatureRegistry(registry) {
    if (registry.hasOwnProperty('*')) {
      Util.putIntoBucket(this._featureRegistry, '*', registry['*']);
    }

    Object.assign(this._featureRegistry, _.omit(registry, ['*']));
  }

  log(level, message, ...rest) {
    this.logger && this.logger.log(level, message, ...rest);
    return this;
  }

  _getConfigVariables() {
    return {
      'app': this,
      'log': winston,
      'env': this.env
    };
  }

  _getFeatureFallbackPath() {
    return [path.resolve(__dirname, Literal.FEATURES_PATH), this.toAbsolutePath(Literal.FEATURES_PATH)];
  }

  async _loadFeatures_() {
    let configStageFeatures = [];

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature;

      try {
        feature = this._loadFeature(name);
      } catch (err) {
        console.error(err);
      }

      if (feature && feature.type === Feature.CONF) {
        configStageFeatures.push([name, feature.load_, featureOptions]);
        delete this.config[name];
      }
    });

    if (configStageFeatures.length > 0) {
      configStageFeatures.forEach(([name]) => {
        delete this.config[name];
      });
      await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);
      return this._loadFeatures_();
    }

    let featureGroups = {
      [Feature.INIT]: [],
      [Feature.SERVICE]: [],
      [Feature.PLUGIN]: [],
      [Feature.FINAL]: []
    };

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature = this._loadFeature(name);

      if (!(feature.type in featureGroups)) {
        throw new Error(`Invalid feature type. Feature: ${name}, type: ${feature.type}`);
      }

      featureGroups[feature.type].push([name, feature.load_, featureOptions]);
    });

    return Util.eachAsync_(featureGroups, (group, level) => this._loadFeatureGroup_(group, level));
  }

  async _loadFeatureGroup_(featureGroup, groupLevel) {
    this.emit('before:' + groupLevel);
    this.log('verbose', `Loading "${groupLevel}" feature group ...`);
    await Util.eachAsync_(featureGroup, async ([name, load_, options]) => {
      this.emit('before:load:' + name);
      this.log('verbose', `Loading feature "${name}" ...`);
      await load_(this, options);
      this.features[name].loaded = true;
      this.log('verbose', `Feature "${name}" loaded. [OK]`);
      this.emit('after:load:' + name);
    });
    this.log('verbose', `Finished loading "${groupLevel}" feature group. [OK]`);
    this.emit('after:' + groupLevel);
  }

  _loadFeature(feature) {
    let featureObject = this.features[feature];
    if (featureObject) return featureObject;
    let featurePath;

    if (this._featureRegistry.hasOwnProperty(feature)) {
      let loadOption = this._featureRegistry[feature];

      if (Array.isArray(loadOption)) {
        if (loadOption.length === 0) {
          throw new Error(`Invalid registry value for feature "${feature}".`);
        }

        featurePath = loadOption[0];
        featureObject = require(featurePath);

        if (loadOption.length > 1) {
          featureObject = Util.getValueByPath(featureObject, loadOption[1]);
        }
      } else {
        featurePath = loadOption;
        featureObject = require(featurePath);
      }
    } else {
      let searchingPath = this._featureRegistry['*'];

      let found = _.findLast(searchingPath, p => {
        featurePath = path.join(p, feature + '.js');
        return fs.existsSync(featurePath);
      });

      if (!found) {
        throw new Error(`Don't know where to load feature "${feature}".`);
      }

      featureObject = require(featurePath);
    }

    if (!Feature.validate(featureObject)) {
      throw new Error(`Invalid feature object loaded from "${featurePath}".`);
    }

    this.features[feature] = featureObject;
    return featureObject;
  }

}

module.exports = ServiceContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZXJ2aWNlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiQ29uZmlnTG9hZGVyIiwiSnNvbkNvbmZpZ1Byb3ZpZGVyIiwiXyIsImZzIiwiUHJvbWlzZSIsInBhdGgiLCJFdmVudEVtaXR0ZXIiLCJ3aW5zdG9uIiwiRmVhdHVyZSIsIkxpdGVyYWwiLCJTZXJ2aWNlQ29udGFpbmVyIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ0Vycm9yIiwiZXJyb3IiLCJsb2ciLCJtZXNzYWdlIiwicGljayIsIk9iamVjdCIsImFzc2lnbiIsImVudiIsInByb2Nlc3MiLCJOT0RFX0VOViIsIndvcmtpbmdQYXRoIiwicmVzb2x2ZSIsImN3ZCIsImNvbmZpZ1BhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkRFRkFVTFRfQ09ORklHX1BBVEgiLCJjb25maWdOYW1lIiwiQVBQX0NGR19OQU1FIiwiYmFja2VuZFBhdGgiLCJCQUNLRU5EX1BBVEgiLCJzdGFydF8iLCJfZmVhdHVyZVJlZ2lzdHJ5IiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJmZWF0dXJlcyIsInNlcnZpY2VzIiwibG9hZENvbmZpZ0Zyb21PcHRpb25zIiwiY29uZmlnIiwiY29uZmlnTG9hZGVyIiwiZGlzYWJsZUVudkF3YXJlQ29uZmlnIiwiam9pbiIsImNyZWF0ZUVudkF3YXJlSnNvbkxvYWRlciIsImxvYWRDb25maWdfIiwiZW1pdCIsImlzRW1wdHkiLCJFcnJvciIsIl9sb2FkRmVhdHVyZXNfIiwic3RhcnRlZCIsInN0b3BfIiwiZWxlZ2FudFN0b3BwZXJzIiwibGVuZ3RoIiwiYWxsIiwiY29uZmlnVmFyaWFibGVzIiwiX2dldENvbmZpZ1ZhcmlhYmxlcyIsImxvYWRfIiwiYXJncyIsInJlZ2lzdGVyU2VydmljZSIsInNlcnZpY2VPYmplY3QiLCJvdmVycmlkZSIsImhhc1NlcnZpY2UiLCJnZXRTZXJ2aWNlIiwiZW5hYmxlZCIsImZlYXR1cmUiLCJoYXNPd25Qcm9wZXJ0eSIsImFkZEZlYXR1cmVSZWdpc3RyeSIsInJlZ2lzdHJ5IiwicHV0SW50b0J1Y2tldCIsIm9taXQiLCJsZXZlbCIsInJlc3QiLCJsb2dnZXIiLCJfX2Rpcm5hbWUiLCJGRUFUVVJFU19QQVRIIiwiY29uZmlnU3RhZ2VGZWF0dXJlcyIsImZvck93biIsImZlYXR1cmVPcHRpb25zIiwiYWxsb3dlZEZlYXR1cmVzIiwiaW5kZXhPZiIsIl9sb2FkRmVhdHVyZSIsImVyciIsImNvbnNvbGUiLCJ0eXBlIiwiQ09ORiIsInB1c2giLCJmb3JFYWNoIiwiX2xvYWRGZWF0dXJlR3JvdXBfIiwiZmVhdHVyZUdyb3VwcyIsIklOSVQiLCJTRVJWSUNFIiwiUExVR0lOIiwiRklOQUwiLCJlYWNoQXN5bmNfIiwiZ3JvdXAiLCJmZWF0dXJlR3JvdXAiLCJncm91cExldmVsIiwibG9hZGVkIiwiZmVhdHVyZU9iamVjdCIsImZlYXR1cmVQYXRoIiwibG9hZE9wdGlvbiIsIkFycmF5IiwiaXNBcnJheSIsImdldFZhbHVlQnlQYXRoIiwic2VhcmNoaW5nUGF0aCIsImZvdW5kIiwiZmluZExhc3QiLCJwIiwiZXhpc3RzU3luYyIsInZhbGlkYXRlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBNUI7O0FBQ0EsTUFBTUUsa0JBQWtCLEdBQUdGLE9BQU8sQ0FBQyxrQ0FBRCxDQUFsQzs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQTtBQUFULElBQXFCTixJQUEzQjs7QUFDQSxNQUFNTyxJQUFJLEdBQUdOLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1PLFlBQVksR0FBR1AsT0FBTyxDQUFDLFFBQUQsQ0FBNUI7O0FBQ0EsTUFBTVEsT0FBTyxHQUFHUixPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFFQSxNQUFNUyxPQUFPLEdBQUdULE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFDQSxNQUFNVSxPQUFPLEdBQUdWLE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFPQSxNQUFNVyxnQkFBTixTQUErQkosWUFBL0IsQ0FBNEM7QUFleENLLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCOztBQUR1QixTQWQzQkMsUUFjMkIsR0FkZkMsS0FBRCxJQUFXO0FBQ2xCLGFBQU8sS0FBS0MsR0FBTCxDQUFTLE9BQVQsRUFBa0JELEtBQUssQ0FBQ0UsT0FBeEIsRUFBaUNmLENBQUMsQ0FBQ2dCLElBQUYsQ0FBT0gsS0FBUCxFQUFjLENBQUUsTUFBRixFQUFVLFFBQVYsRUFBb0IsTUFBcEIsRUFBNEIsV0FBNUIsRUFBeUMsT0FBekMsQ0FBZCxDQUFqQyxDQUFQO0FBQ0gsS0FZMEI7O0FBT3ZCLFNBQUtILElBQUwsR0FBWUEsSUFBWjtBQU1BLFNBQUtDLE9BQUwsR0FBZU0sTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUVaUCxPQUZZLENBQWY7QUFRQSxTQUFLUSxHQUFMLEdBQVcsS0FBS1IsT0FBTCxDQUFhUSxHQUFiLElBQW9CQyxPQUFPLENBQUNELEdBQVIsQ0FBWUUsUUFBaEMsSUFBNEMsYUFBdkQ7QUFNQSxTQUFLQyxXQUFMLEdBQW1CLEtBQUtYLE9BQUwsQ0FBYVcsV0FBYixHQUEyQm5CLElBQUksQ0FBQ29CLE9BQUwsQ0FBYSxLQUFLWixPQUFMLENBQWFXLFdBQTFCLENBQTNCLEdBQW9FRixPQUFPLENBQUNJLEdBQVIsRUFBdkY7QUFNQSxTQUFLQyxVQUFMLEdBQWtCLEtBQUtDLGNBQUwsQ0FBb0IsS0FBS2YsT0FBTCxDQUFhYyxVQUFiLElBQTJCbEIsT0FBTyxDQUFDb0IsbUJBQXZELENBQWxCO0FBTUEsU0FBS0MsVUFBTCxHQUFrQixLQUFLakIsT0FBTCxDQUFhaUIsVUFBYixJQUEyQnJCLE9BQU8sQ0FBQ3NCLFlBQXJEO0FBTUEsU0FBS0MsV0FBTCxHQUFtQixLQUFLSixjQUFMLENBQW9CLEtBQUtmLE9BQUwsQ0FBYW1CLFdBQWIsSUFBNEJ2QixPQUFPLENBQUN3QixZQUF4RCxDQUFuQjtBQUNIOztBQVFELFFBQU1DLE1BQU4sR0FBZTtBQUNYLFNBQUtDLGdCQUFMLEdBQXdCO0FBRXBCLFdBQUssS0FBS0MsdUJBQUw7QUFGZSxLQUF4QjtBQVFBLFNBQUtDLFFBQUwsR0FBZ0IsRUFBaEI7QUFLQSxTQUFLQyxRQUFMLEdBQWdCLEVBQWhCOztBQUVBLFFBQUksS0FBS3pCLE9BQUwsQ0FBYTBCLHFCQUFqQixFQUF3QztBQUNwQyxXQUFLQyxNQUFMLEdBQWMsS0FBSzNCLE9BQUwsQ0FBYTJCLE1BQTNCO0FBQ0gsS0FGRCxNQUVPO0FBS0gsV0FBS0MsWUFBTCxHQUFvQixLQUFLNUIsT0FBTCxDQUFhNkIscUJBQWIsR0FDaEIsSUFBSTFDLFlBQUosQ0FBaUIsSUFBSUMsa0JBQUosQ0FBdUJJLElBQUksQ0FBQ3NDLElBQUwsQ0FBVSxLQUFLaEIsVUFBZixFQUEyQixLQUFLRyxVQUFMLEdBQWtCLE9BQTdDLENBQXZCLENBQWpCLEVBQWdHLElBQWhHLENBRGdCLEdBRWhCOUIsWUFBWSxDQUFDNEMsd0JBQWIsQ0FBc0MsS0FBS2pCLFVBQTNDLEVBQXVELEtBQUtHLFVBQTVELEVBQXdFLEtBQUtULEdBQTdFLEVBQWtGLElBQWxGLENBRko7QUFJQSxZQUFNLEtBQUt3QixXQUFMLEVBQU47QUFDSDs7QUFNRCxTQUFLQyxJQUFMLENBQVUsY0FBVjs7QUFFQSxRQUFJNUMsQ0FBQyxDQUFDNkMsT0FBRixDQUFVLEtBQUtQLE1BQWYsQ0FBSixFQUE0QjtBQUN4QixZQUFNUSxLQUFLLENBQUMsc0RBQXNELEtBQUtyQixVQUE1RCxDQUFYO0FBQ0g7O0FBRUQsVUFBTSxLQUFLc0IsY0FBTCxFQUFOO0FBTUEsU0FBS0gsSUFBTCxDQUFVLE9BQVY7QUFNQSxTQUFLSSxPQUFMLEdBQWUsSUFBZjtBQUVBLFdBQU8sSUFBUDtBQUNIOztBQU9ELFFBQU1DLEtBQU4sR0FBYztBQUNWLFFBQUlDLGVBQWUsR0FBRyxFQUF0QjtBQU1BLFNBQUtOLElBQUwsQ0FBVSxVQUFWLEVBQXNCTSxlQUF0Qjs7QUFFQSxRQUFJQSxlQUFlLENBQUNDLE1BQWhCLEdBQXlCLENBQTdCLEVBQWdDO0FBQzVCLFlBQU1qRCxPQUFPLENBQUNrRCxHQUFSLENBQVlGLGVBQVosQ0FBTjtBQUNIOztBQUVELFNBQUtGLE9BQUwsR0FBZSxLQUFmO0FBRUEsV0FBTyxLQUFLWixRQUFaO0FBQ0EsV0FBTyxLQUFLRCxRQUFaO0FBQ0EsV0FBTyxLQUFLRixnQkFBWjtBQUVBLFdBQU8sS0FBS0ssTUFBWjtBQUNBLFdBQU8sS0FBS0MsWUFBWjtBQUNIOztBQUtELFFBQU1JLFdBQU4sR0FBb0I7QUFDaEIsUUFBSVUsZUFBZSxHQUFHLEtBQUtDLG1CQUFMLEVBQXRCOztBQU1BLFNBQUtoQixNQUFMLEdBQWMsTUFBTSxLQUFLQyxZQUFMLENBQWtCZ0IsS0FBbEIsQ0FBd0JGLGVBQXhCLENBQXBCO0FBRUEsV0FBTyxJQUFQO0FBQ0g7O0FBT0QzQixFQUFBQSxjQUFjLENBQUMsR0FBRzhCLElBQUosRUFBVTtBQUNwQixRQUFJQSxJQUFJLENBQUNMLE1BQUwsS0FBZ0IsQ0FBcEIsRUFBdUI7QUFDbkIsYUFBTyxLQUFLN0IsV0FBWjtBQUNIOztBQUVELFdBQU9uQixJQUFJLENBQUNvQixPQUFMLENBQWEsS0FBS0QsV0FBbEIsRUFBK0IsR0FBR2tDLElBQWxDLENBQVA7QUFDSDs7QUFRREMsRUFBQUEsZUFBZSxDQUFDL0MsSUFBRCxFQUFPZ0QsYUFBUCxFQUFzQkMsUUFBdEIsRUFBZ0M7QUFDM0MsUUFBSWpELElBQUksSUFBSSxLQUFLMEIsUUFBYixJQUF5QixDQUFDdUIsUUFBOUIsRUFBd0M7QUFDcEMsWUFBTSxJQUFJYixLQUFKLENBQVUsY0FBYXBDLElBQWIsR0FBbUIsdUJBQTdCLENBQU47QUFDSDs7QUFFRCxTQUFLMEIsUUFBTCxDQUFjMUIsSUFBZCxJQUFzQmdELGFBQXRCO0FBQ0EsU0FBSzVDLEdBQUwsQ0FBUyxTQUFULEVBQXFCLFlBQVdKLElBQUssZUFBckM7QUFDQSxXQUFPLElBQVA7QUFDSDs7QUFPRGtELEVBQUFBLFVBQVUsQ0FBQ2xELElBQUQsRUFBTztBQUNiLFdBQU9BLElBQUksSUFBSSxLQUFLMEIsUUFBcEI7QUFDSDs7QUFPRHlCLEVBQUFBLFVBQVUsQ0FBQ25ELElBQUQsRUFBTztBQUNiLFdBQU8sS0FBSzBCLFFBQUwsQ0FBYzFCLElBQWQsQ0FBUDtBQUNIOztBQU9Eb0QsRUFBQUEsT0FBTyxDQUFDQyxPQUFELEVBQVU7QUFDYixXQUFPLEtBQUs1QixRQUFMLENBQWM2QixjQUFkLENBQTZCRCxPQUE3QixDQUFQO0FBQ0g7O0FBTURFLEVBQUFBLGtCQUFrQixDQUFDQyxRQUFELEVBQVc7QUFFekIsUUFBSUEsUUFBUSxDQUFDRixjQUFULENBQXdCLEdBQXhCLENBQUosRUFBa0M7QUFDOUJwRSxNQUFBQSxJQUFJLENBQUN1RSxhQUFMLENBQW1CLEtBQUtsQyxnQkFBeEIsRUFBMEMsR0FBMUMsRUFBK0NpQyxRQUFRLENBQUMsR0FBRCxDQUF2RDtBQUNIOztBQUVEakQsSUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWMsS0FBS2UsZ0JBQW5CLEVBQXFDakMsQ0FBQyxDQUFDb0UsSUFBRixDQUFPRixRQUFQLEVBQWlCLENBQUMsR0FBRCxDQUFqQixDQUFyQztBQUNIOztBQVNEcEQsRUFBQUEsR0FBRyxDQUFDdUQsS0FBRCxFQUFRdEQsT0FBUixFQUFpQixHQUFHdUQsSUFBcEIsRUFBMEI7QUFDekIsU0FBS0MsTUFBTCxJQUFlLEtBQUtBLE1BQUwsQ0FBWXpELEdBQVosQ0FBZ0J1RCxLQUFoQixFQUF1QnRELE9BQXZCLEVBQWdDLEdBQUd1RCxJQUFuQyxDQUFmO0FBQ0EsV0FBTyxJQUFQO0FBQ0g7O0FBRURoQixFQUFBQSxtQkFBbUIsR0FBRztBQUNsQixXQUFPO0FBQ0gsYUFBTyxJQURKO0FBRUgsYUFBT2pELE9BRko7QUFHSCxhQUFPLEtBQUtjO0FBSFQsS0FBUDtBQUtIOztBQUVEZSxFQUFBQSx1QkFBdUIsR0FBRztBQUN0QixXQUFPLENBQUUvQixJQUFJLENBQUNvQixPQUFMLENBQWFpRCxTQUFiLEVBQXdCakUsT0FBTyxDQUFDa0UsYUFBaEMsQ0FBRixFQUFrRCxLQUFLL0MsY0FBTCxDQUFvQm5CLE9BQU8sQ0FBQ2tFLGFBQTVCLENBQWxELENBQVA7QUFDSDs7QUFPRCxRQUFNMUIsY0FBTixHQUF1QjtBQUVuQixRQUFJMkIsbUJBQW1CLEdBQUcsRUFBMUI7O0FBR0ExRSxJQUFBQSxDQUFDLENBQUMyRSxNQUFGLENBQVMsS0FBS3JDLE1BQWQsRUFBc0IsQ0FBQ3NDLGNBQUQsRUFBaUJsRSxJQUFqQixLQUEwQjtBQUM1QyxVQUFJLEtBQUtDLE9BQUwsQ0FBYWtFLGVBQWIsSUFDQSxLQUFLbEUsT0FBTCxDQUFha0UsZUFBYixDQUE2QkMsT0FBN0IsQ0FBcUNwRSxJQUFyQyxNQUErQyxDQUFDLENBRHBELEVBQ3VEO0FBRW5EO0FBQ0g7O0FBRUQsVUFBSXFELE9BQUo7O0FBQ0EsVUFBSTtBQUNBQSxRQUFBQSxPQUFPLEdBQUcsS0FBS2dCLFlBQUwsQ0FBa0JyRSxJQUFsQixDQUFWO0FBQ0gsT0FGRCxDQUVFLE9BQU9zRSxHQUFQLEVBQVk7QUFDVkMsUUFBQUEsT0FBTyxDQUFDcEUsS0FBUixDQUFjbUUsR0FBZDtBQUNIOztBQUVELFVBQUlqQixPQUFPLElBQUlBLE9BQU8sQ0FBQ21CLElBQVIsS0FBaUI1RSxPQUFPLENBQUM2RSxJQUF4QyxFQUE4QztBQUMxQ1QsUUFBQUEsbUJBQW1CLENBQUNVLElBQXBCLENBQXlCLENBQUUxRSxJQUFGLEVBQVFxRCxPQUFPLENBQUNSLEtBQWhCLEVBQXVCcUIsY0FBdkIsQ0FBekI7QUFDQSxlQUFPLEtBQUt0QyxNQUFMLENBQVk1QixJQUFaLENBQVA7QUFDSDtBQUNKLEtBbEJEOztBQW9CQSxRQUFJZ0UsbUJBQW1CLENBQUN2QixNQUFwQixHQUE2QixDQUFqQyxFQUFvQztBQUVoQ3VCLE1BQUFBLG1CQUFtQixDQUFDVyxPQUFwQixDQUE0QixDQUFDLENBQUUzRSxJQUFGLENBQUQsS0FBYztBQUFFLGVBQU8sS0FBSzRCLE1BQUwsQ0FBWTVCLElBQVosQ0FBUDtBQUEyQixPQUF2RTtBQUVBLFlBQU0sS0FBSzRFLGtCQUFMLENBQXdCWixtQkFBeEIsRUFBNkNwRSxPQUFPLENBQUM2RSxJQUFyRCxDQUFOO0FBR0EsYUFBTyxLQUFLcEMsY0FBTCxFQUFQO0FBQ0g7O0FBRUQsUUFBSXdDLGFBQWEsR0FBRztBQUNoQixPQUFDakYsT0FBTyxDQUFDa0YsSUFBVCxHQUFnQixFQURBO0FBRWhCLE9BQUNsRixPQUFPLENBQUNtRixPQUFULEdBQW1CLEVBRkg7QUFHaEIsT0FBQ25GLE9BQU8sQ0FBQ29GLE1BQVQsR0FBa0IsRUFIRjtBQUloQixPQUFDcEYsT0FBTyxDQUFDcUYsS0FBVCxHQUFpQjtBQUpELEtBQXBCOztBQVFBM0YsSUFBQUEsQ0FBQyxDQUFDMkUsTUFBRixDQUFTLEtBQUtyQyxNQUFkLEVBQXNCLENBQUNzQyxjQUFELEVBQWlCbEUsSUFBakIsS0FBMEI7QUFDNUMsVUFBSSxLQUFLQyxPQUFMLENBQWFrRSxlQUFiLElBQ0EsS0FBS2xFLE9BQUwsQ0FBYWtFLGVBQWIsQ0FBNkJDLE9BQTdCLENBQXFDcEUsSUFBckMsTUFBK0MsQ0FBQyxDQURwRCxFQUN1RDtBQUVuRDtBQUNIOztBQUVELFVBQUlxRCxPQUFPLEdBQUcsS0FBS2dCLFlBQUwsQ0FBa0JyRSxJQUFsQixDQUFkOztBQUVBLFVBQUksRUFBRXFELE9BQU8sQ0FBQ21CLElBQVIsSUFBZ0JLLGFBQWxCLENBQUosRUFBc0M7QUFDbEMsY0FBTSxJQUFJekMsS0FBSixDQUFXLGtDQUFpQ3BDLElBQUssV0FBVXFELE9BQU8sQ0FBQ21CLElBQUssRUFBeEUsQ0FBTjtBQUNIOztBQUVESyxNQUFBQSxhQUFhLENBQUN4QixPQUFPLENBQUNtQixJQUFULENBQWIsQ0FBNEJFLElBQTVCLENBQWlDLENBQUUxRSxJQUFGLEVBQVFxRCxPQUFPLENBQUNSLEtBQWhCLEVBQXVCcUIsY0FBdkIsQ0FBakM7QUFDSCxLQWREOztBQWdCQSxXQUFPaEYsSUFBSSxDQUFDZ0csVUFBTCxDQUFnQkwsYUFBaEIsRUFBK0IsQ0FBQ00sS0FBRCxFQUFReEIsS0FBUixLQUFrQixLQUFLaUIsa0JBQUwsQ0FBd0JPLEtBQXhCLEVBQStCeEIsS0FBL0IsQ0FBakQsQ0FBUDtBQUNIOztBQUVELFFBQU1pQixrQkFBTixDQUF5QlEsWUFBekIsRUFBdUNDLFVBQXZDLEVBQW1EO0FBQy9DLFNBQUtuRCxJQUFMLENBQVUsWUFBWW1ELFVBQXRCO0FBQ0EsU0FBS2pGLEdBQUwsQ0FBUyxTQUFULEVBQXFCLFlBQVdpRixVQUFXLHFCQUEzQztBQUNBLFVBQU1uRyxJQUFJLENBQUNnRyxVQUFMLENBQWdCRSxZQUFoQixFQUE4QixPQUFPLENBQUVwRixJQUFGLEVBQVE2QyxLQUFSLEVBQWU1QyxPQUFmLENBQVAsS0FBb0M7QUFDcEUsV0FBS2lDLElBQUwsQ0FBVSxpQkFBaUJsQyxJQUEzQjtBQUNBLFdBQUtJLEdBQUwsQ0FBUyxTQUFULEVBQXFCLG9CQUFtQkosSUFBSyxPQUE3QztBQUVBLFlBQU02QyxLQUFLLENBQUMsSUFBRCxFQUFPNUMsT0FBUCxDQUFYO0FBQ0EsV0FBS3dCLFFBQUwsQ0FBY3pCLElBQWQsRUFBb0JzRixNQUFwQixHQUE2QixJQUE3QjtBQUVBLFdBQUtsRixHQUFMLENBQVMsU0FBVCxFQUFxQixZQUFXSixJQUFLLGdCQUFyQztBQUNBLFdBQUtrQyxJQUFMLENBQVUsZ0JBQWdCbEMsSUFBMUI7QUFDSCxLQVRLLENBQU47QUFVQSxTQUFLSSxHQUFMLENBQVMsU0FBVCxFQUFxQixxQkFBb0JpRixVQUFXLHVCQUFwRDtBQUNBLFNBQUtuRCxJQUFMLENBQVUsV0FBV21ELFVBQXJCO0FBQ0g7O0FBUURoQixFQUFBQSxZQUFZLENBQUNoQixPQUFELEVBQVU7QUFDbEIsUUFBSWtDLGFBQWEsR0FBRyxLQUFLOUQsUUFBTCxDQUFjNEIsT0FBZCxDQUFwQjtBQUNBLFFBQUlrQyxhQUFKLEVBQW1CLE9BQU9BLGFBQVA7QUFFbkIsUUFBSUMsV0FBSjs7QUFFQSxRQUFJLEtBQUtqRSxnQkFBTCxDQUFzQitCLGNBQXRCLENBQXFDRCxPQUFyQyxDQUFKLEVBQW1EO0FBRS9DLFVBQUlvQyxVQUFVLEdBQUcsS0FBS2xFLGdCQUFMLENBQXNCOEIsT0FBdEIsQ0FBakI7O0FBRUEsVUFBSXFDLEtBQUssQ0FBQ0MsT0FBTixDQUFjRixVQUFkLENBQUosRUFBK0I7QUFDM0IsWUFBSUEsVUFBVSxDQUFDaEQsTUFBWCxLQUFzQixDQUExQixFQUE2QjtBQUN6QixnQkFBTSxJQUFJTCxLQUFKLENBQVcsdUNBQXNDaUIsT0FBUSxJQUF6RCxDQUFOO0FBQ0g7O0FBRURtQyxRQUFBQSxXQUFXLEdBQUdDLFVBQVUsQ0FBQyxDQUFELENBQXhCO0FBQ0FGLFFBQUFBLGFBQWEsR0FBR3BHLE9BQU8sQ0FBQ3FHLFdBQUQsQ0FBdkI7O0FBRUEsWUFBSUMsVUFBVSxDQUFDaEQsTUFBWCxHQUFvQixDQUF4QixFQUEyQjtBQUV2QjhDLFVBQUFBLGFBQWEsR0FBR3JHLElBQUksQ0FBQzBHLGNBQUwsQ0FBb0JMLGFBQXBCLEVBQW1DRSxVQUFVLENBQUMsQ0FBRCxDQUE3QyxDQUFoQjtBQUNIO0FBQ0osT0FaRCxNQVlPO0FBQ0hELFFBQUFBLFdBQVcsR0FBR0MsVUFBZDtBQUNBRixRQUFBQSxhQUFhLEdBQUdwRyxPQUFPLENBQUNxRyxXQUFELENBQXZCO0FBQ0g7QUFDSixLQXBCRCxNQW9CTztBQUVILFVBQUlLLGFBQWEsR0FBRyxLQUFLdEUsZ0JBQUwsQ0FBc0IsR0FBdEIsQ0FBcEI7O0FBR0EsVUFBSXVFLEtBQUssR0FBR3hHLENBQUMsQ0FBQ3lHLFFBQUYsQ0FBV0YsYUFBWCxFQUEwQkcsQ0FBQyxJQUFJO0FBQ3ZDUixRQUFBQSxXQUFXLEdBQUcvRixJQUFJLENBQUNzQyxJQUFMLENBQVVpRSxDQUFWLEVBQWEzQyxPQUFPLEdBQUcsS0FBdkIsQ0FBZDtBQUNBLGVBQU85RCxFQUFFLENBQUMwRyxVQUFILENBQWNULFdBQWQsQ0FBUDtBQUNILE9BSFcsQ0FBWjs7QUFLQSxVQUFJLENBQUNNLEtBQUwsRUFBWTtBQUNSLGNBQU0sSUFBSTFELEtBQUosQ0FBVyxxQ0FBb0NpQixPQUFRLElBQXZELENBQU47QUFDSDs7QUFFRGtDLE1BQUFBLGFBQWEsR0FBR3BHLE9BQU8sQ0FBQ3FHLFdBQUQsQ0FBdkI7QUFDSDs7QUFFRCxRQUFJLENBQUM1RixPQUFPLENBQUNzRyxRQUFSLENBQWlCWCxhQUFqQixDQUFMLEVBQXNDO0FBQ2xDLFlBQU0sSUFBSW5ELEtBQUosQ0FBVyx1Q0FBc0NvRCxXQUFZLElBQTdELENBQU47QUFDSDs7QUFFRCxTQUFLL0QsUUFBTCxDQUFjNEIsT0FBZCxJQUF5QmtDLGFBQXpCO0FBQ0EsV0FBT0EsYUFBUDtBQUNIOztBQWpadUM7O0FBb1o1Q1ksTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEcsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgQ29uZmlnTG9hZGVyID0gcmVxdWlyZSgncmstY29uZmlnJyk7XG5jb25zdCBKc29uQ29uZmlnUHJvdmlkZXIgPSByZXF1aXJlKCdyay1jb25maWcvbGliL0pzb25Db25maWdQcm92aWRlcicpO1xuY29uc3QgeyBfLCBmcywgUHJvbWlzZSB9ID0gVXRpbDtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJyk7XG5cbmNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuL2VudW0vRmVhdHVyZScpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5cbi8qKlxuICogU2VydmljZSBjb250YWluZXIgY2xhc3MuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIEV2ZW50RW1pdHRlciAgICAgXG4gKi9cbmNsYXNzIFNlcnZpY2VDb250YWluZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGxvZ0Vycm9yID0gKGVycm9yKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZygnZXJyb3InLCBlcnJvci5tZXNzYWdlLCBfLnBpY2soZXJyb3IsIFsgJ25hbWUnLCAnc3RhdHVzJywgJ2NvZGUnLCAnZXh0cmFJbmZvJywgJ3N0YWNrJyBdKSk7XG4gICAgfVxuXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBjb250YWluZXIgaW5zdGFuY2UuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gQ29udGFpbmVyIG9wdGlvbnMgICAgICAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmVudl0gLSBFbnZpcm9ubWVudCwgZGVmYXVsdCB0byBwcm9jZXNzLmVudi5OT0RFX0VOVlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy53b3JraW5nUGF0aF0gLSBBcHAncyB3b3JraW5nIHBhdGgsIGRlZmF1bHQgdG8gcHJvY2Vzcy5jd2QoKVxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdQYXRoXSAtIEFwcCdzIGNvbmZpZyBwYXRoLCBkZWZhdWx0IHRvIFwiY29uZlwiIHVuZGVyIHdvcmtpbmdQYXRoXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNvbmZpZ05hbWVdIC0gQXBwJ3MgY29uZmlnIGJhc2VuYW1lLCBkZWZhdWx0IHRvIFwiYXBwXCJcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuZGlzYWJsZUVudkF3YXJlQ29uZmlnPWZhbHNlXSAtIERvbid0IHVzZSBlbnZpcm9ubWVudC1hd2FyZSBjb25maWdcbiAgICAgKiBAcHJvcGVydHkge2FycmF5fSBbb3B0aW9ucy5hbGxvd2VkRmVhdHVyZXNdIC0gQSBsaXN0IG9mIGVuYWJsZWQgZmVhdHVyZSBuYW1lc1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTmFtZSBvZiB0aGUgYXBwXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOyAgICAgICAgICAgICAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIG9wdGlvbnNcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgICAvLy4uLiBkZWZhdWx0IG9wdGlvbnMgICAgICAgICAgICBcbiAgICAgICAgfSwgb3B0aW9ucyk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVudmlyb25tZW50IGZsYWdcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVudiA9IHRoaXMub3B0aW9ucy5lbnYgfHwgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgXCJkZXZlbG9wbWVudFwiO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBXb3JraW5nIGRpcmVjdG9yeSBvZiB0aGlzIGNsaSBhcHBcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy53b3JraW5nUGF0aCA9IHRoaXMub3B0aW9ucy53b3JraW5nUGF0aCA/IHBhdGgucmVzb2x2ZSh0aGlzLm9wdGlvbnMud29ya2luZ1BhdGgpIDogcHJvY2Vzcy5jd2QoKTsgICAgIFxuICAgICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbmZpZyBwYXRoXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmNvbmZpZ1BhdGggfHwgTGl0ZXJhbC5ERUZBVUxUX0NPTkZJR19QQVRIKTsgICAgICBcbiAgICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDb25maWcgYmFzZW5hbWVcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWdOYW1lID0gdGhpcy5vcHRpb25zLmNvbmZpZ05hbWUgfHwgTGl0ZXJhbC5BUFBfQ0ZHX05BTUU7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEJhY2tlbmQgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuYmFja2VuZFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5iYWNrZW5kUGF0aCB8fCBMaXRlcmFsLkJBQ0tFTkRfUEFUSCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIGNvbnRhaW5lci5cbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNjb25maWdMb2FkZWRcbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNyZWFkeVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxTZXJ2aWNlQ29udGFpbmVyPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdGFydF8oKSB7ICAgICAgICAgICAgXG4gICAgICAgIHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSA9IHtcbiAgICAgICAgICAgIC8vZmlyc3RseSBsb29rIHVwIFwiZmVhdHVyZXNcIiB1bmRlciBjdXJyZW50IHdvcmtpbmcgcGF0aCwgYW5kIHRoZW4gdHJ5IHRoZSBidWlsdGluIGZlYXR1cmVzIHBhdGhcbiAgICAgICAgICAgICcqJzogdGhpcy5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpXG4gICAgICAgIH07XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMb2FkZWQgZmVhdHVyZXMsIG5hbWUgPT4gZmVhdHVyZSBvYmplY3RcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHt9O1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9hZGVkIHNlcnZpY2VzXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2VydmljZXMgPSB7fTsgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvYWRDb25maWdGcm9tT3B0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5jb25maWcgPSB0aGlzLm9wdGlvbnMuY29uZmlnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBDb25maWd1cmF0aW9uIGxvYWRlciBpbnN0YW5jZVxuICAgICAgICAgICAgICogQG1lbWJlciB7Q29uZmlnTG9hZGVyfSAgICAgICAgIFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ0xvYWRlciA9IHRoaXMub3B0aW9ucy5kaXNhYmxlRW52QXdhcmVDb25maWcgPyBcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlnTG9hZGVyKG5ldyBKc29uQ29uZmlnUHJvdmlkZXIocGF0aC5qb2luKHRoaXMuY29uZmlnUGF0aCwgdGhpcy5jb25maWdOYW1lICsgJy5qc29uJykpLCB0aGlzKSA6IFxuICAgICAgICAgICAgICAgIENvbmZpZ0xvYWRlci5jcmVhdGVFbnZBd2FyZUpzb25Mb2FkZXIodGhpcy5jb25maWdQYXRoLCB0aGlzLmNvbmZpZ05hbWUsIHRoaXMuZW52LCB0aGlzKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ29uZmlnXygpOyAgICAgXG4gICAgICAgIH0gICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIGxvYWRlZCBldmVudC5cbiAgICAgICAgICogQGV2ZW50IFNlcnZpY2VDb250YWluZXIjY29uZmlnTG9hZGVkXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVtaXQoJ2NvbmZpZ0xvYWRlZCcpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkodGhpcy5jb25maWcpKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignRW1wdHkgY29uZmlndXJhdGlvbi4gTm90aGluZyB0byBkbyEgQ29uZmlnIHBhdGg6ICcgKyB0aGlzLmNvbmZpZ1BhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZlYXR1cmVzXygpOyBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIHJlYWR5XG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI3JlYWR5XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5Jyk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZsYWcgc2hvd2luZyB0aGUgYXBwIGlzIHN0YXJ0ZWQgb3Igbm90LlxuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIGNvbnRhaW5lclxuICAgICAqIEBmaXJlcyBTZXJ2aWNlQ29udGFpbmVyI3N0b3BwaW5nXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPFNlcnZpY2VDb250YWluZXI+fVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBsZXQgZWxlZ2FudFN0b3BwZXJzID0gW107XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBzdG9wcGluZ1xuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdzdG9wcGluZycsIGVsZWdhbnRTdG9wcGVycyk7XG5cbiAgICAgICAgaWYgKGVsZWdhbnRTdG9wcGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChlbGVnYW50U3RvcHBlcnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuc2VydmljZXM7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmZlYXR1cmVzO1xuICAgICAgICBkZWxldGUgdGhpcy5fZmVhdHVyZVJlZ2lzdHJ5O1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZztcbiAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnTG9hZGVyOyAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICovXG4gICAgYXN5bmMgbG9hZENvbmZpZ18oKSB7XG4gICAgICAgIGxldCBjb25maWdWYXJpYWJsZXMgPSB0aGlzLl9nZXRDb25maWdWYXJpYWJsZXMoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIGNvbmZpZ3VyYXRpb25cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWcgPSBhd2FpdCB0aGlzLmNvbmZpZ0xvYWRlci5sb2FkXyhjb25maWdWYXJpYWJsZXMpOyAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhIHJlbGF0aXZlIHBhdGggb2YgdGhpcyBhcHAgbW9kdWxlIHRvIGFuIGFic29sdXRlIHBhdGggICAgIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGFyZ3MgLSBBcnJheSBvZiBwYXRoIHBhcnRzXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICB0b0Fic29sdXRlUGF0aCguLi5hcmdzKSB7XG4gICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMud29ya2luZ1BhdGg7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHBhdGgucmVzb2x2ZSh0aGlzLndvcmtpbmdQYXRoLCAuLi5hcmdzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciBhIHNlcnZpY2UgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNlcnZpY2VPYmplY3RcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG92ZXJyaWRlXG4gICAgICovXG4gICAgcmVnaXN0ZXJTZXJ2aWNlKG5hbWUsIHNlcnZpY2VPYmplY3QsIG92ZXJyaWRlKSB7XG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMuc2VydmljZXMgJiYgIW92ZXJyaWRlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlcnZpY2UgXCInKyBuYW1lICsnXCIgYWxyZWFkeSByZWdpc3RlcmVkIScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXJ2aWNlc1tuYW1lXSA9IHNlcnZpY2VPYmplY3Q7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFNlcnZpY2UgXCIke25hbWV9XCIgcmVnaXN0ZXJlZC5gKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIHNlcnZpY2UgZXhpc3RzXG4gICAgICogQHBhcmFtIHsqfSBuYW1lIFxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc1NlcnZpY2UobmFtZSkge1xuICAgICAgICByZXR1cm4gbmFtZSBpbiB0aGlzLnNlcnZpY2VzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIHNlcnZpY2UgZnJvbSBtb2R1bGUgaGllcmFyY2h5ICAgICBcbiAgICAgKiBAcGFyYW0gbmFtZVxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0U2VydmljZShuYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VzW25hbWVdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBmZWF0dXJlIGlzIGVuYWJsZWQgaW4gdGhlIGFwcC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmVhdHVyZSBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbH1cbiAgICAgKi9cbiAgICBlbmFibGVkKGZlYXR1cmUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMuaGFzT3duUHJvcGVydHkoZmVhdHVyZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIG1vcmUgb3Igb3ZlcmlkZSBjdXJyZW50IGZlYXR1cmUgcmVnaXN0cnlcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVnaXN0cnkgXG4gICAgICovXG4gICAgYWRkRmVhdHVyZVJlZ2lzdHJ5KHJlZ2lzdHJ5KSB7XG4gICAgICAgIC8vICogaXMgdXNlZCBhcyB0aGUgZmFsbGJhY2sgbG9jYXRpb24gdG8gZmluZCBhIGZlYXR1cmVcbiAgICAgICAgaWYgKHJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KCcqJykpIHtcbiAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldCh0aGlzLl9mZWF0dXJlUmVnaXN0cnksICcqJywgcmVnaXN0cnlbJyonXSk7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSwgXy5vbWl0KHJlZ2lzdHJ5LCBbJyonXSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmF1bHQgbG9nIG1ldGhvZCwgbWF5IGJlIG92ZXJyaWRlIGJ5IGxvZ2dlcnMgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIExvZyBsZXZlbFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIExvZyBtZXNzYWdlXG4gICAgICogQHBhcmFtIHsuLi5vYmplY3R9IC0gRXh0cmEgbWV0YSBkYXRhXG4gICAgICogQHJldHVybnMge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICovXG4gICAgbG9nKGxldmVsLCBtZXNzYWdlLCAuLi5yZXN0KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyICYmIHRoaXMubG9nZ2VyLmxvZyhsZXZlbCwgbWVzc2FnZSwgLi4ucmVzdCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIF9nZXRDb25maWdWYXJpYWJsZXMoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnYXBwJzogdGhpcywgICAgICAgICAgICBcbiAgICAgICAgICAgICdsb2cnOiB3aW5zdG9uLFxuICAgICAgICAgICAgJ2Vudic6IHRoaXMuZW52XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIHJldHVybiBbIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuRkVBVFVSRVNfUEFUSCksIHRoaXMudG9BYnNvbHV0ZVBhdGgoTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBMb2FkIGZlYXR1cmVzXG4gICAgICogQHByaXZhdGUgICAgIFxuICAgICAqIEByZXR1cm5zIHtib29sfVxuICAgICAqL1xuICAgIGFzeW5jIF9sb2FkRmVhdHVyZXNfKCkgeyAgICAgICBcbiAgICAgICAgLy8gcnVuIGNvbmZpZyBzdGFnZSBzZXBhcmF0ZWx5IGZpcnN0XG4gICAgICAgIGxldCBjb25maWdTdGFnZUZlYXR1cmVzID0gW107ICAgICAgICBcblxuICAgICAgICAvLyBsb2FkIGZlYXR1cmVzXG4gICAgICAgIF8uZm9yT3duKHRoaXMuY29uZmlnLCAoZmVhdHVyZU9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWxsb3dlZEZlYXR1cmVzICYmXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcy5pbmRleE9mKG5hbWUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIC8vc2tpcCBkaXNhYmxlZCBmZWF0dXJlc1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZlYXR1cmU7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGZlYXR1cmUgPSB0aGlzLl9sb2FkRmVhdHVyZShuYW1lKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7ICAgICBcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7ICAgICAgICAgICBcbiAgICAgICAgICAgIH0gICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGZlYXR1cmUgJiYgZmVhdHVyZS50eXBlID09PSBGZWF0dXJlLkNPTkYpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uZmlnU3RhZ2VGZWF0dXJlcy5wdXNoKFsgbmFtZSwgZmVhdHVyZS5sb2FkXywgZmVhdHVyZU9wdGlvbnMgXSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnW25hbWVdO1xuICAgICAgICAgICAgfSAgICBcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmIChjb25maWdTdGFnZUZlYXR1cmVzLmxlbmd0aCA+IDApIHsgICAgICBcbiAgICAgICAgICAgIC8vY29uZmlndXJhdGlvbiBmZWF0dXJlcyB3aWxsIGJlIG92ZXJyaWRlZCBieSBuZXdseSBsb2FkZWQgY29uZmlnXG4gICAgICAgICAgICBjb25maWdTdGFnZUZlYXR1cmVzLmZvckVhY2goKFsgbmFtZSBdKSA9PiB7IGRlbGV0ZSB0aGlzLmNvbmZpZ1tuYW1lXTsgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGZWF0dXJlR3JvdXBfKGNvbmZpZ1N0YWdlRmVhdHVyZXMsIEZlYXR1cmUuQ09ORik7XG5cbiAgICAgICAgICAgIC8vcmVsb2FkIGFsbCBmZWF0dXJlcyBpZiBhbnkgdHlwZSBvZiBjb25maWd1cmF0aW9uIGZlYXR1cmUgZXhpc3RzICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9hZEZlYXR1cmVzXygpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZlYXR1cmVHcm91cHMgPSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBbRmVhdHVyZS5JTklUXTogW10sICAgICAgICAgICAgXG4gICAgICAgICAgICBbRmVhdHVyZS5TRVJWSUNFXTogW10sICAgICAgICAgICAgXG4gICAgICAgICAgICBbRmVhdHVyZS5QTFVHSU5dOiBbXSxcbiAgICAgICAgICAgIFtGZWF0dXJlLkZJTkFMXTogW11cbiAgICAgICAgfTtcblxuICAgICAgICAvLyBsb2FkIGZlYXR1cmVzXG4gICAgICAgIF8uZm9yT3duKHRoaXMuY29uZmlnLCAoZmVhdHVyZU9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWxsb3dlZEZlYXR1cmVzICYmXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcy5pbmRleE9mKG5hbWUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIC8vc2tpcCBkaXNhYmxlZCBmZWF0dXJlc1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZlYXR1cmUgPSB0aGlzLl9sb2FkRmVhdHVyZShuYW1lKTtcblxuICAgICAgICAgICAgaWYgKCEoZmVhdHVyZS50eXBlIGluIGZlYXR1cmVHcm91cHMpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZlYXR1cmUgdHlwZS4gRmVhdHVyZTogJHtuYW1lfSwgdHlwZTogJHtmZWF0dXJlLnR5cGV9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZlYXR1cmVHcm91cHNbZmVhdHVyZS50eXBlXS5wdXNoKFsgbmFtZSwgZmVhdHVyZS5sb2FkXywgZmVhdHVyZU9wdGlvbnMgXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBVdGlsLmVhY2hBc3luY18oZmVhdHVyZUdyb3VwcywgKGdyb3VwLCBsZXZlbCkgPT4gdGhpcy5fbG9hZEZlYXR1cmVHcm91cF8oZ3JvdXAsIGxldmVsKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWRGZWF0dXJlR3JvdXBfKGZlYXR1cmVHcm91cCwgZ3JvdXBMZXZlbCkge1xuICAgICAgICB0aGlzLmVtaXQoJ2JlZm9yZTonICsgZ3JvdXBMZXZlbCk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgXCIke2dyb3VwTGV2ZWx9XCIgZmVhdHVyZSBncm91cCAuLi5gKTtcbiAgICAgICAgYXdhaXQgVXRpbC5lYWNoQXN5bmNfKGZlYXR1cmVHcm91cCwgYXN5bmMgKFsgbmFtZSwgbG9hZF8sIG9wdGlvbnMgXSkgPT4geyAgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnYmVmb3JlOmxvYWQ6JyArIG5hbWUpO1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgTG9hZGluZyBmZWF0dXJlIFwiJHtuYW1lfVwiIC4uLmApO1xuXG4gICAgICAgICAgICBhd2FpdCBsb2FkXyh0aGlzLCBvcHRpb25zKTsgICBcbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0ubG9hZGVkID0gdHJ1ZTsgICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEZlYXR1cmUgXCIke25hbWV9XCIgbG9hZGVkLiBbT0tdYCk7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2FmdGVyOmxvYWQ6JyArIG5hbWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgRmluaXNoZWQgbG9hZGluZyBcIiR7Z3JvdXBMZXZlbH1cIiBmZWF0dXJlIGdyb3VwLiBbT0tdYCk7XG4gICAgICAgIHRoaXMuZW1pdCgnYWZ0ZXI6JyArIGdyb3VwTGV2ZWwpO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGEgZmVhdHVyZSBvYmplY3QgYnkgbmFtZS5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlIFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9ICAgICBcbiAgICAgKi9cbiAgICBfbG9hZEZlYXR1cmUoZmVhdHVyZSkge1xuICAgICAgICBsZXQgZmVhdHVyZU9iamVjdCA9IHRoaXMuZmVhdHVyZXNbZmVhdHVyZV07XG4gICAgICAgIGlmIChmZWF0dXJlT2JqZWN0KSByZXR1cm4gZmVhdHVyZU9iamVjdDtcblxuICAgICAgICBsZXQgZmVhdHVyZVBhdGg7XG5cbiAgICAgICAgaWYgKHRoaXMuX2ZlYXR1cmVSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShmZWF0dXJlKSkgeyAgICAgICAgICBcbiAgICAgICAgICAgIC8vbG9hZCBieSByZWdpc3RyeSBlbnRyeVxuICAgICAgICAgICAgbGV0IGxvYWRPcHRpb24gPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbZmVhdHVyZV07ICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxvYWRPcHRpb24pKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcHRpb24ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByZWdpc3RyeSB2YWx1ZSBmb3IgZmVhdHVyZSBcIiR7ZmVhdHVyZX1cIi5gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IGxvYWRPcHRpb25bMF07XG4gICAgICAgICAgICAgICAgZmVhdHVyZU9iamVjdCA9IHJlcXVpcmUoZmVhdHVyZVBhdGgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcHRpb24ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAvL29uZSBtb2R1bGUgbWF5IGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChmZWF0dXJlT2JqZWN0LCBsb2FkT3B0aW9uWzFdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvbjtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vbG9hZCBieSBmYWxsYmFjayBwYXRoc1xuICAgICAgICAgICAgbGV0IHNlYXJjaGluZ1BhdGggPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbJyonXTtcbiAgICBcbiAgICAgICAgICAgIC8vcmV2ZXJzZSBmYWxsYmFjayBzdGFja1xuICAgICAgICAgICAgbGV0IGZvdW5kID0gXy5maW5kTGFzdChzZWFyY2hpbmdQYXRoLCBwID0+IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IHBhdGguam9pbihwLCBmZWF0dXJlICsgJy5qcycpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghRmVhdHVyZS52YWxpZGF0ZShmZWF0dXJlT2JqZWN0KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZlYXR1cmUgb2JqZWN0IGxvYWRlZCBmcm9tIFwiJHtmZWF0dXJlUGF0aH1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZmVhdHVyZXNbZmVhdHVyZV0gPSBmZWF0dXJlT2JqZWN0O1xuICAgICAgICByZXR1cm4gZmVhdHVyZU9iamVjdDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU2VydmljZUNvbnRhaW5lcjsiXX0=