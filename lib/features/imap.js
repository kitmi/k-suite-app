"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this._requireReset = false;

    this._reset();
  }

  _reset() {
    this.imap = new Imap(this.config);
    this.imap.on('error', error => {
      this.error = error;
      this.app.logError(error);
    });
    this.imap.on('alert', message => {
      this.app.log('warning', `The imap server [${this.name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      this.app.log('info', `The imap server [${this.name}] is ready.`);
    });
    this.imap.once('close', () => {
      this.ready = false;
      this._requireReset = true;
      this.app.log('info', `The connection to imap server [${this.name}] is closed.`);
    });
    this.imap.once('end', () => {
      this.ready = false;
      this._requireReset = true;
      this.app.log('info', `The imap server [${this.name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
  }

  async connect_() {
    if (!this.ready) {
      if (this._requireReset) {
        this._reset();
      }

      this.imap.connect();
      return waitUntil_(() => this.ready, 100, 100);
    }

    return this.ready;
  }

  async close_() {
    if (this.ready) {
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiX3JlcXVpcmVSZXNldCIsIl9yZXNldCIsImltYXAiLCJvbiIsImVycm9yIiwibG9nRXJyb3IiLCJtZXNzYWdlIiwibG9nIiwib25jZSIsInJlYWR5Iiwib3B0aW9ucyIsImNvbnRleHQiLCJmb3JFYWNoIiwibWV0aG9kTmFtZSIsInByb21pc2lmeSIsImNvbm5lY3RfIiwiY29ubmVjdCIsImNsb3NlXyIsImVuZCIsImVuZGVkIiwiZGVzdHJveSIsInNlcnZlclN1cHBvcnRzIiwiY2FwcyIsImZldGNoXyIsInNvdXJjZSIsImZldGNoT3B0aW9ucyIsImltYXBGZXRjaCIsImZldGNoIiwibWVzc2FnZXMiLCJtc2ciLCJzZXFubyIsImF0dHJpYnV0ZXMiLCJib2R5Iiwic3RyZWFtIiwiaW5mbyIsInB1c2giLCJzZWN0aW9uIiwid2hpY2giLCJzaXplIiwiYXR0cnMiLCJyZXNvbHZlIiwicmVqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJTRVJWSUNFIiwibG9hZF8iLCJzZXR0aW5ncyIsImZvck93biIsImNmZyIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSIsImVsZWdhbnRTdG9wcGVycyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQUNBLE1BQU1FLElBQUksR0FBR0QsVUFBVSxDQUFDLE1BQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLFVBQUw7QUFBaUJD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QjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDakIsSUFBaEIsQ0FBcUJlLE1BQU0sQ0FBQ2pDLE1BQVAsRUFBckI7QUFDSCxPQUZEO0FBR0gsS0FQRDtBQVFIO0FBdkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBJbWFwID0gdHJ5UmVxdWlyZSgnaW1hcCcpO1xuY29uc3QgeyBfLCB3YWl0VW50aWxfLCBQcm9taXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jbGFzcyBJbWFwQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIG5hbWUsIGNvbmZpZykgeyAgICAgICAgXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgdGhpcy5fcmVxdWlyZVJlc2V0ID0gZmFsc2U7XG4gICAgICAgXG4gICAgICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgfVxuXG4gICAgX3Jlc2V0KCkge1xuICAgICAgICB0aGlzLmltYXAgPSBuZXcgSW1hcCh0aGlzLmNvbmZpZyk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdlcnJvcicsIGVycm9yID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBlcnJvcjtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZ0Vycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdhbGVydCcsIG1lc3NhZ2UgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCd3YXJuaW5nJywgYFRoZSBpbWFwIHNlcnZlciBbJHt0aGlzLm5hbWV9XSBpc3N1ZXMgYW4gYWxlcnQuIE1lc3NhZ2U6ICR7bWVzc2FnZX1gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske3RoaXMubmFtZX1dIGlzIHJlYWR5LmApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgnY2xvc2UnLCAoKSA9PiB7ICAgIFxuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyBcbiAgICAgICAgICAgIHRoaXMuX3JlcXVpcmVSZXNldCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgVGhlIGNvbm5lY3Rpb24gdG8gaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXMgY2xvc2VkLmApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgnZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyAgICAgICBcbiAgICAgICAgICAgIHRoaXMuX3JlcXVpcmVSZXNldCA9IHRydWU7ICAgICBcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXMgZW5kZWQuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vcHJvbWlzaWZ5IGltYXAgZnVuY3Rpb25zXG4gICAgICAgIGxldCBvcHRpb25zID0geyBjb250ZXh0OiB0aGlzLmltYXAgfTtcblxuICAgICAgICBbXG4gICAgICAgICAgICAnb3BlbkJveCcsICdjbG9zZUJveCcsICdhZGRCb3gnLCAnZGVsQm94JywgJ3JlbmFtZUJveCcsICdzdWJzY3JpYmVCb3gnLCAndW5zdWJzY3JpYmVCb3gnLFxuICAgICAgICAgICAgJ3N0YXR1cycsICdnZXRCb3hlcycsICdnZXRTdWJzY3JpYmVkQm94ZXMnLCAnZXhwdW5nZScsICdhcHBlbmQnLFxuICAgICAgICAgICAgLy9BbGwgZnVuY3Rpb25zIGJlbG93IGhhdmUgc2VxdWVuY2UgbnVtYmVyLWJhc2VkIGNvdW50ZXJwYXJ0cyB0aGF0IFxuICAgICAgICAgICAgLy9jYW4gYmUgYWNjZXNzZWQgYnkgdXNpbmcgdGhlICdzZXEnIG5hbWVzcGFjZSBvZiB0aGUgaW1hcCBjb25uZWN0aW9uJ3MgXG4gICAgICAgICAgICAvL2luc3RhbmNlIChlLmcuIGNvbm4uc2VxLnNlYXJjaCgpIHJldHVybnMgc2VxdWVuY2UgbnVtYmVyKHMpIGluc3RlYWQgb2YgVUlEcywgXG4gICAgICAgICAgICAvL2Nvbm4uc2VxLmZldGNoKCkgZmV0Y2hlcyBieSBzZXF1ZW5jZSBudW1iZXIocykgaW5zdGVhZCBvZiBVSURzLCBldGMpOlxuICAgICAgICAgICAgJ3NlYXJjaCcsICdjb3B5JywgJ21vdmUnLCAnYWRkRmxhZ3MnLCAnZGVsRmxhZ3MnLCAnc2V0RmxhZ3MnLCAnYWRkS2V5d29yZHMnLCAnZGVsS2V5d29yZHMnLCAnc2V0S2V5d29yZHMnLFxuXG4gICAgICAgICAgICAvL2dtYWlsIGV4dGVudGlvblxuICAgICAgICAgICAgJ3NldExhYmVscycsICdhZGRMYWJlbHMnLCAnZGVsTGFiZWxzJ1xuICAgICAgICBdLmZvckVhY2gobWV0aG9kTmFtZSA9PiB7XG4gICAgICAgICAgICB0aGlzW21ldGhvZE5hbWUgKyAnXyddID0gUHJvbWlzZS5wcm9taXNpZnkodGhpcy5pbWFwW21ldGhvZE5hbWVdLCBvcHRpb25zKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7XG4gICAgICAgIGlmICghdGhpcy5yZWFkeSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuX3JlcXVpcmVSZXNldCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgICAgICAgICByZXR1cm4gd2FpdFVudGlsXygoKSA9PiB0aGlzLnJlYWR5LCAxMDAsIDEwMCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5yZWFkeTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZV8oKSB7ICAgICAgXG4gICAgICAgIGlmICh0aGlzLnJlYWR5KSB7ICBcbiAgICAgICAgICAgIHRoaXMuaW1hcC5lbmQoKTtcblxuICAgICAgICAgICAgbGV0IGVuZGVkID0gYXdhaXQgd2FpdFVudGlsXygoKSA9PiAhdGhpcy5yZWFkeSwgMTAwLCAzMDApO1xuXG4gICAgICAgICAgICBpZiAoIWVuZGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbWFwLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gIFxuICAgIFxuICAgIHNlcnZlclN1cHBvcnRzKGNhcHMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1hcChjYXBzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBNYXAgb2Ygc2Vxbm8gdG8gbWVzc2FnZVxuICAgICAqL1xuICAgIGFzeW5jIGZldGNoXyhzb3VyY2UsIGZldGNoT3B0aW9ucykge1xuICAgICAgICBsZXQgaW1hcEZldGNoID0gdGhpcy5pbWFwLmZldGNoKHNvdXJjZSwgZmV0Y2hPcHRpb25zKTtcblxuICAgICAgICBsZXQgbWVzc2FnZXMgPSBbXTtcblxuICAgICAgICBpbWFwRmV0Y2gub24oJ21lc3NhZ2UnLCAobXNnLCBzZXFubykgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGF0dHJpYnV0ZXM7XG4gICAgICAgICAgICBsZXQgYm9keSA9IFtdO1xuXG4gICAgICAgICAgICBtc2cub24oJ2JvZHknLCAoc3RyZWFtLCBpbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgYm9keS5wdXNoKHsgc2VjdGlvbjogaW5mby53aGljaCwgc2l6ZTogaW5mby5zaXplLCBzdHJlYW0gfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbXNnLm9uY2UoJ2F0dHJpYnV0ZXMnLCAoYXR0cnMpID0+IHtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzID0gYXR0cnM7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbXNnLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsgc2Vxbm8sIGF0dHJpYnV0ZXMsIGJvZHkgfSk7XG4gICAgICAgICAgICB9KTsgICAgIFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaW1hcEZldGNoLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShtZXNzYWdlcyk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaW1hcEZldGNoLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgXG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgaW5pdCBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlNFUlZJQ0UsXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBjbGkgYXBwIG1vZHVsZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2V0dGluZ3MgLSBTZXR0aW5ncyBvZiByZXN0IGNsaWVudHMgICAgXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiBhc3luYyBmdW5jdGlvbiAoYXBwLCBzZXR0aW5ncykge1xuICAgICAgICBfLmZvck93bihzZXR0aW5ncywgKGNmZywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBJbWFwQ2xpZW50KGFwcCwgbmFtZSwgY2ZnKTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYGltYXAuJHtuYW1lfWAsIGNsaWVudCk7XG5cbiAgICAgICAgICAgIGFwcC5vbignc3RvcHBpbmcnLCAoZWxlZ2FudFN0b3BwZXJzKSA9PiB7XG4gICAgICAgICAgICAgICAgZWxlZ2FudFN0b3BwZXJzLnB1c2goY2xpZW50LmNsb3NlXygpKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTtcbiJdfQ==