"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this._resetCounter = 0;

    this._reset();
  }

  _reset() {
    this.imap = new Imap(this.config);
    this.imap.on('error', error => {
      this.error = error;
      this.app.logError(error);
    });
    this.imap.on('alert', message => {
      this.app.log('warning', `The imap server [${this.name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      this.app.log('info', `The imap server [${this.name}] is ready.`);
    });
    this.imap.once('close', () => {
      this.ready = false;
      this._requireReset = true;
      this.app.log('info', `The connection to imap server [${this.name}] is closed.`);
    });
    this.imap.once('end', () => {
      this.ready = false;
      this._requireReset = true;
      this.app.log('info', `The imap server [${this.name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
    this._requireReset = false;
  }

  async connect_() {
    if (!this.ready) {
      if (this._requireReset) {
        this._resetCounter++;
        this.app.log('info', 'The connection to the imap server is closed and need to be reconnected.', {
          resetCounter: this._resetCounter
        });

        this._reset();
      }

      this.imap.connect();
      return waitUntil_(() => this.ready, 100, 100);
    }

    return this.ready;
  }

  async close_() {
    if (this.ready) {
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiX3Jlc2V0Q291bnRlciIsIl9yZXNldCIsImltYXAiLCJvbiIsImVycm9yIiwibG9nRXJyb3IiLCJtZXNzYWdlIiwibG9nIiwib25jZSIsInJlYWR5IiwiX3JlcXVpcmVSZXNldCIsIm9wdGlvbnMiLCJjb250ZXh0IiwiZm9yRWFjaCIsIm1ldGhvZE5hbWUiLCJwcm9taXNpZnkiLCJjb25uZWN0XyIsInJlc2V0Q291bnRlciIsImNvbm5lY3QiLCJjbG9zZV8iLCJlbmQiLCJlbmRlZCIsImRlc3Ryb3kiLCJzZXJ2ZXJTdXBwb3J0cyIsImNhcHMiLCJmZXRjaF8iLCJzb3VyY2UiLCJmZXRjaE9wdGlvbnMiLCJpbWFwRmV0Y2giLCJmZXRjaCIsIm1lc3NhZ2VzIiwibXNnIiwic2Vxbm8iLCJhdHRyaWJ1dGVzIiwiYm9keSIsInN0cmVhbSIsImluZm8iLCJwdXNoIiwic2VjdGlvbiIsIndoaWNoIiwic2l6ZSIsImF0dHJzIiwicmVzb2x2ZSIsInJlamVjdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwic2V0dGluZ3MiLCJmb3JPd24iLCJjZmciLCJjbGllbnQiLCJyZWdpc3RlclNlcnZpY2UiLCJlbGVnYW50U3RvcHBlcnMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxrQkFBRCxDQUE5Qjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdELFVBQVUsQ0FBQyxNQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUUsRUFB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RCxVQUFKLENBQWVFLEdBQWYsRUFBb0JDLElBQXBCLEVBQTBCcUQsR0FBMUIsQ0FBYjtBQUNBdEQsTUFBQUEsR0FBRyxDQUFDd0QsZUFBSixDQUFxQixRQUFPdkQsSUFBSyxFQUFqQyxFQUFvQ3NELE1BQXBDO0FBRUF2RCxNQUFBQSxHQUFHLENBQUNNLEVBQUosQ0FBTyxVQUFQLEVBQW9CbUQsZUFBRCxJQUFxQjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDakIsSUFBaEIsQ0FBcUJlLE1BQU0sQ0FBQ2pDLE1BQVAsRUFBckI7QUFDSCxPQUZEO0FBR0gsS0FQRDtBQVFIO0FBdkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBJbWFwID0gdHJ5UmVxdWlyZSgnaW1hcCcpO1xuY29uc3QgeyBfLCB3YWl0VW50aWxfLCBQcm9taXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jbGFzcyBJbWFwQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIG5hbWUsIGNvbmZpZykgeyAgICAgICAgXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZzsgXG4gICAgICAgIHRoaXMuX3Jlc2V0Q291bnRlciA9IDA7ICAgICAgIFxuICAgICAgIFxuICAgICAgICB0aGlzLl9yZXNldCgpO1xuICAgIH1cblxuICAgIF9yZXNldCgpIHtcbiAgICAgICAgdGhpcy5pbWFwID0gbmV3IEltYXAodGhpcy5jb25maWcpO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignZXJyb3InLCBlcnJvciA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVycm9yID0gZXJyb3I7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2dFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignYWxlcnQnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybmluZycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXNzdWVzIGFuIGFsZXJ0LiBNZXNzYWdlOiAke21lc3NhZ2V9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbmNlKCdyZWFkeScsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYFRoZSBpbWFwIHNlcnZlciBbJHt0aGlzLm5hbWV9XSBpcyByZWFkeS5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ2Nsb3NlJywgKCkgPT4geyAgICBcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTsgXG4gICAgICAgICAgICB0aGlzLl9yZXF1aXJlUmVzZXQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYFRoZSBjb25uZWN0aW9uIHRvIGltYXAgc2VydmVyIFske3RoaXMubmFtZX1dIGlzIGNsb3NlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTsgICAgICAgXG4gICAgICAgICAgICB0aGlzLl9yZXF1aXJlUmVzZXQgPSB0cnVlOyAgICAgXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske3RoaXMubmFtZX1dIGlzIGVuZGVkLmApO1xuICAgICAgICB9KTtcblxuICAgICAgICAvL3Byb21pc2lmeSBpbWFwIGZ1bmN0aW9uc1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHsgY29udGV4dDogdGhpcy5pbWFwIH07XG5cbiAgICAgICAgW1xuICAgICAgICAgICAgJ29wZW5Cb3gnLCAnY2xvc2VCb3gnLCAnYWRkQm94JywgJ2RlbEJveCcsICdyZW5hbWVCb3gnLCAnc3Vic2NyaWJlQm94JywgJ3Vuc3Vic2NyaWJlQm94JyxcbiAgICAgICAgICAgICdzdGF0dXMnLCAnZ2V0Qm94ZXMnLCAnZ2V0U3Vic2NyaWJlZEJveGVzJywgJ2V4cHVuZ2UnLCAnYXBwZW5kJyxcbiAgICAgICAgICAgIC8vQWxsIGZ1bmN0aW9ucyBiZWxvdyBoYXZlIHNlcXVlbmNlIG51bWJlci1iYXNlZCBjb3VudGVycGFydHMgdGhhdCBcbiAgICAgICAgICAgIC8vY2FuIGJlIGFjY2Vzc2VkIGJ5IHVzaW5nIHRoZSAnc2VxJyBuYW1lc3BhY2Ugb2YgdGhlIGltYXAgY29ubmVjdGlvbidzIFxuICAgICAgICAgICAgLy9pbnN0YW5jZSAoZS5nLiBjb25uLnNlcS5zZWFyY2goKSByZXR1cm5zIHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIFxuICAgICAgICAgICAgLy9jb25uLnNlcS5mZXRjaCgpIGZldGNoZXMgYnkgc2VxdWVuY2UgbnVtYmVyKHMpIGluc3RlYWQgb2YgVUlEcywgZXRjKTpcbiAgICAgICAgICAgICdzZWFyY2gnLCAnY29weScsICdtb3ZlJywgJ2FkZEZsYWdzJywgJ2RlbEZsYWdzJywgJ3NldEZsYWdzJywgJ2FkZEtleXdvcmRzJywgJ2RlbEtleXdvcmRzJywgJ3NldEtleXdvcmRzJyxcblxuICAgICAgICAgICAgLy9nbWFpbCBleHRlbnRpb25cbiAgICAgICAgICAgICdzZXRMYWJlbHMnLCAnYWRkTGFiZWxzJywgJ2RlbExhYmVscydcbiAgICAgICAgXS5mb3JFYWNoKG1ldGhvZE5hbWUgPT4ge1xuICAgICAgICAgICAgdGhpc1ttZXRob2ROYW1lICsgJ18nXSA9IFByb21pc2UucHJvbWlzaWZ5KHRoaXMuaW1hcFttZXRob2ROYW1lXSwgb3B0aW9ucyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX3JlcXVpcmVSZXNldCA9IGZhbHNlO1xuICAgIH1cblxuICAgIGFzeW5jIGNvbm5lY3RfKCkge1xuICAgICAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9yZXF1aXJlUmVzZXQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9yZXNldENvdW50ZXIrKztcbiAgICAgICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCAnVGhlIGNvbm5lY3Rpb24gdG8gdGhlIGltYXAgc2VydmVyIGlzIGNsb3NlZCBhbmQgbmVlZCB0byBiZSByZWNvbm5lY3RlZC4nLCB7IHJlc2V0Q291bnRlcjogdGhpcy5fcmVzZXRDb3VudGVyIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgICAgICAgICByZXR1cm4gd2FpdFVudGlsXygoKSA9PiB0aGlzLnJlYWR5LCAxMDAsIDEwMCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5yZWFkeTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZV8oKSB7ICAgICAgXG4gICAgICAgIGlmICh0aGlzLnJlYWR5KSB7ICBcbiAgICAgICAgICAgIHRoaXMuaW1hcC5lbmQoKTtcblxuICAgICAgICAgICAgbGV0IGVuZGVkID0gYXdhaXQgd2FpdFVudGlsXygoKSA9PiAhdGhpcy5yZWFkeSwgMTAwLCAzMDApO1xuXG4gICAgICAgICAgICBpZiAoIWVuZGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbWFwLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gIFxuICAgIFxuICAgIHNlcnZlclN1cHBvcnRzKGNhcHMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1hcChjYXBzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBNYXAgb2Ygc2Vxbm8gdG8gbWVzc2FnZVxuICAgICAqL1xuICAgIGFzeW5jIGZldGNoXyhzb3VyY2UsIGZldGNoT3B0aW9ucykge1xuICAgICAgICBsZXQgaW1hcEZldGNoID0gdGhpcy5pbWFwLmZldGNoKHNvdXJjZSwgZmV0Y2hPcHRpb25zKTtcblxuICAgICAgICBsZXQgbWVzc2FnZXMgPSBbXTtcblxuICAgICAgICBpbWFwRmV0Y2gub24oJ21lc3NhZ2UnLCAobXNnLCBzZXFubykgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGF0dHJpYnV0ZXM7XG4gICAgICAgICAgICBsZXQgYm9keSA9IFtdO1xuXG4gICAgICAgICAgICBtc2cub24oJ2JvZHknLCAoc3RyZWFtLCBpbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgYm9keS5wdXNoKHsgc2VjdGlvbjogaW5mby53aGljaCwgc2l6ZTogaW5mby5zaXplLCBzdHJlYW0gfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbXNnLm9uY2UoJ2F0dHJpYnV0ZXMnLCAoYXR0cnMpID0+IHtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzID0gYXR0cnM7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbXNnLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsgc2Vxbm8sIGF0dHJpYnV0ZXMsIGJvZHkgfSk7XG4gICAgICAgICAgICB9KTsgICAgIFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaW1hcEZldGNoLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShtZXNzYWdlcyk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaW1hcEZldGNoLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgXG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgaW5pdCBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlNFUlZJQ0UsXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBjbGkgYXBwIG1vZHVsZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2V0dGluZ3MgLSBTZXR0aW5ncyBvZiByZXN0IGNsaWVudHMgICAgXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiBhc3luYyBmdW5jdGlvbiAoYXBwLCBzZXR0aW5ncykge1xuICAgICAgICBfLmZvck93bihzZXR0aW5ncywgKGNmZywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBJbWFwQ2xpZW50KGFwcCwgbmFtZSwgY2ZnKTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYGltYXAuJHtuYW1lfWAsIGNsaWVudCk7XG5cbiAgICAgICAgICAgIGFwcC5vbignc3RvcHBpbmcnLCAoZWxlZ2FudFN0b3BwZXJzKSA9PiB7XG4gICAgICAgICAgICAgICAgZWxlZ2FudFN0b3BwZXJzLnB1c2goY2xpZW50LmNsb3NlXygpKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTtcbiJdfQ==