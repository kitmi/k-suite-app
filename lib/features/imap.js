"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this.imap = new Imap(config);
    this.imap.on('error', error => {
      this.error = error;
      app.logError(error);
    });
    this.imap.on('alert', message => {
      app.log('warning', `The imap server [${name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      app.log('info', `The imap server [${name}] is ready.`);
    });
    this.imap.once('close', () => {
      this.ready = false;
      app.log('info', `The connection to imap server [${name}] is closed.`);
    });
    this.imap.once('end', () => {
      this.ready = false;
      app.log('info', `The imap server [${name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
  }

  async connect_() {
    if (!this.ready) {
      this.imap.connect();
      return waitUntil_(() => this.ready, 100, 100);
    }
  }

  async close_() {
    if (this.ready) {
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiaW1hcCIsIm9uIiwiZXJyb3IiLCJsb2dFcnJvciIsIm1lc3NhZ2UiLCJsb2ciLCJvbmNlIiwicmVhZHkiLCJvcHRpb25zIiwiY29udGV4dCIsImZvckVhY2giLCJtZXRob2ROYW1lIiwicHJvbWlzaWZ5IiwiY29ubmVjdF8iLCJjb25uZWN0IiwiY2xvc2VfIiwiZW5kIiwiZW5kZWQiLCJkZXN0cm95Iiwic2VydmVyU3VwcG9ydHMiLCJjYXBzIiwiZmV0Y2hfIiwic291cmNlIiwiZmV0Y2hPcHRpb25zIiwiaW1hcEZldGNoIiwiZmV0Y2giLCJtZXNzYWdlcyIsIm1zZyIsInNlcW5vIiwiYXR0cmlidXRlcyIsImJvZHkiLCJzdHJlYW0iLCJpbmZvIiwicHVzaCIsInNlY3Rpb24iLCJ3aGljaCIsInNpemUiLCJhdHRycyIsInJlc29sdmUiLCJyZWplY3QiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlNFUlZJQ0UiLCJsb2FkXyIsInNldHRpbmdzIiwiZm9yT3duIiwiY2ZnIiwiY2xpZW50IiwicmVnaXN0ZXJTZXJ2aWNlIiwiZWxlZ2FudFN0b3BwZXJzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsa0JBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRCxVQUFVLENBQUMsTUFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsVUFBTDtBQUFpQkMsRUFBQUE7QUFBakIsSUFBNkJMLE9BQU8s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RUFBVUMsTUFBVixLQUFxQjtBQUMxQ2YsTUFBQUEsU0FBUyxDQUFDdkIsRUFBVixDQUFhLEtBQWIsRUFBb0IsTUFBTTtBQUN0QnFDLFFBQUFBLE9BQU8sQ0FBQ1osUUFBRCxDQUFQO0FBQ0gsT0FGRDtBQUlBRixNQUFBQSxTQUFTLENBQUN2QixFQUFWLENBQWEsT0FBYixFQUF1QkMsS0FBRCxJQUFXO0FBQzdCcUMsUUFBQUEsTUFBTSxDQUFDckMsS0FBRCxDQUFOO0FBQ0gsT0FGRDtBQUdILEtBUlksQ0FBYjtBQVNIOztBQTNHWTs7QUE4R2pCc0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBTWJDLEVBQUFBLElBQUksRUFBRXRELE9BQU8sQ0FBQ3VELE9BTkQ7QUFjYkMsRUFBQUEsS0FBSyxFQUFFLGdCQUFnQi9DLEdBQWhCLEVBQXFCZ0QsUUFBckIsRUFBK0I7QUFDbENyRCxJQUFBQSxDQUFDLENBQUNzRCxNQUFGLENBQVNELFFBQVQsRUFBbUIsQ0FBQ0UsR0FBRCxFQUFNakQsSUFBTixLQUFlO0FBQzlCLFVBQUlrRCxNQUFNLEdBQUcsSUFBSXJELFVBQUosQ0FBZUUsR0FBZixFQUFvQkMsSUFBcEIsRUFBMEJpRCxHQUExQixDQUFiO0FBQ0FsRCxNQUFBQSxHQUFHLENBQUNvRCxlQUFKLENBQXFCLFFBQU9uRCxJQUFLLEVBQWpDLEVBQW9Da0QsTUFBcEM7QUFFQW5ELE1BQUFBLEdBQUcsQ0FBQ0ksRUFBSixDQUFPLFVBQVAsRUFBb0JpRCxlQUFELElBQXFCO0FBQ3BDQSxRQUFBQSxlQUFlLENBQUNqQixJQUFoQixDQUFxQmUsTUFBTSxDQUFDakMsTUFBUCxFQUFyQjtBQUNILE9BRkQ7QUFHSCxLQVBEO0FBUUg7QUF2QlksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnLi4vZW51bS9GZWF0dXJlJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0hlbHBlcnMnKTtcbmNvbnN0IEltYXAgPSB0cnlSZXF1aXJlKCdpbWFwJyk7XG5jb25zdCB7IF8sIHdhaXRVbnRpbF8sIFByb21pc2UgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbmNsYXNzIEltYXBDbGllbnQge1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgbmFtZSwgY29uZmlnKSB7ICAgICAgICBcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICB0aGlzLmltYXAgPSBuZXcgSW1hcChjb25maWcpO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignZXJyb3InLCBlcnJvciA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVycm9yID0gZXJyb3I7XG4gICAgICAgICAgICBhcHAubG9nRXJyb3IoZXJyb3IpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub24oJ2FsZXJ0JywgbWVzc2FnZSA9PiB7XG4gICAgICAgICAgICBhcHAubG9nKCd3YXJuaW5nJywgYFRoZSBpbWFwIHNlcnZlciBbJHtuYW1lfV0gaXNzdWVzIGFuIGFsZXJ0LiBNZXNzYWdlOiAke21lc3NhZ2V9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbmNlKCdyZWFkeScsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuICAgICAgICAgICAgYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzIHJlYWR5LmApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgnY2xvc2UnLCAoKSA9PiB7ICAgIFxuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyBcbiAgICAgICAgICAgIGFwcC5sb2coJ2luZm8nLCBgVGhlIGNvbm5lY3Rpb24gdG8gaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzIGNsb3NlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTsgICAgICAgICAgICBcbiAgICAgICAgICAgIGFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske25hbWV9XSBpcyBlbmRlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9wcm9taXNpZnkgaW1hcCBmdW5jdGlvbnNcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7IGNvbnRleHQ6IHRoaXMuaW1hcCB9O1xuXG4gICAgICAgIFtcbiAgICAgICAgICAgICdvcGVuQm94JywgJ2Nsb3NlQm94JywgJ2FkZEJveCcsICdkZWxCb3gnLCAncmVuYW1lQm94JywgJ3N1YnNjcmliZUJveCcsICd1bnN1YnNjcmliZUJveCcsXG4gICAgICAgICAgICAnc3RhdHVzJywgJ2dldEJveGVzJywgJ2dldFN1YnNjcmliZWRCb3hlcycsICdleHB1bmdlJywgJ2FwcGVuZCcsXG4gICAgICAgICAgICAvL0FsbCBmdW5jdGlvbnMgYmVsb3cgaGF2ZSBzZXF1ZW5jZSBudW1iZXItYmFzZWQgY291bnRlcnBhcnRzIHRoYXQgXG4gICAgICAgICAgICAvL2NhbiBiZSBhY2Nlc3NlZCBieSB1c2luZyB0aGUgJ3NlcScgbmFtZXNwYWNlIG9mIHRoZSBpbWFwIGNvbm5lY3Rpb24ncyBcbiAgICAgICAgICAgIC8vaW5zdGFuY2UgKGUuZy4gY29ubi5zZXEuc2VhcmNoKCkgcmV0dXJucyBzZXF1ZW5jZSBudW1iZXIocykgaW5zdGVhZCBvZiBVSURzLCBcbiAgICAgICAgICAgIC8vY29ubi5zZXEuZmV0Y2goKSBmZXRjaGVzIGJ5IHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIGV0Yyk6XG4gICAgICAgICAgICAnc2VhcmNoJywgJ2NvcHknLCAnbW92ZScsICdhZGRGbGFncycsICdkZWxGbGFncycsICdzZXRGbGFncycsICdhZGRLZXl3b3JkcycsICdkZWxLZXl3b3JkcycsICdzZXRLZXl3b3JkcycsXG5cbiAgICAgICAgICAgIC8vZ21haWwgZXh0ZW50aW9uXG4gICAgICAgICAgICAnc2V0TGFiZWxzJywgJ2FkZExhYmVscycsICdkZWxMYWJlbHMnXG4gICAgICAgIF0uZm9yRWFjaChtZXRob2ROYW1lID0+IHtcbiAgICAgICAgICAgIHRoaXNbbWV0aG9kTmFtZSArICdfJ10gPSBQcm9taXNlLnByb21pc2lmeSh0aGlzLmltYXBbbWV0aG9kTmFtZV0sIG9wdGlvbnMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgICAgICB0aGlzLmltYXAuY29ubmVjdCgpO1xuICAgICAgICAgICAgcmV0dXJuIHdhaXRVbnRpbF8oKCkgPT4gdGhpcy5yZWFkeSwgMTAwLCAxMDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2VfKCkgeyAgICAgIFxuICAgICAgICBpZiAodGhpcy5yZWFkeSkgeyAgXG4gICAgICAgICAgICB0aGlzLmltYXAuZW5kKCk7XG5cbiAgICAgICAgICAgIGxldCBlbmRlZCA9IGF3YWl0IHdhaXRVbnRpbF8oKCkgPT4gIXRoaXMucmVhZHksIDEwMCwgMzAwKTtcblxuICAgICAgICAgICAgaWYgKCFlbmRlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW1hcC5kZXN0cm95KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9ICBcbiAgICBcbiAgICBzZXJ2ZXJTdXBwb3J0cyhjYXBzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmltYXAoY2Fwcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMge29iamVjdH0gTWFwIG9mIHNlcW5vIHRvIG1lc3NhZ2VcbiAgICAgKi9cbiAgICBhc3luYyBmZXRjaF8oc291cmNlLCBmZXRjaE9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGltYXBGZXRjaCA9IHRoaXMuaW1hcC5mZXRjaChzb3VyY2UsIGZldGNoT3B0aW9ucyk7XG5cbiAgICAgICAgbGV0IG1lc3NhZ2VzID0gW107XG5cbiAgICAgICAgaW1hcEZldGNoLm9uKCdtZXNzYWdlJywgKG1zZywgc2Vxbm8pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBhdHRyaWJ1dGVzO1xuICAgICAgICAgICAgbGV0IGJvZHkgPSBbXTtcblxuICAgICAgICAgICAgbXNnLm9uKCdib2R5JywgKHN0cmVhbSwgaW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGJvZHkucHVzaCh7IHNlY3Rpb246IGluZm8ud2hpY2gsIHNpemU6IGluZm8uc2l6ZSwgc3RyZWFtIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdhdHRyaWJ1dGVzJywgKGF0dHJzKSA9PiB7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJzO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh7IHNlcW5vLCBhdHRyaWJ1dGVzLCBib2R5IH0pO1xuICAgICAgICAgICAgfSk7ICAgICBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUobWVzc2FnZXMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgIFxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5mb3JPd24oc2V0dGluZ3MsIChjZmcsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgSW1hcENsaWVudChhcHAsIG5hbWUsIGNmZyk7XG4gICAgICAgICAgICBhcHAucmVnaXN0ZXJTZXJ2aWNlKGBpbWFwLiR7bmFtZX1gLCBjbGllbnQpO1xuXG4gICAgICAgICAgICBhcHAub24oJ3N0b3BwaW5nJywgKGVsZWdhbnRTdG9wcGVycykgPT4ge1xuICAgICAgICAgICAgICAgIGVsZWdhbnRTdG9wcGVycy5wdXNoKGNsaWVudC5jbG9zZV8oKSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG4iXX0=