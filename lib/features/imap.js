"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.imap = new Imap(config);
    this.imap.on('error', error => {
      this.error = error;
      app.logError(error);
    });
    this.imap.on('alert', message => {
      app.log('warning', `The imap server [${name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      app.log('info', `The imap server [${name}] is ready.`);
    });
    this.imap.once('close', () => {
      app.log('info', `The connection to imap server [${name}] is closed.`);
    });
    this.imap.once('end', () => {
      this.ready = false;
      app.log('info', `The imap server [${name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
    this.imap.connect();
  }

  async waitForReady_() {
    return waitUntil_(() => this.ready, 100, 100);
  }

  async close_() {
    if (this.ready) {
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      console.log('seqno', seqno);
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiaW1hcCIsIm9uIiwiZXJyb3IiLCJsb2dFcnJvciIsIm1lc3NhZ2UiLCJsb2ciLCJvbmNlIiwicmVhZHkiLCJvcHRpb25zIiwiY29udGV4dCIsImZvckVhY2giLCJtZXRob2ROYW1lIiwicHJvbWlzaWZ5IiwiY29ubmVjdCIsIndhaXRGb3JSZWFkeV8iLCJjbG9zZV8iLCJlbmQiLCJlbmRlZCIsImRlc3Ryb3kiLCJzZXJ2ZXJTdXBwb3J0cyIsImNhcHMiLCJmZXRjaF8iLCJzb3VyY2UiLCJmZXRjaE9wdGlvbnMiLCJpbWFwRmV0Y2giLCJmZXRjaCIsIm1lc3NhZ2VzIiwibXNnIiwic2Vxbm8iLCJjb25zb2xlIiwiYXR0cmlidXRlcyIsImJvZHkiLCJzdHJlYW0iLCJpbmZvIiwicHVzaCIsInNlY3Rpb24iLCJ3aGljaCIsInNpemUiLCJhdHRycyIsInJlc29sdmUiLCJyZWplY3QiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlNFUlZJQ0UiLCJsb2FkXyIsInNldHRpbmdzIiwiZm9yT3duIiwiY2ZnIiwiY2xpZW50IiwicmVnaXN0ZXJTZXJ2aWNlIiwiZWxlZ2FudFN0b3BwZXJzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsa0JBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRCxVQUFVLENBQUMsTUFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsVUFBTDtBQUFpQkMsRUFBQUE7QUFB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QSxPQUFPLENBQUNiLFFBQUQsQ0FBUDtBQUNILE9BRkQ7QUFJQUYsTUFBQUEsU0FBUyxDQUFDdkIsRUFBVixDQUFhLE9BQWIsRUFBdUJDLEtBQUQsSUFBVztBQUM3QnNDLFFBQUFBLE1BQU0sQ0FBQ3RDLEtBQUQsQ0FBTjtBQUNILE9BRkQ7QUFHSCxLQVJZLENBQWI7QUFTSDs7QUF0R1k7O0FBeUdqQnVDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQU1iQyxFQUFBQSxJQUFJLEVBQUV2RCxPQUFPLENBQUN3RCxPQU5EO0FBY2JDLEVBQUFBLEtBQUssRUFBRSxnQkFBZ0JoRCxHQUFoQixFQUFxQmlELFFBQXJCLEVBQStCO0FBQ2xDdEQsSUFBQUEsQ0FBQyxDQUFDdUQsTUFBRixDQUFTRCxRQUFULEVBQW1CLENBQUNFLEdBQUQsRUFBTWxELElBQU4sS0FBZTtBQUM5QixVQUFJbUQsTUFBTSxHQUFHLElBQUl0RCxVQUFKLENBQWVFLEdBQWYsRUFBb0JDLElBQXBCLEVBQTBCa0QsR0FBMUIsQ0FBYjtBQUNBbkQsTUFBQUEsR0FBRyxDQUFDcUQsZUFBSixDQUFxQixRQUFPcEQsSUFBSyxFQUFqQyxFQUFvQ21ELE1BQXBDO0FBRUFwRCxNQUFBQSxHQUFHLENBQUNJLEVBQUosQ0FBTyxVQUFQLEVBQW9Ca0QsZUFBRCxJQUFxQjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDakIsSUFBaEIsQ0FBcUJlLE1BQU0sQ0FBQ2xDLE1BQVAsRUFBckI7QUFDSCxPQUZEO0FBR0gsS0FQRDtBQVFIO0FBdkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBJbWFwID0gdHJ5UmVxdWlyZSgnaW1hcCcpO1xuY29uc3QgeyBfLCB3YWl0VW50aWxfLCBQcm9taXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jbGFzcyBJbWFwQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIG5hbWUsIGNvbmZpZykge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5pbWFwID0gbmV3IEltYXAoY29uZmlnKTtcblxuICAgICAgICB0aGlzLmltYXAub24oJ2Vycm9yJywgZXJyb3IgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5lcnJvciA9IGVycm9yO1xuICAgICAgICAgICAgYXBwLmxvZ0Vycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdhbGVydCcsIG1lc3NhZ2UgPT4ge1xuICAgICAgICAgICAgYXBwLmxvZygnd2FybmluZycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzc3VlcyBhbiBhbGVydC4gTWVzc2FnZTogJHttZXNzYWdlfWApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgncmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIGFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske25hbWV9XSBpcyByZWFkeS5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ2Nsb3NlJywgKCkgPT4geyAgICBcbiAgICAgICAgICAgIGFwcC5sb2coJ2luZm8nLCBgVGhlIGNvbm5lY3Rpb24gdG8gaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzIGNsb3NlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTsgICAgICAgICAgICBcbiAgICAgICAgICAgIGFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske25hbWV9XSBpcyBlbmRlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9wcm9taXNpZnkgaW1hcCBmdW5jdGlvbnNcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7IGNvbnRleHQ6IHRoaXMuaW1hcCB9O1xuXG4gICAgICAgIFtcbiAgICAgICAgICAgICdvcGVuQm94JywgJ2Nsb3NlQm94JywgJ2FkZEJveCcsICdkZWxCb3gnLCAncmVuYW1lQm94JywgJ3N1YnNjcmliZUJveCcsICd1bnN1YnNjcmliZUJveCcsXG4gICAgICAgICAgICAnc3RhdHVzJywgJ2dldEJveGVzJywgJ2dldFN1YnNjcmliZWRCb3hlcycsICdleHB1bmdlJywgJ2FwcGVuZCcsXG4gICAgICAgICAgICAvL0FsbCBmdW5jdGlvbnMgYmVsb3cgaGF2ZSBzZXF1ZW5jZSBudW1iZXItYmFzZWQgY291bnRlcnBhcnRzIHRoYXQgXG4gICAgICAgICAgICAvL2NhbiBiZSBhY2Nlc3NlZCBieSB1c2luZyB0aGUgJ3NlcScgbmFtZXNwYWNlIG9mIHRoZSBpbWFwIGNvbm5lY3Rpb24ncyBcbiAgICAgICAgICAgIC8vaW5zdGFuY2UgKGUuZy4gY29ubi5zZXEuc2VhcmNoKCkgcmV0dXJucyBzZXF1ZW5jZSBudW1iZXIocykgaW5zdGVhZCBvZiBVSURzLCBcbiAgICAgICAgICAgIC8vY29ubi5zZXEuZmV0Y2goKSBmZXRjaGVzIGJ5IHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIGV0Yyk6XG4gICAgICAgICAgICAnc2VhcmNoJywgJ2NvcHknLCAnbW92ZScsICdhZGRGbGFncycsICdkZWxGbGFncycsICdzZXRGbGFncycsICdhZGRLZXl3b3JkcycsICdkZWxLZXl3b3JkcycsICdzZXRLZXl3b3JkcydcbiAgICAgICAgXS5mb3JFYWNoKG1ldGhvZE5hbWUgPT4ge1xuICAgICAgICAgICAgdGhpc1ttZXRob2ROYW1lICsgJ18nXSA9IFByb21pc2UucHJvbWlzaWZ5KHRoaXMuaW1hcFttZXRob2ROYW1lXSwgb3B0aW9ucyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgfVxuXG4gICAgYXN5bmMgd2FpdEZvclJlYWR5XygpIHtcbiAgICAgICAgcmV0dXJuIHdhaXRVbnRpbF8oKCkgPT4gdGhpcy5yZWFkeSwgMTAwLCAxMDApO1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlXygpIHsgICAgICBcbiAgICAgICAgaWYgKHRoaXMucmVhZHkpIHsgIFxuICAgICAgICAgICAgdGhpcy5pbWFwLmVuZCgpO1xuXG4gICAgICAgICAgICBsZXQgZW5kZWQgPSBhd2FpdCB3YWl0VW50aWxfKCgpID0+ICF0aGlzLnJlYWR5LCAxMDAsIDMwMCk7XG5cbiAgICAgICAgICAgIGlmICghZW5kZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmltYXAuZGVzdHJveSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSAgXG4gICAgXG4gICAgc2VydmVyU3VwcG9ydHMoY2Fwcykge1xuICAgICAgICByZXR1cm4gdGhpcy5pbWFwKGNhcHMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9IE1hcCBvZiBzZXFubyB0byBtZXNzYWdlXG4gICAgICovXG4gICAgYXN5bmMgZmV0Y2hfKHNvdXJjZSwgZmV0Y2hPcHRpb25zKSB7XG4gICAgICAgIGxldCBpbWFwRmV0Y2ggPSB0aGlzLmltYXAuZmV0Y2goc291cmNlLCBmZXRjaE9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBtZXNzYWdlcyA9IFtdO1xuXG4gICAgICAgIGltYXBGZXRjaC5vbignbWVzc2FnZScsIChtc2csIHNlcW5vKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnc2Vxbm8nLCBzZXFubyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBhdHRyaWJ1dGVzO1xuICAgICAgICAgICAgbGV0IGJvZHkgPSBbXTtcblxuICAgICAgICAgICAgbXNnLm9uKCdib2R5JywgKHN0cmVhbSwgaW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGJvZHkucHVzaCh7IHNlY3Rpb246IGluZm8ud2hpY2gsIHNpemU6IGluZm8uc2l6ZSwgc3RyZWFtIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdhdHRyaWJ1dGVzJywgKGF0dHJzKSA9PiB7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJzO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh7IHNlcW5vLCBhdHRyaWJ1dGVzLCBib2R5IH0pO1xuICAgICAgICAgICAgfSk7ICAgICBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUobWVzc2FnZXMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgIFxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5mb3JPd24oc2V0dGluZ3MsIChjZmcsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgSW1hcENsaWVudChhcHAsIG5hbWUsIGNmZyk7XG4gICAgICAgICAgICBhcHAucmVnaXN0ZXJTZXJ2aWNlKGBpbWFwLiR7bmFtZX1gLCBjbGllbnQpO1xuXG4gICAgICAgICAgICBhcHAub24oJ3N0b3BwaW5nJywgKGVsZWdhbnRTdG9wcGVycykgPT4ge1xuICAgICAgICAgICAgICAgIGVsZWdhbnRTdG9wcGVycy5wdXNoKGNsaWVudC5jbG9zZV8oKSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG4iXX0=