"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this.closing = false;
    let {
      autoReconnect,
      ...imapConfig
    } = config;
    this.imap = new Imap(imapConfig);
    this.imap.on('error', error => {
      this.app.logError(error);
    });
    this.imap.on('alert', message => {
      this.app.log('warning', `The imap server [${this.name}] issues an alert. Message: ${message}`);
    });
    this.imap.on('ready', () => {
      this.ready = true;
      this.app.log('info', `The imap server [${this.name}] is ready.`);
    });
    this.imap.on('close', () => {
      this.ready = false;
      this.app.log('info', `The connection to imap server [${this.name}] is closed.`);

      if (autoReconnect && !this.closing) {
        this.imap.connect();
      }
    });
    this.imap.on('end', () => {
      this.ready = false;
      this.app.log('info', `The imap server [${this.name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
    this.imap.connect();
  }

  async waitForReady_() {
    return waitUntil_(() => this.ready, 100, 100);
  }

  async connect_() {
    if (!this.ready) {
      this.imap.connect();
      return this.waitForReady_();
    }

    return this.ready;
  }

  async close_() {
    if (this.ready) {
      this.closing = true;
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap.serverSupports(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiY2xvc2luZyIsImF1dG9SZWNvbm5lY3QiLCJpbWFwQ29uZmlnIiwiaW1hcCIsIm9uIiwiZXJyb3IiLCJsb2dFcnJvciIsIm1lc3NhZ2UiLCJsb2ciLCJyZWFkeSIsImNvbm5lY3QiLCJvcHRpb25zIiwiY29udGV4dCIsImZvckVhY2giLCJtZXRob2ROYW1lIiwicHJvbWlzaWZ5Iiwid2FpdEZvclJlYWR5XyIsImNvbm5lY3RfIiwiY2xvc2VfIiwiZW5kIiwiZW5kZWQiLCJkZXN0cm95Iiwic2VydmVyU3VwcG9ydHMiLCJjYXBzIiwiZmV0Y2hfIiwic291cmNlIiwiZmV0Y2hPcHRpb25zIiwiaW1hcEZldGNoIiwiZmV0Y2giLCJtZXNzYWdlcyIsIm1zZyIsInNlcW5vIiwiYXR0cmlidXRlcyIsImJvZHkiLCJzdHJlYW0iLCJpbmZvIiwicHVzaCIsInNlY3Rpb24iLCJ3aGljaCIsInNpemUiLCJvbmNlIiwiYXR0cnMiLCJyZXNvbHZlIiwicmVqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJTRVJWSUNFIiwibG9hZF8iLCJzZXR0aW5ncyIsImZvck93biIsImNmZyIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSIsImVsZWdhbnRTdG9wcGVycyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQUNBLE1BQU1FLElBQUksR0FBR0QsVUFBVSxDQUFDLE1BQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFB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ZUFBSixDQUFxQixRQUFPdkQsSUFBSyxFQUFqQyxFQUFvQ3NELE1BQXBDO0FBRUF2RCxNQUFBQSxHQUFHLENBQUNPLEVBQUosQ0FBTyxVQUFQLEVBQW9Ca0QsZUFBRCxJQUFxQjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDbEIsSUFBaEIsQ0FBcUJnQixNQUFNLENBQUNsQyxNQUFQLEVBQXJCO0FBQ0gsT0FGRDtBQUdILEtBUEQ7QUFRSDtBQXZCWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuY29uc3QgSW1hcCA9IHRyeVJlcXVpcmUoJ2ltYXAnKTtcbmNvbnN0IHsgXywgd2FpdFVudGlsXywgUHJvbWlzZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuY2xhc3MgSW1hcENsaWVudCB7XG4gICAgY29uc3RydWN0b3IoYXBwLCBuYW1lLCBjb25maWcpIHsgICAgICAgIFxuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsgICAgICAgIFxuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmNsb3NpbmcgPSBmYWxzZTtcblxuICAgICAgICBsZXQgeyBhdXRvUmVjb25uZWN0LCAuLi5pbWFwQ29uZmlnIH0gPSBjb25maWc7ICAgICAgICAgXG5cbiAgICAgICAgdGhpcy5pbWFwID0gbmV3IEltYXAoaW1hcENvbmZpZyk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdlcnJvcicsIGVycm9yID0+IHsgXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2dFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignYWxlcnQnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybmluZycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXNzdWVzIGFuIGFsZXJ0LiBNZXNzYWdlOiAke21lc3NhZ2V9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbigncmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXMgcmVhZHkuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignY2xvc2UnLCAoKSA9PiB7ICAgIFxuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyBcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgY29ubmVjdGlvbiB0byBpbWFwIHNlcnZlciBbJHt0aGlzLm5hbWV9XSBpcyBjbG9zZWQuYCk7XG5cbiAgICAgICAgICAgIGlmIChhdXRvUmVjb25uZWN0ICYmICF0aGlzLmNsb3NpbmcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmltYXAuY29ubmVjdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTsgICAgXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske3RoaXMubmFtZX1dIGlzIGVuZGVkLmApO1xuICAgICAgICB9KTtcblxuICAgICAgICAvL3Byb21pc2lmeSBpbWFwIGZ1bmN0aW9uc1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHsgY29udGV4dDogdGhpcy5pbWFwIH07XG5cbiAgICAgICAgW1xuICAgICAgICAgICAgJ29wZW5Cb3gnLCAnY2xvc2VCb3gnLCAnYWRkQm94JywgJ2RlbEJveCcsICdyZW5hbWVCb3gnLCAnc3Vic2NyaWJlQm94JywgJ3Vuc3Vic2NyaWJlQm94JyxcbiAgICAgICAgICAgICdzdGF0dXMnLCAnZ2V0Qm94ZXMnLCAnZ2V0U3Vic2NyaWJlZEJveGVzJywgJ2V4cHVuZ2UnLCAnYXBwZW5kJyxcbiAgICAgICAgICAgIC8vQWxsIGZ1bmN0aW9ucyBiZWxvdyBoYXZlIHNlcXVlbmNlIG51bWJlci1iYXNlZCBjb3VudGVycGFydHMgdGhhdCBcbiAgICAgICAgICAgIC8vY2FuIGJlIGFjY2Vzc2VkIGJ5IHVzaW5nIHRoZSAnc2VxJyBuYW1lc3BhY2Ugb2YgdGhlIGltYXAgY29ubmVjdGlvbidzIFxuICAgICAgICAgICAgLy9pbnN0YW5jZSAoZS5nLiBjb25uLnNlcS5zZWFyY2goKSByZXR1cm5zIHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIFxuICAgICAgICAgICAgLy9jb25uLnNlcS5mZXRjaCgpIGZldGNoZXMgYnkgc2VxdWVuY2UgbnVtYmVyKHMpIGluc3RlYWQgb2YgVUlEcywgZXRjKTpcbiAgICAgICAgICAgICdzZWFyY2gnLCAnY29weScsICdtb3ZlJywgJ2FkZEZsYWdzJywgJ2RlbEZsYWdzJywgJ3NldEZsYWdzJywgJ2FkZEtleXdvcmRzJywgJ2RlbEtleXdvcmRzJywgJ3NldEtleXdvcmRzJyxcblxuICAgICAgICAgICAgLy9nbWFpbCBleHRlbnRpb25cbiAgICAgICAgICAgICdzZXRMYWJlbHMnLCAnYWRkTGFiZWxzJywgJ2RlbExhYmVscydcbiAgICAgICAgXS5mb3JFYWNoKG1ldGhvZE5hbWUgPT4ge1xuICAgICAgICAgICAgdGhpc1ttZXRob2ROYW1lICsgJ18nXSA9IFByb21pc2UucHJvbWlzaWZ5KHRoaXMuaW1hcFttZXRob2ROYW1lXSwgb3B0aW9ucyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgfVxuXG4gICAgYXN5bmMgd2FpdEZvclJlYWR5XygpIHtcbiAgICAgICAgcmV0dXJuIHdhaXRVbnRpbF8oKCkgPT4gdGhpcy5yZWFkeSwgMTAwLCAxMDApO1xuICAgIH1cblxuICAgIGFzeW5jIGNvbm5lY3RfKCkge1xuICAgICAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53YWl0Rm9yUmVhZHlfKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5yZWFkeTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZV8oKSB7ICAgICAgXG4gICAgICAgIGlmICh0aGlzLnJlYWR5KSB7ICBcbiAgICAgICAgICAgIHRoaXMuY2xvc2luZyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmltYXAuZW5kKCk7XG5cbiAgICAgICAgICAgIGxldCBlbmRlZCA9IGF3YWl0IHdhaXRVbnRpbF8oKCkgPT4gIXRoaXMucmVhZHksIDEwMCwgMzAwKTtcblxuICAgICAgICAgICAgaWYgKCFlbmRlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW1hcC5kZXN0cm95KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9ICBcbiAgICBcbiAgICBzZXJ2ZXJTdXBwb3J0cyhjYXBzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmltYXAuc2VydmVyU3VwcG9ydHMoY2Fwcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMge29iamVjdH0gTWFwIG9mIHNlcW5vIHRvIG1lc3NhZ2VcbiAgICAgKi9cbiAgICBhc3luYyBmZXRjaF8oc291cmNlLCBmZXRjaE9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGltYXBGZXRjaCA9IHRoaXMuaW1hcC5mZXRjaChzb3VyY2UsIGZldGNoT3B0aW9ucyk7XG5cbiAgICAgICAgbGV0IG1lc3NhZ2VzID0gW107XG5cbiAgICAgICAgaW1hcEZldGNoLm9uKCdtZXNzYWdlJywgKG1zZywgc2Vxbm8pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBhdHRyaWJ1dGVzO1xuICAgICAgICAgICAgbGV0IGJvZHkgPSBbXTtcblxuICAgICAgICAgICAgbXNnLm9uKCdib2R5JywgKHN0cmVhbSwgaW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGJvZHkucHVzaCh7IHNlY3Rpb246IGluZm8ud2hpY2gsIHNpemU6IGluZm8uc2l6ZSwgc3RyZWFtIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdhdHRyaWJ1dGVzJywgKGF0dHJzKSA9PiB7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJzO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh7IHNlcW5vLCBhdHRyaWJ1dGVzLCBib2R5IH0pO1xuICAgICAgICAgICAgfSk7ICAgICBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUobWVzc2FnZXMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgIFxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5mb3JPd24oc2V0dGluZ3MsIChjZmcsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgSW1hcENsaWVudChhcHAsIG5hbWUsIGNmZyk7XG4gICAgICAgICAgICBhcHAucmVnaXN0ZXJTZXJ2aWNlKGBpbWFwLiR7bmFtZX1gLCBjbGllbnQpO1xuXG4gICAgICAgICAgICBhcHAub24oJ3N0b3BwaW5nJywgKGVsZWdhbnRTdG9wcGVycykgPT4ge1xuICAgICAgICAgICAgICAgIGVsZWdhbnRTdG9wcGVycy5wdXNoKGNsaWVudC5jbG9zZV8oKSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG4iXX0=