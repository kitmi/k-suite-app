"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this.closing = false;
    let {
      autoReconnect,
      ...imapConfig
    } = config;
    this.imap = new Imap(imapConfig);
    this.imap.on('error', error => {
      this.app.logError(error);
    });
    this.imap.on('alert', message => {
      this.app.log('warning', `The imap server [${this.name}] issues an alert. Message: ${message}`);
    });
    this.imap.on('ready', () => {
      this.ready = true;
      this.app.log('info', `The imap server [${this.name}] is ready.`);
    });
    this.imap.on('close', () => {
      this.ready = false;
      this.app.log('info', `The connection to imap server [${this.name}] is closed.`);
    });
    this.imap.on('end', () => {
      this.ready = false;
      this.app.log('info', `The imap server [${this.name}] is ended.`);

      if (autoReconnect && !this.closing) {
        this.imap.connect();
      }
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
    this.imap.connect();
  }

  async waitForReady_() {
    return waitUntil_(() => this.ready, 100, 100);
  }

  async connect_() {
    if (!this.ready) {
      this.imap.connect();
      return this.waitForReady_();
    }

    return this.ready;
  }

  async close_() {
    if (this.ready) {
      this.closing = true;
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap.serverSupports(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiY2xvc2luZyIsImF1dG9SZWNvbm5lY3QiLCJpbWFwQ29uZmlnIiwiaW1hcCIsIm9uIiwiZXJyb3IiLCJsb2dFcnJvciIsIm1lc3NhZ2UiLCJsb2ciLCJyZWFkeSIsImNvbm5lY3QiLCJvcHRpb25zIiwiY29udGV4dCIsImZvckVhY2giLCJtZXRob2ROYW1lIiwicHJvbWlzaWZ5Iiwid2FpdEZvclJlYWR5XyIsImNvbm5lY3RfIiwiY2xvc2VfIiwiZW5kIiwiZW5kZWQiLCJkZXN0cm95Iiwic2VydmVyU3VwcG9ydHMiLCJjYXBzIiwiZmV0Y2hfIiwic291cmNlIiwiZmV0Y2hPcHRpb25zIiwiaW1hcEZldGNoIiwiZmV0Y2giLCJtZXNzYWdlcyIsIm1zZyIsInNlcW5vIiwiYXR0cmlidXRlcyIsImJvZHkiLCJzdHJlYW0iLCJpbmZvIiwicHVzaCIsInNlY3Rpb24iLCJ3aGljaCIsInNpemUiLCJvbmNlIiwiYXR0cnMiLCJyZXNvbHZlIiwicmVqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJTRVJWSUNFIiwibG9hZF8iLCJzZXR0aW5ncyIsImZvck93biIsImNmZyIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSIsImVsZWdhbnRTdG9wcGVycyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQUNBLE1BQU1FLElBQUksR0FBR0QsVUFBVSxDQUFDLE1BQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFB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ZUFBSixDQUFxQixRQUFPdkQsSUFBSyxFQUFqQyxFQUFvQ3NELE1BQXBDO0FBRUF2RCxNQUFBQSxHQUFHLENBQUNPLEVBQUosQ0FBTyxVQUFQLEVBQW9Ca0QsZUFBRCxJQUFxQjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDbEIsSUFBaEIsQ0FBcUJnQixNQUFNLENBQUNsQyxNQUFQLEVBQXJCO0FBQ0gsT0FGRDtBQUdILEtBUEQ7QUFRSDtBQXZCWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuY29uc3QgSW1hcCA9IHRyeVJlcXVpcmUoJ2ltYXAnKTtcbmNvbnN0IHsgXywgd2FpdFVudGlsXywgUHJvbWlzZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuY2xhc3MgSW1hcENsaWVudCB7XG4gICAgY29uc3RydWN0b3IoYXBwLCBuYW1lLCBjb25maWcpIHsgICAgICAgIFxuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsgICAgICAgIFxuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmNsb3NpbmcgPSBmYWxzZTtcblxuICAgICAgICBsZXQgeyBhdXRvUmVjb25uZWN0LCAuLi5pbWFwQ29uZmlnIH0gPSBjb25maWc7ICAgICAgICAgXG5cbiAgICAgICAgdGhpcy5pbWFwID0gbmV3IEltYXAoaW1hcENvbmZpZyk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdlcnJvcicsIGVycm9yID0+IHsgXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2dFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignYWxlcnQnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybmluZycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXNzdWVzIGFuIGFsZXJ0LiBNZXNzYWdlOiAke21lc3NhZ2V9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbigncmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXMgcmVhZHkuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignY2xvc2UnLCAoKSA9PiB7ICAgIFxuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyBcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgY29ubmVjdGlvbiB0byBpbWFwIHNlcnZlciBbJHt0aGlzLm5hbWV9XSBpcyBjbG9zZWQuYCk7ICAgICAgICAgICBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7ICAgIFxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYFRoZSBpbWFwIHNlcnZlciBbJHt0aGlzLm5hbWV9XSBpcyBlbmRlZC5gKTtcblxuICAgICAgICAgICAgaWYgKGF1dG9SZWNvbm5lY3QgJiYgIXRoaXMuY2xvc2luZykge1xuICAgICAgICAgICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vcHJvbWlzaWZ5IGltYXAgZnVuY3Rpb25zXG4gICAgICAgIGxldCBvcHRpb25zID0geyBjb250ZXh0OiB0aGlzLmltYXAgfTtcblxuICAgICAgICBbXG4gICAgICAgICAgICAnb3BlbkJveCcsICdjbG9zZUJveCcsICdhZGRCb3gnLCAnZGVsQm94JywgJ3JlbmFtZUJveCcsICdzdWJzY3JpYmVCb3gnLCAndW5zdWJzY3JpYmVCb3gnLFxuICAgICAgICAgICAgJ3N0YXR1cycsICdnZXRCb3hlcycsICdnZXRTdWJzY3JpYmVkQm94ZXMnLCAnZXhwdW5nZScsICdhcHBlbmQnLFxuICAgICAgICAgICAgLy9BbGwgZnVuY3Rpb25zIGJlbG93IGhhdmUgc2VxdWVuY2UgbnVtYmVyLWJhc2VkIGNvdW50ZXJwYXJ0cyB0aGF0IFxuICAgICAgICAgICAgLy9jYW4gYmUgYWNjZXNzZWQgYnkgdXNpbmcgdGhlICdzZXEnIG5hbWVzcGFjZSBvZiB0aGUgaW1hcCBjb25uZWN0aW9uJ3MgXG4gICAgICAgICAgICAvL2luc3RhbmNlIChlLmcuIGNvbm4uc2VxLnNlYXJjaCgpIHJldHVybnMgc2VxdWVuY2UgbnVtYmVyKHMpIGluc3RlYWQgb2YgVUlEcywgXG4gICAgICAgICAgICAvL2Nvbm4uc2VxLmZldGNoKCkgZmV0Y2hlcyBieSBzZXF1ZW5jZSBudW1iZXIocykgaW5zdGVhZCBvZiBVSURzLCBldGMpOlxuICAgICAgICAgICAgJ3NlYXJjaCcsICdjb3B5JywgJ21vdmUnLCAnYWRkRmxhZ3MnLCAnZGVsRmxhZ3MnLCAnc2V0RmxhZ3MnLCAnYWRkS2V5d29yZHMnLCAnZGVsS2V5d29yZHMnLCAnc2V0S2V5d29yZHMnLFxuXG4gICAgICAgICAgICAvL2dtYWlsIGV4dGVudGlvblxuICAgICAgICAgICAgJ3NldExhYmVscycsICdhZGRMYWJlbHMnLCAnZGVsTGFiZWxzJ1xuICAgICAgICBdLmZvckVhY2gobWV0aG9kTmFtZSA9PiB7XG4gICAgICAgICAgICB0aGlzW21ldGhvZE5hbWUgKyAnXyddID0gUHJvbWlzZS5wcm9taXNpZnkodGhpcy5pbWFwW21ldGhvZE5hbWVdLCBvcHRpb25zKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLmNvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBhc3luYyB3YWl0Rm9yUmVhZHlfKCkge1xuICAgICAgICByZXR1cm4gd2FpdFVudGlsXygoKSA9PiB0aGlzLnJlYWR5LCAxMDAsIDEwMCk7XG4gICAgfVxuXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7XG4gICAgICAgIGlmICghdGhpcy5yZWFkeSkge1xuICAgICAgICAgICAgdGhpcy5pbWFwLmNvbm5lY3QoKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLndhaXRGb3JSZWFkeV8oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnJlYWR5O1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlXygpIHsgICAgICBcbiAgICAgICAgaWYgKHRoaXMucmVhZHkpIHsgIFxuICAgICAgICAgICAgdGhpcy5jbG9zaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuaW1hcC5lbmQoKTtcblxuICAgICAgICAgICAgbGV0IGVuZGVkID0gYXdhaXQgd2FpdFVudGlsXygoKSA9PiAhdGhpcy5yZWFkeSwgMTAwLCAzMDApO1xuXG4gICAgICAgICAgICBpZiAoIWVuZGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbWFwLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gIFxuICAgIFxuICAgIHNlcnZlclN1cHBvcnRzKGNhcHMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1hcC5zZXJ2ZXJTdXBwb3J0cyhjYXBzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBNYXAgb2Ygc2Vxbm8gdG8gbWVzc2FnZVxuICAgICAqL1xuICAgIGFzeW5jIGZldGNoXyhzb3VyY2UsIGZldGNoT3B0aW9ucykge1xuICAgICAgICBsZXQgaW1hcEZldGNoID0gdGhpcy5pbWFwLmZldGNoKHNvdXJjZSwgZmV0Y2hPcHRpb25zKTtcblxuICAgICAgICBsZXQgbWVzc2FnZXMgPSBbXTtcblxuICAgICAgICBpbWFwRmV0Y2gub24oJ21lc3NhZ2UnLCAobXNnLCBzZXFubykgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGF0dHJpYnV0ZXM7XG4gICAgICAgICAgICBsZXQgYm9keSA9IFtdO1xuXG4gICAgICAgICAgICBtc2cub24oJ2JvZHknLCAoc3RyZWFtLCBpbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgYm9keS5wdXNoKHsgc2VjdGlvbjogaW5mby53aGljaCwgc2l6ZTogaW5mby5zaXplLCBzdHJlYW0gfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbXNnLm9uY2UoJ2F0dHJpYnV0ZXMnLCAoYXR0cnMpID0+IHtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzID0gYXR0cnM7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbXNnLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsgc2Vxbm8sIGF0dHJpYnV0ZXMsIGJvZHkgfSk7XG4gICAgICAgICAgICB9KTsgICAgIFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaW1hcEZldGNoLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShtZXNzYWdlcyk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaW1hcEZldGNoLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgXG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgaW5pdCBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlNFUlZJQ0UsXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBjbGkgYXBwIG1vZHVsZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2V0dGluZ3MgLSBTZXR0aW5ncyBvZiByZXN0IGNsaWVudHMgICAgXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiBhc3luYyBmdW5jdGlvbiAoYXBwLCBzZXR0aW5ncykge1xuICAgICAgICBfLmZvck93bihzZXR0aW5ncywgKGNmZywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBJbWFwQ2xpZW50KGFwcCwgbmFtZSwgY2ZnKTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYGltYXAuJHtuYW1lfWAsIGNsaWVudCk7XG5cbiAgICAgICAgICAgIGFwcC5vbignc3RvcHBpbmcnLCAoZWxlZ2FudFN0b3BwZXJzKSA9PiB7XG4gICAgICAgICAgICAgICAgZWxlZ2FudFN0b3BwZXJzLnB1c2goY2xpZW50LmNsb3NlXygpKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTtcbiJdfQ==