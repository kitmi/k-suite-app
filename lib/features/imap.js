"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this.closing = false;
    let {
      autoReconnect,
      ...imapConfig
    } = config;
    this.imap = new Imap(imapConfig);
    this.imap.on('error', error => {
      this.error = error;
      this.app.logError(error);
    });
    this.imap.on('alert', message => {
      this.app.log('warning', `The imap server [${this.name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      this.app.log('info', `The imap server [${this.name}] is ready.`);
    });
    this.imap.once('close', () => {
      this.ready = false;
      this.app.log('info', `The connection to imap server [${this.name}] is closed.`);

      if (autoReconnect && !this.closing) {
        this.imap.connect();
      }
    });
    this.imap.once('end', () => {
      this.ready = false;
      this.app.log('info', `The imap server [${this.name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
    this.imap.connect();
  }

  async waitForReady_() {
    return waitUntil_(() => this.ready, 100, 100);
  }

  async connect_() {
    if (!this.ready) {
      this.imap.connect();
      return this.waitForReady_();
    }

    return this.ready;
  }

  async close_() {
    if (this.ready) {
      this.closing = true;
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap.serverSupports(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiY2xvc2luZyIsImF1dG9SZWNvbm5lY3QiLCJpbWFwQ29uZmlnIiwiaW1hcCIsIm9uIiwiZXJyb3IiLCJsb2dFcnJvciIsIm1lc3NhZ2UiLCJsb2ciLCJvbmNlIiwicmVhZHkiLCJjb25uZWN0Iiwib3B0aW9ucyIsImNvbnRleHQiLCJmb3JFYWNoIiwibWV0aG9kTmFtZSIsInByb21pc2lmeSIsIndhaXRGb3JSZWFkeV8iLCJjb25uZWN0XyIsImNsb3NlXyIsImVuZCIsImVuZGVkIiwiZGVzdHJveSIsInNlcnZlclN1cHBvcnRzIiwiY2FwcyIsImZldGNoXyIsInNvdXJjZSIsImZldGNoT3B0aW9ucyIsImltYXBGZXRjaCIsImZldGNoIiwibWVzc2FnZXMiLCJtc2ciLCJzZXFubyIsImF0dHJpYnV0ZXMiLCJib2R5Iiwic3RyZWFtIiwiaW5mbyIsInB1c2giLCJzZWN0aW9uIiwid2hpY2giLCJzaXplIiwiYXR0cnMiLCJyZXNvbHZlIiwicmVqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJTRVJWSUNFIiwibG9hZF8iLCJzZXR0aW5ncyIsImZvck93biIsImNmZyIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSIsImVsZWdhbnRTdG9wcGVycyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQUNBLE1BQU1FLElBQUksR0FBR0QsVUFBVSxDQUFDLE1BQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFB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Q0FBYjtBQUNBdEQsTUFBQUEsR0FBRyxDQUFDd0QsZUFBSixDQUFxQixRQUFPdkQsSUFBSyxFQUFqQyxFQUFvQ3NELE1BQXBDO0FBRUF2RCxNQUFBQSxHQUFHLENBQUNPLEVBQUosQ0FBTyxVQUFQLEVBQW9Ca0QsZUFBRCxJQUFxQjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDakIsSUFBaEIsQ0FBcUJlLE1BQU0sQ0FBQ2pDLE1BQVAsRUFBckI7QUFDSCxPQUZEO0FBR0gsS0FQRDtBQVFIO0FBdkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBJbWFwID0gdHJ5UmVxdWlyZSgnaW1hcCcpO1xuY29uc3QgeyBfLCB3YWl0VW50aWxfLCBQcm9taXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jbGFzcyBJbWFwQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIG5hbWUsIGNvbmZpZykgeyAgICAgICAgXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOyAgICAgICAgXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMuY2xvc2luZyA9IGZhbHNlO1xuXG4gICAgICAgIGxldCB7IGF1dG9SZWNvbm5lY3QsIC4uLmltYXBDb25maWcgfSA9IGNvbmZpZzsgICAgICAgICBcblxuICAgICAgICB0aGlzLmltYXAgPSBuZXcgSW1hcChpbWFwQ29uZmlnKTtcblxuICAgICAgICB0aGlzLmltYXAub24oJ2Vycm9yJywgZXJyb3IgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5lcnJvciA9IGVycm9yO1xuICAgICAgICAgICAgdGhpcy5hcHAubG9nRXJyb3IoZXJyb3IpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub24oJ2FsZXJ0JywgbWVzc2FnZSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ3dhcm5pbmcnLCBgVGhlIGltYXAgc2VydmVyIFske3RoaXMubmFtZX1dIGlzc3VlcyBhbiBhbGVydC4gTWVzc2FnZTogJHttZXNzYWdlfWApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgncmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7dGhpcy5uYW1lfV0gaXMgcmVhZHkuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbmNlKCdjbG9zZScsICgpID0+IHsgICAgXG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7IFxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYFRoZSBjb25uZWN0aW9uIHRvIGltYXAgc2VydmVyIFske3RoaXMubmFtZX1dIGlzIGNsb3NlZC5gKTtcblxuICAgICAgICAgICAgaWYgKGF1dG9SZWNvbm5lY3QgJiYgIXRoaXMuY2xvc2luZykge1xuICAgICAgICAgICAgICAgIHRoaXMuaW1hcC5jb25uZWN0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7ICAgIFxuICAgICAgICAgICAgdGhpcy5hcHAubG9nKCdpbmZvJywgYFRoZSBpbWFwIHNlcnZlciBbJHt0aGlzLm5hbWV9XSBpcyBlbmRlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9wcm9taXNpZnkgaW1hcCBmdW5jdGlvbnNcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7IGNvbnRleHQ6IHRoaXMuaW1hcCB9O1xuXG4gICAgICAgIFtcbiAgICAgICAgICAgICdvcGVuQm94JywgJ2Nsb3NlQm94JywgJ2FkZEJveCcsICdkZWxCb3gnLCAncmVuYW1lQm94JywgJ3N1YnNjcmliZUJveCcsICd1bnN1YnNjcmliZUJveCcsXG4gICAgICAgICAgICAnc3RhdHVzJywgJ2dldEJveGVzJywgJ2dldFN1YnNjcmliZWRCb3hlcycsICdleHB1bmdlJywgJ2FwcGVuZCcsXG4gICAgICAgICAgICAvL0FsbCBmdW5jdGlvbnMgYmVsb3cgaGF2ZSBzZXF1ZW5jZSBudW1iZXItYmFzZWQgY291bnRlcnBhcnRzIHRoYXQgXG4gICAgICAgICAgICAvL2NhbiBiZSBhY2Nlc3NlZCBieSB1c2luZyB0aGUgJ3NlcScgbmFtZXNwYWNlIG9mIHRoZSBpbWFwIGNvbm5lY3Rpb24ncyBcbiAgICAgICAgICAgIC8vaW5zdGFuY2UgKGUuZy4gY29ubi5zZXEuc2VhcmNoKCkgcmV0dXJucyBzZXF1ZW5jZSBudW1iZXIocykgaW5zdGVhZCBvZiBVSURzLCBcbiAgICAgICAgICAgIC8vY29ubi5zZXEuZmV0Y2goKSBmZXRjaGVzIGJ5IHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIGV0Yyk6XG4gICAgICAgICAgICAnc2VhcmNoJywgJ2NvcHknLCAnbW92ZScsICdhZGRGbGFncycsICdkZWxGbGFncycsICdzZXRGbGFncycsICdhZGRLZXl3b3JkcycsICdkZWxLZXl3b3JkcycsICdzZXRLZXl3b3JkcycsXG5cbiAgICAgICAgICAgIC8vZ21haWwgZXh0ZW50aW9uXG4gICAgICAgICAgICAnc2V0TGFiZWxzJywgJ2FkZExhYmVscycsICdkZWxMYWJlbHMnXG4gICAgICAgIF0uZm9yRWFjaChtZXRob2ROYW1lID0+IHtcbiAgICAgICAgICAgIHRoaXNbbWV0aG9kTmFtZSArICdfJ10gPSBQcm9taXNlLnByb21pc2lmeSh0aGlzLmltYXBbbWV0aG9kTmFtZV0sIG9wdGlvbnMpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAuY29ubmVjdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIHdhaXRGb3JSZWFkeV8oKSB7XG4gICAgICAgIHJldHVybiB3YWl0VW50aWxfKCgpID0+IHRoaXMucmVhZHksIDEwMCwgMTAwKTtcbiAgICB9XG5cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgICAgICB0aGlzLmltYXAuY29ubmVjdCgpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMud2FpdEZvclJlYWR5XygpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucmVhZHk7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2VfKCkgeyAgICAgIFxuICAgICAgICBpZiAodGhpcy5yZWFkeSkgeyAgXG4gICAgICAgICAgICB0aGlzLmNsb3NpbmcgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5pbWFwLmVuZCgpO1xuXG4gICAgICAgICAgICBsZXQgZW5kZWQgPSBhd2FpdCB3YWl0VW50aWxfKCgpID0+ICF0aGlzLnJlYWR5LCAxMDAsIDMwMCk7XG5cbiAgICAgICAgICAgIGlmICghZW5kZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmltYXAuZGVzdHJveSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSAgXG4gICAgXG4gICAgc2VydmVyU3VwcG9ydHMoY2Fwcykge1xuICAgICAgICByZXR1cm4gdGhpcy5pbWFwLnNlcnZlclN1cHBvcnRzKGNhcHMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9IE1hcCBvZiBzZXFubyB0byBtZXNzYWdlXG4gICAgICovXG4gICAgYXN5bmMgZmV0Y2hfKHNvdXJjZSwgZmV0Y2hPcHRpb25zKSB7XG4gICAgICAgIGxldCBpbWFwRmV0Y2ggPSB0aGlzLmltYXAuZmV0Y2goc291cmNlLCBmZXRjaE9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBtZXNzYWdlcyA9IFtdO1xuXG4gICAgICAgIGltYXBGZXRjaC5vbignbWVzc2FnZScsIChtc2csIHNlcW5vKSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgYXR0cmlidXRlcztcbiAgICAgICAgICAgIGxldCBib2R5ID0gW107XG5cbiAgICAgICAgICAgIG1zZy5vbignYm9keScsIChzdHJlYW0sIGluZm8pID0+IHtcbiAgICAgICAgICAgICAgICBib2R5LnB1c2goeyBzZWN0aW9uOiBpbmZvLndoaWNoLCBzaXplOiBpbmZvLnNpemUsIHN0cmVhbSB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBtc2cub25jZSgnYXR0cmlidXRlcycsIChhdHRycykgPT4ge1xuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSBhdHRycztcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBtc2cub25jZSgnZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2goeyBzZXFubywgYXR0cmlidXRlcywgYm9keSB9KTtcbiAgICAgICAgICAgIH0pOyAgICAgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBpbWFwRmV0Y2gub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG1lc3NhZ2VzKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpbWFwRmV0Y2gub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTsgICAgICAgICAgICAgICBcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBpbml0IHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuU0VSVklDRSxcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGNsaSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZXR0aW5ncyAtIFNldHRpbmdzIG9mIHJlc3QgY2xpZW50cyAgICBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IGFzeW5jIGZ1bmN0aW9uIChhcHAsIHNldHRpbmdzKSB7XG4gICAgICAgIF8uZm9yT3duKHNldHRpbmdzLCAoY2ZnLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IEltYXBDbGllbnQoYXBwLCBuYW1lLCBjZmcpO1xuICAgICAgICAgICAgYXBwLnJlZ2lzdGVyU2VydmljZShgaW1hcC4ke25hbWV9YCwgY2xpZW50KTtcblxuICAgICAgICAgICAgYXBwLm9uKCdzdG9wcGluZycsIChlbGVnYW50U3RvcHBlcnMpID0+IHtcbiAgICAgICAgICAgICAgICBlbGVnYW50U3RvcHBlcnMucHVzaChjbGllbnQuY2xvc2VfKCkpOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuIl19