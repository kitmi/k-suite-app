"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.name = name;
    this.config = config;
    this._requireReset = false;

    this._reset();
  }

  _reset() {
    this.imap = new Imap(this.config);
    this.imap.on('error', error => {
      this.error = error;
      this.app.logError(error);
    });
    this.imap.on('alert', message => {
      this.app.log('warning', `The imap server [${name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      this.app.log('info', `The imap server [${name}] is ready.`);
    });
    this.imap.once('close', () => {
      this.ready = false;
      this._requireReset = true;
      this.app.log('info', `The connection to imap server [${name}] is closed.`);
    });
    this.imap.once('end', () => {
      this.ready = false;
      this._requireReset = true;
      this.app.log('info', `The imap server [${name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords', 'setLabels', 'addLabels', 'delLabels'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
  }

  async connect_() {
    if (!this.ready) {
      if (this._requireReset) {
        this._reset();
      }

      this.imap.connect();
      return waitUntil_(() => this.ready, 100, 100);
    }

    return this.ready;
  }

  async close_() {
    if (this.ready) {
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiX3JlcXVpcmVSZXNldCIsIl9yZXNldCIsImltYXAiLCJvbiIsImVycm9yIiwibG9nRXJyb3IiLCJtZXNzYWdlIiwibG9nIiwib25jZSIsInJlYWR5Iiwib3B0aW9ucyIsImNvbnRleHQiLCJmb3JFYWNoIiwibWV0aG9kTmFtZSIsInByb21pc2lmeSIsImNvbm5lY3RfIiwiY29ubmVjdCIsImNsb3NlXyIsImVuZCIsImVuZGVkIiwiZGVzdHJveSIsInNlcnZlclN1cHBvcnRzIiwiY2FwcyIsImZldGNoXyIsInNvdXJjZSIsImZldGNoT3B0aW9ucyIsImltYXBGZXRjaCIsImZldGNoIiwibWVzc2FnZXMiLCJtc2ciLCJzZXFubyIsImF0dHJpYnV0ZXMiLCJib2R5Iiwic3RyZWFtIiwiaW5mbyIsInB1c2giLCJzZWN0aW9uIiwid2hpY2giLCJzaXplIiwiYXR0cnMiLCJyZXNvbHZlIiwicmVqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJTRVJWSUNFIiwibG9hZF8iLCJzZXR0aW5ncyIsImZvck93biIsImNmZyIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSIsImVsZWdhbnRTdG9wcGVycyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQUNBLE1BQU1FLElBQUksR0FBR0QsVUFBVSxDQUFDLE1BQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLFVBQUw7QUFBaUJD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Q0FBQ2pCLElBQWhCLENBQXFCZSxNQUFNLENBQUNqQyxNQUFQLEVBQXJCO0FBQ0gsT0FGRDtBQUdILEtBUEQ7QUFRSDtBQXZCWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuY29uc3QgSW1hcCA9IHRyeVJlcXVpcmUoJ2ltYXAnKTtcbmNvbnN0IHsgXywgd2FpdFVudGlsXywgUHJvbWlzZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuY2xhc3MgSW1hcENsaWVudCB7XG4gICAgY29uc3RydWN0b3IoYXBwLCBuYW1lLCBjb25maWcpIHsgICAgICAgIFxuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMuX3JlcXVpcmVSZXNldCA9IGZhbHNlO1xuICAgICAgIFxuICAgICAgICB0aGlzLl9yZXNldCgpO1xuICAgIH1cblxuICAgIF9yZXNldCgpIHtcbiAgICAgICAgdGhpcy5pbWFwID0gbmV3IEltYXAodGhpcy5jb25maWcpO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignZXJyb3InLCBlcnJvciA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVycm9yID0gZXJyb3I7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2dFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignYWxlcnQnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnd2FybmluZycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzc3VlcyBhbiBhbGVydC4gTWVzc2FnZTogJHttZXNzYWdlfWApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgncmVhZHknLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzIHJlYWR5LmApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgnY2xvc2UnLCAoKSA9PiB7ICAgIFxuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyBcbiAgICAgICAgICAgIHRoaXMuX3JlcXVpcmVSZXNldCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgVGhlIGNvbm5lY3Rpb24gdG8gaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzIGNsb3NlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTsgICAgICAgXG4gICAgICAgICAgICB0aGlzLl9yZXF1aXJlUmVzZXQgPSB0cnVlOyAgICAgXG4gICAgICAgICAgICB0aGlzLmFwcC5sb2coJ2luZm8nLCBgVGhlIGltYXAgc2VydmVyIFske25hbWV9XSBpcyBlbmRlZC5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9wcm9taXNpZnkgaW1hcCBmdW5jdGlvbnNcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7IGNvbnRleHQ6IHRoaXMuaW1hcCB9O1xuXG4gICAgICAgIFtcbiAgICAgICAgICAgICdvcGVuQm94JywgJ2Nsb3NlQm94JywgJ2FkZEJveCcsICdkZWxCb3gnLCAncmVuYW1lQm94JywgJ3N1YnNjcmliZUJveCcsICd1bnN1YnNjcmliZUJveCcsXG4gICAgICAgICAgICAnc3RhdHVzJywgJ2dldEJveGVzJywgJ2dldFN1YnNjcmliZWRCb3hlcycsICdleHB1bmdlJywgJ2FwcGVuZCcsXG4gICAgICAgICAgICAvL0FsbCBmdW5jdGlvbnMgYmVsb3cgaGF2ZSBzZXF1ZW5jZSBudW1iZXItYmFzZWQgY291bnRlcnBhcnRzIHRoYXQgXG4gICAgICAgICAgICAvL2NhbiBiZSBhY2Nlc3NlZCBieSB1c2luZyB0aGUgJ3NlcScgbmFtZXNwYWNlIG9mIHRoZSBpbWFwIGNvbm5lY3Rpb24ncyBcbiAgICAgICAgICAgIC8vaW5zdGFuY2UgKGUuZy4gY29ubi5zZXEuc2VhcmNoKCkgcmV0dXJucyBzZXF1ZW5jZSBudW1iZXIocykgaW5zdGVhZCBvZiBVSURzLCBcbiAgICAgICAgICAgIC8vY29ubi5zZXEuZmV0Y2goKSBmZXRjaGVzIGJ5IHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIGV0Yyk6XG4gICAgICAgICAgICAnc2VhcmNoJywgJ2NvcHknLCAnbW92ZScsICdhZGRGbGFncycsICdkZWxGbGFncycsICdzZXRGbGFncycsICdhZGRLZXl3b3JkcycsICdkZWxLZXl3b3JkcycsICdzZXRLZXl3b3JkcycsXG5cbiAgICAgICAgICAgIC8vZ21haWwgZXh0ZW50aW9uXG4gICAgICAgICAgICAnc2V0TGFiZWxzJywgJ2FkZExhYmVscycsICdkZWxMYWJlbHMnXG4gICAgICAgIF0uZm9yRWFjaChtZXRob2ROYW1lID0+IHtcbiAgICAgICAgICAgIHRoaXNbbWV0aG9kTmFtZSArICdfJ10gPSBQcm9taXNlLnByb21pc2lmeSh0aGlzLmltYXBbbWV0aG9kTmFtZV0sIG9wdGlvbnMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcmVxdWlyZVJlc2V0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmVzZXQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5pbWFwLmNvbm5lY3QoKTtcbiAgICAgICAgICAgIHJldHVybiB3YWl0VW50aWxfKCgpID0+IHRoaXMucmVhZHksIDEwMCwgMTAwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnJlYWR5O1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlXygpIHsgICAgICBcbiAgICAgICAgaWYgKHRoaXMucmVhZHkpIHsgIFxuICAgICAgICAgICAgdGhpcy5pbWFwLmVuZCgpO1xuXG4gICAgICAgICAgICBsZXQgZW5kZWQgPSBhd2FpdCB3YWl0VW50aWxfKCgpID0+ICF0aGlzLnJlYWR5LCAxMDAsIDMwMCk7XG5cbiAgICAgICAgICAgIGlmICghZW5kZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmltYXAuZGVzdHJveSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSAgXG4gICAgXG4gICAgc2VydmVyU3VwcG9ydHMoY2Fwcykge1xuICAgICAgICByZXR1cm4gdGhpcy5pbWFwKGNhcHMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9IE1hcCBvZiBzZXFubyB0byBtZXNzYWdlXG4gICAgICovXG4gICAgYXN5bmMgZmV0Y2hfKHNvdXJjZSwgZmV0Y2hPcHRpb25zKSB7XG4gICAgICAgIGxldCBpbWFwRmV0Y2ggPSB0aGlzLmltYXAuZmV0Y2goc291cmNlLCBmZXRjaE9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBtZXNzYWdlcyA9IFtdO1xuXG4gICAgICAgIGltYXBGZXRjaC5vbignbWVzc2FnZScsIChtc2csIHNlcW5vKSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgYXR0cmlidXRlcztcbiAgICAgICAgICAgIGxldCBib2R5ID0gW107XG5cbiAgICAgICAgICAgIG1zZy5vbignYm9keScsIChzdHJlYW0sIGluZm8pID0+IHtcbiAgICAgICAgICAgICAgICBib2R5LnB1c2goeyBzZWN0aW9uOiBpbmZvLndoaWNoLCBzaXplOiBpbmZvLnNpemUsIHN0cmVhbSB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBtc2cub25jZSgnYXR0cmlidXRlcycsIChhdHRycykgPT4ge1xuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSBhdHRycztcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBtc2cub25jZSgnZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2goeyBzZXFubywgYXR0cmlidXRlcywgYm9keSB9KTtcbiAgICAgICAgICAgIH0pOyAgICAgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBpbWFwRmV0Y2gub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG1lc3NhZ2VzKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpbWFwRmV0Y2gub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTsgICAgICAgICAgICAgICBcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBpbml0IHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuU0VSVklDRSxcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGNsaSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZXR0aW5ncyAtIFNldHRpbmdzIG9mIHJlc3QgY2xpZW50cyAgICBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IGFzeW5jIGZ1bmN0aW9uIChhcHAsIHNldHRpbmdzKSB7XG4gICAgICAgIF8uZm9yT3duKHNldHRpbmdzLCAoY2ZnLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IEltYXBDbGllbnQoYXBwLCBuYW1lLCBjZmcpO1xuICAgICAgICAgICAgYXBwLnJlZ2lzdGVyU2VydmljZShgaW1hcC4ke25hbWV9YCwgY2xpZW50KTtcblxuICAgICAgICAgICAgYXBwLm9uKCdzdG9wcGluZycsIChlbGVnYW50U3RvcHBlcnMpID0+IHtcbiAgICAgICAgICAgICAgICBlbGVnYW50U3RvcHBlcnMucHVzaChjbGllbnQuY2xvc2VfKCkpOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuIl19