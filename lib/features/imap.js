"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const Imap = tryRequire('imap');

const {
  _,
  waitUntil_,
  Promise
} = require('rk-utils');

class ImapClient {
  constructor(app, name, config) {
    this.app = app;
    this.config = config;
    this.imap = new Imap(config);
    this.imap.on('error', error => {
      this.error = error;
      app.logError(error);
    });
    this.imap.on('alert', message => {
      app.log('warning', `The imap server [${name}] issues an alert. Message: ${message}`);
    });
    this.imap.once('ready', () => {
      this.ready = true;
      app.log('info', `The imap server [${name}] is ready.`);
    });
    this.imap.once('close', () => {
      this.ready = false;
      app.log('info', `The connection to imap server [${name}] is closed.`);
    });
    this.imap.once('end', () => {
      this.ready = false;
      app.log('info', `The imap server [${name}] is ended.`);
    });
    let options = {
      context: this.imap
    };
    ['openBox', 'closeBox', 'addBox', 'delBox', 'renameBox', 'subscribeBox', 'unsubscribeBox', 'status', 'getBoxes', 'getSubscribedBoxes', 'expunge', 'append', 'search', 'copy', 'move', 'addFlags', 'delFlags', 'setFlags', 'addKeywords', 'delKeywords', 'setKeywords'].forEach(methodName => {
      this[methodName + '_'] = Promise.promisify(this.imap[methodName], options);
    });
    this.imap.connect();
  }

  async waitForReady_() {
    return waitUntil_(() => this.ready, 100, 100);
  }

  async close_() {
    if (this.ready) {
      this.imap.end();
      let ended = await waitUntil_(() => !this.ready, 100, 300);

      if (!ended) {
        this.imap.destroy();
      }
    }
  }

  serverSupports(caps) {
    return this.imap(caps);
  }

  async fetch_(source, fetchOptions) {
    let imapFetch = this.imap.fetch(source, fetchOptions);
    let messages = [];
    imapFetch.on('message', (msg, seqno) => {
      let attributes;
      let body = [];
      msg.on('body', (stream, info) => {
        body.push({
          section: info.which,
          size: info.size,
          stream
        });
      });
      msg.once('attributes', attrs => {
        attributes = attrs;
      });
      msg.once('end', () => {
        messages.push({
          seqno,
          attributes,
          body
        });
      });
    });
    return await new Promise((resolve, reject) => {
      imapFetch.on('end', () => {
        resolve(messages);
      });
      imapFetch.on('error', error => {
        reject(error);
      });
    });
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.forOwn(settings, (cfg, name) => {
      let client = new ImapClient(app, name, cfg);
      app.registerService(`imap.${name}`, client);
      app.on('stopping', elegantStoppers => {
        elegantStoppers.push(client.close_());
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9pbWFwLmpzIl0sIm5hbWVzIjpbIkZlYXR1cmUiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkltYXAiLCJfIiwid2FpdFVudGlsXyIsIlByb21pc2UiLCJJbWFwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJhcHAiLCJuYW1lIiwiY29uZmlnIiwiaW1hcCIsIm9uIiwiZXJyb3IiLCJsb2dFcnJvciIsIm1lc3NhZ2UiLCJsb2ciLCJvbmNlIiwicmVhZHkiLCJvcHRpb25zIiwiY29udGV4dCIsImZvckVhY2giLCJtZXRob2ROYW1lIiwicHJvbWlzaWZ5IiwiY29ubmVjdCIsIndhaXRGb3JSZWFkeV8iLCJjbG9zZV8iLCJlbmQiLCJlbmRlZCIsImRlc3Ryb3kiLCJzZXJ2ZXJTdXBwb3J0cyIsImNhcHMiLCJmZXRjaF8iLCJzb3VyY2UiLCJmZXRjaE9wdGlvbnMiLCJpbWFwRmV0Y2giLCJmZXRjaCIsIm1lc3NhZ2VzIiwibXNnIiwic2Vxbm8iLCJhdHRyaWJ1dGVzIiwiYm9keSIsInN0cmVhbSIsImluZm8iLCJwdXNoIiwic2VjdGlvbiIsIndoaWNoIiwic2l6ZSIsImF0dHJzIiwicmVzb2x2ZSIsInJlamVjdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwic2V0dGluZ3MiLCJmb3JPd24iLCJjZmciLCJjbGllbnQiLCJyZWdpc3RlclNlcnZpY2UiLCJlbGVnYW50U3RvcHBlcnMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxrQkFBRCxDQUE5Qjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdELFVBQVUsQ0FBQyxNQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxVQUFMO0FBQWlCQyxFQUFBQTtBQUFqQixJQUE2Qkws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LFFBQUQsQ0FBUDtBQUNILE9BRkQ7QUFJQUYsTUFBQUEsU0FBUyxDQUFDdkIsRUFBVixDQUFhLE9BQWIsRUFBdUJDLEtBQUQsSUFBVztBQUM3QnFDLFFBQUFBLE1BQU0sQ0FBQ3JDLEtBQUQsQ0FBTjtBQUNILE9BRkQ7QUFHSCxLQVJZLENBQWI7QUFTSDs7QUF0R1k7O0FBeUdqQnNDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQU1iQyxFQUFBQSxJQUFJLEVBQUV0RCxPQUFPLENBQUN1RCxPQU5EO0FBY2JDLEVBQUFBLEtBQUssRUFBRSxnQkFBZ0IvQyxHQUFoQixFQUFxQmdELFFBQXJCLEVBQStCO0FBQ2xDckQsSUFBQUEsQ0FBQyxDQUFDc0QsTUFBRixDQUFTRCxRQUFULEVBQW1CLENBQUNFLEdBQUQsRUFBTWpELElBQU4sS0FBZTtBQUM5QixVQUFJa0QsTUFBTSxHQUFHLElBQUlyRCxVQUFKLENBQWVFLEdBQWYsRUFBb0JDLElBQXBCLEVBQTBCaUQsR0FBMUIsQ0FBYjtBQUNBbEQsTUFBQUEsR0FBRyxDQUFDb0QsZUFBSixDQUFxQixRQUFPbkQsSUFBSyxFQUFqQyxFQUFvQ2tELE1BQXBDO0FBRUFuRCxNQUFBQSxHQUFHLENBQUNJLEVBQUosQ0FBTyxVQUFQLEVBQW9CaUQsZUFBRCxJQUFxQjtBQUNwQ0EsUUFBQUEsZUFBZSxDQUFDakIsSUFBaEIsQ0FBcUJlLE1BQU0sQ0FBQ2pDLE1BQVAsRUFBckI7QUFDSCxPQUZEO0FBR0gsS0FQRDtBQVFIO0FBdkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBJbWFwID0gdHJ5UmVxdWlyZSgnaW1hcCcpO1xuY29uc3QgeyBfLCB3YWl0VW50aWxfLCBQcm9taXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jbGFzcyBJbWFwQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihhcHAsIG5hbWUsIGNvbmZpZykge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMuaW1hcCA9IG5ldyBJbWFwKGNvbmZpZyk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uKCdlcnJvcicsIGVycm9yID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBlcnJvcjtcbiAgICAgICAgICAgIGFwcC5sb2dFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbignYWxlcnQnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgIGFwcC5sb2coJ3dhcm5pbmcnLCBgVGhlIGltYXAgc2VydmVyIFske25hbWV9XSBpc3N1ZXMgYW4gYWxlcnQuIE1lc3NhZ2U6ICR7bWVzc2FnZX1gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLm9uY2UoJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XG4gICAgICAgICAgICBhcHAubG9nKCdpbmZvJywgYFRoZSBpbWFwIHNlcnZlciBbJHtuYW1lfV0gaXMgcmVhZHkuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaW1hcC5vbmNlKCdjbG9zZScsICgpID0+IHsgICAgXG4gICAgICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7IFxuICAgICAgICAgICAgYXBwLmxvZygnaW5mbycsIGBUaGUgY29ubmVjdGlvbiB0byBpbWFwIHNlcnZlciBbJHtuYW1lfV0gaXMgY2xvc2VkLmApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmltYXAub25jZSgnZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlOyAgICAgICAgICAgIFxuICAgICAgICAgICAgYXBwLmxvZygnaW5mbycsIGBUaGUgaW1hcCBzZXJ2ZXIgWyR7bmFtZX1dIGlzIGVuZGVkLmApO1xuICAgICAgICB9KTtcblxuICAgICAgICAvL3Byb21pc2lmeSBpbWFwIGZ1bmN0aW9uc1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHsgY29udGV4dDogdGhpcy5pbWFwIH07XG5cbiAgICAgICAgW1xuICAgICAgICAgICAgJ29wZW5Cb3gnLCAnY2xvc2VCb3gnLCAnYWRkQm94JywgJ2RlbEJveCcsICdyZW5hbWVCb3gnLCAnc3Vic2NyaWJlQm94JywgJ3Vuc3Vic2NyaWJlQm94JyxcbiAgICAgICAgICAgICdzdGF0dXMnLCAnZ2V0Qm94ZXMnLCAnZ2V0U3Vic2NyaWJlZEJveGVzJywgJ2V4cHVuZ2UnLCAnYXBwZW5kJyxcbiAgICAgICAgICAgIC8vQWxsIGZ1bmN0aW9ucyBiZWxvdyBoYXZlIHNlcXVlbmNlIG51bWJlci1iYXNlZCBjb3VudGVycGFydHMgdGhhdCBcbiAgICAgICAgICAgIC8vY2FuIGJlIGFjY2Vzc2VkIGJ5IHVzaW5nIHRoZSAnc2VxJyBuYW1lc3BhY2Ugb2YgdGhlIGltYXAgY29ubmVjdGlvbidzIFxuICAgICAgICAgICAgLy9pbnN0YW5jZSAoZS5nLiBjb25uLnNlcS5zZWFyY2goKSByZXR1cm5zIHNlcXVlbmNlIG51bWJlcihzKSBpbnN0ZWFkIG9mIFVJRHMsIFxuICAgICAgICAgICAgLy9jb25uLnNlcS5mZXRjaCgpIGZldGNoZXMgYnkgc2VxdWVuY2UgbnVtYmVyKHMpIGluc3RlYWQgb2YgVUlEcywgZXRjKTpcbiAgICAgICAgICAgICdzZWFyY2gnLCAnY29weScsICdtb3ZlJywgJ2FkZEZsYWdzJywgJ2RlbEZsYWdzJywgJ3NldEZsYWdzJywgJ2FkZEtleXdvcmRzJywgJ2RlbEtleXdvcmRzJywgJ3NldEtleXdvcmRzJ1xuICAgICAgICBdLmZvckVhY2gobWV0aG9kTmFtZSA9PiB7XG4gICAgICAgICAgICB0aGlzW21ldGhvZE5hbWUgKyAnXyddID0gUHJvbWlzZS5wcm9taXNpZnkodGhpcy5pbWFwW21ldGhvZE5hbWVdLCBvcHRpb25zKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5pbWFwLmNvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBhc3luYyB3YWl0Rm9yUmVhZHlfKCkge1xuICAgICAgICByZXR1cm4gd2FpdFVudGlsXygoKSA9PiB0aGlzLnJlYWR5LCAxMDAsIDEwMCk7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2VfKCkgeyAgICAgIFxuICAgICAgICBpZiAodGhpcy5yZWFkeSkgeyAgXG4gICAgICAgICAgICB0aGlzLmltYXAuZW5kKCk7XG5cbiAgICAgICAgICAgIGxldCBlbmRlZCA9IGF3YWl0IHdhaXRVbnRpbF8oKCkgPT4gIXRoaXMucmVhZHksIDEwMCwgMzAwKTtcblxuICAgICAgICAgICAgaWYgKCFlbmRlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW1hcC5kZXN0cm95KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9ICBcbiAgICBcbiAgICBzZXJ2ZXJTdXBwb3J0cyhjYXBzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmltYXAoY2Fwcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMge29iamVjdH0gTWFwIG9mIHNlcW5vIHRvIG1lc3NhZ2VcbiAgICAgKi9cbiAgICBhc3luYyBmZXRjaF8oc291cmNlLCBmZXRjaE9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGltYXBGZXRjaCA9IHRoaXMuaW1hcC5mZXRjaChzb3VyY2UsIGZldGNoT3B0aW9ucyk7XG5cbiAgICAgICAgbGV0IG1lc3NhZ2VzID0gW107XG5cbiAgICAgICAgaW1hcEZldGNoLm9uKCdtZXNzYWdlJywgKG1zZywgc2Vxbm8pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBhdHRyaWJ1dGVzO1xuICAgICAgICAgICAgbGV0IGJvZHkgPSBbXTtcblxuICAgICAgICAgICAgbXNnLm9uKCdib2R5JywgKHN0cmVhbSwgaW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGJvZHkucHVzaCh7IHNlY3Rpb246IGluZm8ud2hpY2gsIHNpemU6IGluZm8uc2l6ZSwgc3RyZWFtIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdhdHRyaWJ1dGVzJywgKGF0dHJzKSA9PiB7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlcyA9IGF0dHJzO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1zZy5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh7IHNlcW5vLCBhdHRyaWJ1dGVzLCBib2R5IH0pO1xuICAgICAgICAgICAgfSk7ICAgICBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUobWVzc2FnZXMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGltYXBGZXRjaC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgIFxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5mb3JPd24oc2V0dGluZ3MsIChjZmcsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgSW1hcENsaWVudChhcHAsIG5hbWUsIGNmZyk7XG4gICAgICAgICAgICBhcHAucmVnaXN0ZXJTZXJ2aWNlKGBpbWFwLiR7bmFtZX1gLCBjbGllbnQpO1xuXG4gICAgICAgICAgICBhcHAub24oJ3N0b3BwaW5nJywgKGVsZWdhbnRTdG9wcGVycykgPT4ge1xuICAgICAgICAgICAgICAgIGVsZWdhbnRTdG9wcGVycy5wdXNoKGNsaWVudC5jbG9zZV8oKSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG4iXX0=