"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const AllowedMethods = {
  'get': 'get',
  'post': 'post',
  'put': 'put',
  'del': 'del',
  'delete': 'del',
  'upload': 'post',
  'download': 'get'
};

class RestClient {
  constructor(endpoint, onSendHandler) {
    this.agent = tryRequire('superagent');
    this.endpoint = endpoint.endsWith('/') ? endpoint : endpoint + '/';
    this.onSendHandler = onSendHandler;
  }

  async _sendRequest_(req) {
    if (this.onSendHandler) {
      this.onSendHandler(req);
    }

    try {
      let res = await req;
      return res.type === 'text/plain' ? res.text : res.body || res.text;
    } catch (error) {
      if (this.onErrorHandler) {
        await this.onErrorHandler(error);
      }

      if (error.response) {
        let {
          status,
          body,
          text
        } = error.response;
        let message = body && body.error || error.response.error && error.response.error.message || text;
        error.message = message;
        error.status = status;
      }

      throw error;
    }
  }

  async do_(method, path, query, body) {
    method = method.toLowerCase();
    let httpMethod = AllowedMethods[method];

    if (!httpMethod) {
      throw new Error('Invalid method: ' + method);
    }

    if (path[0] === '/') {
      path = path.substr(1);
    }

    let req = this.agent[httpMethod](this.endpoint + path);

    if (query) {
      req.query(query);
    }

    if (method === 'download') {
      req.responseType('blob');
    } else if (method === 'upload') {
      req.attach("file", body);
    } else if (body) {
      req.send(body);
    }

    return this._sendRequest_(req);
  }

  async getOne_(resource, id, query) {
    return this.do_('get', encodeURIComponent(resource) + '/' + encodeURIComponent(id), query);
  }

  async getList_(resource, query) {
    return this.do_('get', encodeURIComponent(resource), query);
  }

  async create_(resource, data) {
    return this.do_('post', encodeURIComponent(resource), null, data);
  }

  async updateAny_(resource, where, data) {
    return this.do_('put', encodeURIComponent(resource), where, data);
  }

  async updateOne_(resource, id, data) {
    return this.do_('put', encodeURIComponent(resource) + '/' + encodeURIComponent(id), null, data);
  }

  async removeOne_(resource, id) {
    return this.do_('del', encodeURIComponent(resource) + '/' + encodeURIComponent(id));
  }

  async removeAny_(resource, where) {
    return this.do_('del', encodeURIComponent(resource), where);
  }

  async rpcGet_(resource, method, query) {
    return this.do_('get', '_rpc/' + encodeURIComponent(resource) + '/' + encodeURIComponent(method), query);
  }

  async rpcDownload_(resource, method, query) {
    return this.do_('download', '_rpc/' + encodeURIComponent(resource) + '/' + encodeURIComponent(method), query);
  }

  async rpcPost_(resource, method, query, body) {
    return this.do_('post', '_rpc/' + encodeURIComponent(resource) + '/' + encodeURIComponent(method), query, body);
  }

  async rpcUpload_(resource, method, query, file) {
    return this.do_('upload', '_rpc/' + encodeURIComponent(resource) + '/' + encodeURIComponent(method), query, file);
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.map(settings, (endpoint, name) => {
      let client = new RestClient(endpoint);
      app.registerService(`restClient.${name}`, client);
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9yZXN0Q2xpZW50LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiRmVhdHVyZSIsInRyeVJlcXVpcmUiLCJBbGxvd2VkTWV0aG9kcyIsIlJlc3RDbGllbnQiLCJjb25zdHJ1Y3RvciIsImVuZHBvaW50Iiwib25TZW5kSGFuZGxlciIsImFnZW50IiwiZW5kc1dpdGgiLCJfc2VuZFJlcXVlc3RfIiwicmVxIiwicmVzIiwidHlwZSIsInRleHQiLCJib2R5IiwiZXJyb3IiLCJvbkVycm9ySGFuZGxlciIsInJlc3BvbnNlIiwic3RhdHVzIiwibWVzc2FnZSIsImRvXyIsIm1ldGhvZCIsInBhdGgiLCJxdWVyeSIsInRvTG93ZXJDYXNlIiwiaHR0cE1ldGhvZCIsIkVycm9yIiwic3Vic3RyIiwicmVzcG9uc2VUeXBlIiwiYXR0YWNoIiwic2VuZCIsImdldE9uZV8iLCJyZXNvdXJjZSIsImlkIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwiZ2V0TGlzdF8iLCJjcmVhdGVfIiwiZGF0YSIsInVwZGF0ZUFueV8iLCJ3aGVyZSIsInVwZGF0ZU9uZV8iLCJyZW1vdmVPbmVfIiwicmVtb3ZlQW55XyIsInJwY0dldF8iLCJycGNEb3dubG9hZF8iLCJycGNQb3N0XyIsInJwY1VwbG9hZF8iLCJmaWxlIiwibW9kdWxlIiwiZXhwb3J0cyIsIlNFUlZJQ0UiLCJsb2FkXyIsImFwcCIsInNldHRpbmdzIiwibWFwIiwibmFtZSIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBaUJGLE9BQU8sQ0FBQyxrQkFBRCxDQUE5Qjs7QUFFQSxNQUFNRyxjQUFjLEdBQUc7QUFDbkIsU0FBTyxLQURZ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O0FBQ0g7O0FBRUQsUUFBTWdDLFVBQU4sQ0FBaUJkLFFBQWpCLEVBQTJCWCxNQUEzQixFQUFtQ0UsS0FBbkMsRUFBMEN3QixJQUExQyxFQUFnRDtBQUM1QyxXQUFPLEtBQUszQixHQUFMLENBQVMsUUFBVCxFQUFtQixVQUFVYyxrQkFBa0IsQ0FBQ0YsUUFBRCxDQUE1QixHQUF5QyxHQUF6QyxHQUErQ0Usa0JBQWtCLENBQUNiLE1BQUQsQ0FBcEYsRUFBOEZFLEtBQTlGLEVBQXFHd0IsSUFBckcsQ0FBUDtBQUNIOztBQXJHWTs7QUF3R2pCQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFNYnJDLEVBQUFBLElBQUksRUFBRVosT0FBTyxDQUFDa0QsT0FORDtBQWNiQyxFQUFBQSxLQUFLLEVBQUUsZ0JBQWdCQyxHQUFoQixFQUFxQkMsUUFBckIsRUFBK0I7QUFDbEN2RCxJQUFBQSxDQUFDLENBQUN3RCxHQUFGLENBQU1ELFFBQU4sRUFBZ0IsQ0FBQ2hELFFBQUQsRUFBV2tELElBQVgsS0FBb0I7QUFDaEMsVUFBSUMsTUFBTSxHQUFHLElBQUlyRCxVQUFKLENBQWVFLFFBQWYsQ0FBYjtBQUNBK0MsTUFBQUEsR0FBRyxDQUFDSyxlQUFKLENBQXFCLGNBQWFGLElBQUssRUFBdkMsRUFBMENDLE1BQTFDO0FBQ0gsS0FIRDtBQUlIO0FBbkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5cbmNvbnN0IEFsbG93ZWRNZXRob2RzID0ge1xuICAgICdnZXQnOiAnZ2V0JyxcbiAgICAncG9zdCc6ICdwb3N0JyxcbiAgICAncHV0JzogJ3B1dCcsXG4gICAgJ2RlbCc6ICdkZWwnLFxuICAgICdkZWxldGUnOiAnZGVsJyxcbiAgICAndXBsb2FkJzogJ3Bvc3QnLFxuICAgICdkb3dubG9hZCc6ICdnZXQnXG59O1xuXG5jbGFzcyBSZXN0Q2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihlbmRwb2ludCwgb25TZW5kSGFuZGxlcikge1xuICAgICAgICB0aGlzLmFnZW50ID0gdHJ5UmVxdWlyZSgnc3VwZXJhZ2VudCcpO1xuICAgICAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnQuZW5kc1dpdGgoJy8nKSA/IGVuZHBvaW50IDogZW5kcG9pbnQgKyAnLyc7XG4gICAgICAgIHRoaXMub25TZW5kSGFuZGxlciA9IG9uU2VuZEhhbmRsZXI7XG4gICAgfVxuXG4gICAgYXN5bmMgX3NlbmRSZXF1ZXN0XyhyZXEpIHtcbiAgICAgICAgaWYgKHRoaXMub25TZW5kSGFuZGxlcikge1xuICAgICAgICAgICAgdGhpcy5vblNlbmRIYW5kbGVyKHJlcSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHJlcTtcbiAgICAgICAgICAgIHJldHVybiByZXMudHlwZSA9PT0gJ3RleHQvcGxhaW4nID8gcmVzLnRleHQgOiAocmVzLmJvZHkgfHwgcmVzLnRleHQpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKHRoaXMub25FcnJvckhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLm9uRXJyb3JIYW5kbGVyKGVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgbGV0IHsgc3RhdHVzLCBib2R5LCB0ZXh0IH0gPSBlcnJvci5yZXNwb25zZTtcblxuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID0gKGJvZHkgJiYgYm9keS5lcnJvcikgfHwgKGVycm9yLnJlc3BvbnNlLmVycm9yICYmIGVycm9yLnJlc3BvbnNlLmVycm9yLm1lc3NhZ2UpIHx8IHRleHQ7XG4gICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSA9IG1lc3NhZ2U7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGVycm9yLnN0YXR1cyA9IHN0YXR1cztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBkb18obWV0aG9kLCBwYXRoLCBxdWVyeSwgYm9keSkge1xuICAgICAgICBtZXRob2QgPSBtZXRob2QudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgbGV0IGh0dHBNZXRob2QgPSBBbGxvd2VkTWV0aG9kc1ttZXRob2RdO1xuICAgICAgICBpZiAoIWh0dHBNZXRob2QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBtZXRob2Q6ICcgKyBtZXRob2QpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhdGhbMF0gPT09ICcvJykge1xuICAgICAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlcSA9IHRoaXMuYWdlbnRbaHR0cE1ldGhvZF0odGhpcy5lbmRwb2ludCArIHBhdGgpO1xuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIHJlcS5xdWVyeShxdWVyeSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWV0aG9kID09PSAnZG93bmxvYWQnKSB7XG4gICAgICAgICAgICByZXEucmVzcG9uc2VUeXBlKCdibG9iJyk7XG4gICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAndXBsb2FkJykge1xuICAgICAgICAgICAgcmVxLmF0dGFjaChcImZpbGVcIiwgYm9keSk7XG4gICAgICAgIH0gZWxzZSBpZiAoYm9keSkge1xuICAgICAgICAgICAgcmVxLnNlbmQoYm9keSk7ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fc2VuZFJlcXVlc3RfKHJlcSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0T25lXyhyZXNvdXJjZSwgaWQsIHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvXygnZ2V0JywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSArICcvJyArIGVuY29kZVVSSUNvbXBvbmVudChpZCksIHF1ZXJ5KTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRMaXN0XyhyZXNvdXJjZSwgcXVlcnkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9fKCdnZXQnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpLCBxdWVyeSk7XG4gICAgfVxuXG4gICAgYXN5bmMgY3JlYXRlXyhyZXNvdXJjZSwgZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb18oJ3Bvc3QnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpLCBudWxsLCBkYXRhKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVBbnlfKHJlc291cmNlLCB3aGVyZSwgZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb18oJ3B1dCcsIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSksIHdoZXJlLCBkYXRhKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVPbmVfKHJlc291cmNlLCBpZCwgZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb18oJ3B1dCcsIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSkgKyAnLycgKyBlbmNvZGVVUklDb21wb25lbnQoaWQpLCBudWxsLCBkYXRhKTtcbiAgICB9XG5cbiAgICBhc3luYyByZW1vdmVPbmVfKHJlc291cmNlLCBpZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb18oJ2RlbCcsIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSkgKyAnLycgKyBlbmNvZGVVUklDb21wb25lbnQoaWQpKTtcbiAgICB9XG5cbiAgICBhc3luYyByZW1vdmVBbnlfKHJlc291cmNlLCB3aGVyZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb18oJ2RlbCcsIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSksIHdoZXJlKTtcbiAgICB9XG5cbiAgICBhc3luYyBycGNHZXRfKHJlc291cmNlLCBtZXRob2QsIHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvXygnZ2V0JywgJ19ycGMvJyArIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSkgKyAnLycgKyBlbmNvZGVVUklDb21wb25lbnQobWV0aG9kKSwgcXVlcnkpO1xuICAgIH1cblxuICAgIGFzeW5jIHJwY0Rvd25sb2FkXyhyZXNvdXJjZSwgbWV0aG9kLCBxdWVyeSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb18oJ2Rvd25sb2FkJywgJ19ycGMvJyArIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSkgKyAnLycgKyBlbmNvZGVVUklDb21wb25lbnQobWV0aG9kKSwgcXVlcnkpO1xuICAgIH1cblxuICAgIGFzeW5jIHJwY1Bvc3RfKHJlc291cmNlLCBtZXRob2QsIHF1ZXJ5LCBib2R5KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvXygncG9zdCcsICdfcnBjLycgKyBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpICsgJy8nICsgZW5jb2RlVVJJQ29tcG9uZW50KG1ldGhvZCksIHF1ZXJ5LCBib2R5KTtcbiAgICB9XG5cbiAgICBhc3luYyBycGNVcGxvYWRfKHJlc291cmNlLCBtZXRob2QsIHF1ZXJ5LCBmaWxlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvXygndXBsb2FkJywgJ19ycGMvJyArIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSkgKyAnLycgKyBlbmNvZGVVUklDb21wb25lbnQobWV0aG9kKSwgcXVlcnksIGZpbGUpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5tYXAoc2V0dGluZ3MsIChlbmRwb2ludCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBSZXN0Q2xpZW50KGVuZHBvaW50KTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYHJlc3RDbGllbnQuJHtuYW1lfWAsIGNsaWVudCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxufTsiXX0=